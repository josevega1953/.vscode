/*! For license information please see 823.extension.js.LICENSE.txt */
exports.id=823,exports.ids=[823],exports.modules={1977(e,t,n){const r=n(99589);e.exports=r.satisfies(process.version,">=15.7.0")},3527(e){"use strict";function t(e){return(e/8|0)+(e%8==0?0:1)}var n={ES256:t(256),ES384:t(384),ES512:t(521)};e.exports=function(e){var t=n[e];if(t)return t;throw new Error('Unknown algorithm "'+e+'"')}},13387(e,t,n){var r=n(92861).Buffer,i=n(18948),o=n(58789),s=n(2203),a=n(82851),c=n(39023);function l(e,t){return r.from(e,t).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function u(e){var t=e.header,n=e.payload,r=e.secret||e.privateKey,i=e.encoding,s=o(t.alg),u=function(e,t,n){n=n||"utf8";var r=l(a(e),"binary"),i=l(a(t),n);return c.format("%s.%s",r,i)}(t,n,i),h=s.sign(u,r);return c.format("%s.%s",u,h)}function h(e){var t=e.secret;if(t=null==(t=null==t?e.privateKey:t)?e.key:t,!0===/^hs/i.test(e.header.alg)&&null==t)throw new TypeError("secret must be a string or buffer or a KeyObject");var n=new i(t);this.readable=!0,this.header=e.header,this.encoding=e.encoding,this.secret=this.privateKey=this.key=n,this.payload=new i(e.payload),this.secret.once("close",function(){!this.payload.writable&&this.readable&&this.sign()}.bind(this)),this.payload.once("close",function(){!this.secret.writable&&this.readable&&this.sign()}.bind(this))}c.inherits(h,s),h.prototype.sign=function(){try{var e=u({header:this.header,payload:this.payload.buffer,secret:this.secret.buffer,encoding:this.encoding});return this.emit("done",e),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},h.sign=u,e.exports=h},13726(e,t,n){var r=n(81741),i=function(e,t){r.call(this,e),this.name="NotBeforeError",this.date=t};(i.prototype=Object.create(r.prototype)).constructor=i,e.exports=i},18948(e,t,n){var r=n(92861).Buffer,i=n(2203);function o(e){if(this.buffer=null,this.writable=!0,this.readable=!0,!e)return this.buffer=r.alloc(0),this;if("function"==typeof e.pipe)return this.buffer=r.alloc(0),e.pipe(this),this;if(e.length||"object"==typeof e)return this.buffer=e,this.writable=!1,process.nextTick(function(){this.emit("end",e),this.readable=!1,this.emit("close")}.bind(this)),this;throw new TypeError("Unexpected data type ("+typeof e+")")}n(39023).inherits(o,i),o.prototype.write=function(e){this.buffer=r.concat([this.buffer,r.from(e)]),this.emit("data",e)},o.prototype.end=function(e){e&&this.write(e),this.emit("end",e),this.emit("close"),this.writable=!1,this.readable=!1},e.exports=o},18980(e,t,n){var r=n(81741),i=function(e,t){r.call(this,e),this.name="TokenExpiredError",this.expiredAt=t};(i.prototype=Object.create(r.prototype)).constructor=i,e.exports=i},22010(e,t,n){"use strict";var r=n(92861).Buffer,i=n(3527);function o(e){if(r.isBuffer(e))return e;if("string"==typeof e)return r.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function s(e,t,n){for(var r=0;t+r<n&&0===e[t+r];)++r;return e[t+r]>=128&&--r,r}e.exports={derToJose:function(e,t){e=o(e);var n=i(t),s=n+1,a=e.length,c=0;if(48!==e[c++])throw new Error('Could not find expected "seq"');var l=e[c++];if(129===l&&(l=e[c++]),a-c<l)throw new Error('"seq" specified length of "'+l+'", only "'+(a-c)+'" remaining');if(2!==e[c++])throw new Error('Could not find expected "int" for "r"');var u=e[c++];if(a-c-2<u)throw new Error('"r" specified length of "'+u+'", only "'+(a-c-2)+'" available');if(s<u)throw new Error('"r" specified length of "'+u+'", max of "'+s+'" is acceptable');var h=c;if(c+=u,2!==e[c++])throw new Error('Could not find expected "int" for "s"');var d=e[c++];if(a-c!==d)throw new Error('"s" specified length of "'+d+'", expected "'+(a-c)+'"');if(s<d)throw new Error('"s" specified length of "'+d+'", max of "'+s+'" is acceptable');var p=c;if((c+=d)!==a)throw new Error('Expected to consume entire buffer, but "'+(a-c)+'" bytes remain');var g=n-u,f=n-d,m=r.allocUnsafe(g+u+f+d);for(c=0;c<g;++c)m[c]=0;e.copy(m,c,h+Math.max(-g,0),h+u);for(var y=c=n;c<y+f;++c)m[c]=0;return e.copy(m,c,p+Math.max(-f,0),p+d),(m=m.toString("base64")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},joseToDer:function(e,t){e=o(e);var n=i(t),a=e.length;if(a!==2*n)throw new TypeError('"'+t+'" signatures must be "'+2*n+'" bytes, saw "'+a+'"');var c=s(e,0,n),l=s(e,n,e.length),u=n-c,h=n-l,d=2+u+1+1+h,p=d<128,g=r.allocUnsafe((p?2:3)+d),f=0;return g[f++]=48,p?g[f++]=d:(g[f++]=129,g[f++]=255&d),g[f++]=2,g[f++]=u,c<0?(g[f++]=0,f+=e.copy(g,f,0,n)):f+=e.copy(g,f,c,n),g[f++]=2,g[f++]=h,l<0?(g[f++]=0,e.copy(g,f,n)):e.copy(g,f,n+l),g}}},25747(e,t,n){var r=n(13387),i=n(57599);t.ALGORITHMS=["HS256","HS384","HS512","RS256","RS384","RS512","PS256","PS384","PS512","ES256","ES384","ES512"],t.sign=r.sign,t.verify=i.verify,t.decode=i.decode,t.isValid=i.isValid,t.createSign=function(e){return new r(e)},t.createVerify=function(e){return new i(e)}},34623(e,t,n){const r=n(99589);e.exports=r.satisfies(process.version,">=16.9.0")},37260(e,t,n){var r=n(25747);e.exports=function(e,t){t=t||{};var n=r.decode(e,t);if(!n)return null;var i=n.payload;if("string"==typeof i)try{var o=JSON.parse(i);null!==o&&"object"==typeof o&&(i=o)}catch(e){}return!0===t.complete?{header:n.header,payload:i,signature:n.signature}:i}},37651(e,t,n){const r=n(40855),i=n(74977),o=n(47019),s=n(25747),a=n(46111),c=n(87914),l=n(58928),u=n(73639),h=n(79001),d=n(45931),p=n(67083),{KeyObject:g,createSecretKey:f,createPrivateKey:m}=n(76982),y=["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"];i&&y.splice(3,0,"PS256","PS384","PS512");const C={expiresIn:{isValid:function(e){return l(e)||d(e)&&e},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return l(e)||d(e)&&e},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return d(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:a.bind(null,y),message:'"algorithm" must be a valid string enum value'},header:{isValid:h,message:'"header" must be an object'},encoding:{isValid:d,message:'"encoding" must be a string'},issuer:{isValid:d,message:'"issuer" must be a string'},subject:{isValid:d,message:'"subject" must be a string'},jwtid:{isValid:d,message:'"jwtid" must be a string'},noTimestamp:{isValid:c,message:'"noTimestamp" must be a boolean'},keyid:{isValid:d,message:'"keyid" must be a string'},mutatePayload:{isValid:c,message:'"mutatePayload" must be a boolean'},allowInsecureKeySizes:{isValid:c,message:'"allowInsecureKeySizes" must be a boolean'},allowInvalidAsymmetricKeyTypes:{isValid:c,message:'"allowInvalidAsymmetricKeyTypes" must be a boolean'}},T={iat:{isValid:u,message:'"iat" should be a number of seconds'},exp:{isValid:u,message:'"exp" should be a number of seconds'},nbf:{isValid:u,message:'"nbf" should be a number of seconds'}};function A(e,t,n,r){if(!h(n))throw new Error('Expected "'+r+'" to be a plain object.');Object.keys(n).forEach(function(i){const o=e[i];if(o){if(!o.isValid(n[i]))throw new Error(o.message)}else if(!t)throw new Error('"'+i+'" is not allowed in "'+r+'"')})}const w={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},k=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];e.exports=function(e,t,n,i){"function"==typeof n?(i=n,n={}):n=n||{};const a="object"==typeof e&&!Buffer.isBuffer(e),c=Object.assign({alg:n.algorithm||"HS256",typ:a?"JWT":void 0,kid:n.keyid},n.header);function l(e){if(i)return i(e);throw e}if(!t&&"none"!==n.algorithm)return l(new Error("secretOrPrivateKey must have a value"));if(null!=t&&!(t instanceof g))try{t=m(t)}catch(e){try{t=f("string"==typeof t?Buffer.from(t):t)}catch(e){return l(new Error("secretOrPrivateKey is not valid key material"))}}if(c.alg.startsWith("HS")&&"secret"!==t.type)return l(new Error(`secretOrPrivateKey must be a symmetric key when using ${c.alg}`));if(/^(?:RS|PS|ES)/.test(c.alg)){if("private"!==t.type)return l(new Error(`secretOrPrivateKey must be an asymmetric key when using ${c.alg}`));if(!n.allowInsecureKeySizes&&!c.alg.startsWith("ES")&&void 0!==t.asymmetricKeyDetails&&t.asymmetricKeyDetails.modulusLength<2048)return l(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`))}if(void 0===e)return l(new Error("payload is required"));if(a){try{!function(e){A(T,!0,e,"payload")}(e)}catch(e){return l(e)}n.mutatePayload||(e=Object.assign({},e))}else{const t=k.filter(function(e){return void 0!==n[e]});if(t.length>0)return l(new Error("invalid "+t.join(",")+" option for "+typeof e+" payload"))}if(void 0!==e.exp&&void 0!==n.expiresIn)return l(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==e.nbf&&void 0!==n.notBefore)return l(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{!function(e){A(C,!1,e,"options")}(n)}catch(e){return l(e)}if(!n.allowInvalidAsymmetricKeyTypes)try{o(c.alg,t)}catch(e){return l(e)}const u=e.iat||Math.floor(Date.now()/1e3);if(n.noTimestamp?delete e.iat:a&&(e.iat=u),void 0!==n.notBefore){try{e.nbf=r(n.notBefore,u)}catch(e){return l(e)}if(void 0===e.nbf)return l(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}if(void 0!==n.expiresIn&&"object"==typeof e){try{e.exp=r(n.expiresIn,u)}catch(e){return l(e)}if(void 0===e.exp)return l(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}Object.keys(w).forEach(function(t){const r=w[t];if(void 0!==n[t]){if(void 0!==e[r])return l(new Error('Bad "options.'+t+'" option. The payload already has an "'+r+'" property.'));e[r]=n[t]}});const h=n.encoding||"utf8";if("function"!=typeof i){let r=s.sign({header:c,payload:e,secret:t,encoding:h});if(!n.allowInsecureKeySizes&&/^(?:RS|PS)/.test(c.alg)&&r.length<256)throw new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`);return r}i=i&&p(i),s.createSign({header:c,privateKey:t,payload:e,encoding:h}).once("error",i).once("done",function(e){if(!n.allowInsecureKeySizes&&/^(?:RS|PS)/.test(c.alg)&&e.length<256)return i(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`));i(null,e)})}},40855(e,t,n){var r=n(6585);e.exports=function(e,t){var n=t||Math.floor(Date.now()/1e3);if("string"==typeof e){var i=r(e);if(void 0===i)return;return Math.floor(n+i/1e3)}return"number"==typeof e?n+e:void 0}},41045(e,t,n){"use strict";var r=n(20181).Buffer,i=n(20181).SlowBuffer;function o(e,t){if(!r.isBuffer(e)||!r.isBuffer(t))return!1;if(e.length!==t.length)return!1;for(var n=0,i=0;i<e.length;i++)n|=e[i]^t[i];return 0===n}e.exports=o,o.install=function(){r.prototype.equal=i.prototype.equal=function(e){return o(this,e)}};var s=r.prototype.equal,a=i.prototype.equal;o.restore=function(){r.prototype.equal=s,i.prototype.equal=a}},44040(e,t,n){e.exports={decode:n(37260),verify:n(91691),sign:n(37651),JsonWebTokenError:n(81741),NotBeforeError:n(13726),TokenExpiredError:n(18980)}},45931(e){var t=Object.prototype.toString,n=Array.isArray;e.exports=function(e){return"string"==typeof e||!n(e)&&function(e){return!!e&&"object"==typeof e}(e)&&"[object String]"==t.call(e)}},46111(e){var t=1/0,n=9007199254740991,r=/^\s+|\s+$/g,i=/^[-+]0x[0-9a-f]+$/i,o=/^0b[01]+$/i,s=/^0o[0-7]+$/i,a=/^(?:0|[1-9]\d*)$/,c=parseInt;function l(e){return e!=e}var u,h,d=Object.prototype,p=d.hasOwnProperty,g=d.toString,f=d.propertyIsEnumerable,m=(u=Object.keys,h=Object,function(e){return u(h(e))}),y=Math.max;function C(e,t){return!!(t=null==t?n:t)&&("number"==typeof e||a.test(e))&&e>-1&&e%1==0&&e<t}var T=Array.isArray;function A(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=n}(e.length)&&!function(e){var t=w(e)?g.call(e):"";return"[object Function]"==t||"[object GeneratorFunction]"==t}(e)}function w(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function k(e){return!!e&&"object"==typeof e}e.exports=function(e,n,a,u){var h;e=A(e)?e:(h=e)?function(e,t){return function(e,t){for(var n=-1,r=e?e.length:0,i=Array(r);++n<r;)i[n]=t(e[n]);return i}(t,function(t){return e[t]})}(h,function(e){return A(e)?function(e,t){var n=T(e)||function(e){return function(e){return k(e)&&A(e)}(e)&&p.call(e,"callee")&&(!f.call(e,"callee")||"[object Arguments]"==g.call(e))}(e)?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],r=n.length,i=!!r;for(var o in e)!t&&!p.call(e,o)||i&&("length"==o||C(o,r))||n.push(o);return n}(e):function(e){if(n=(t=e)&&t.constructor,t!==("function"==typeof n&&n.prototype||d))return m(e);var t,n,r=[];for(var i in Object(e))p.call(e,i)&&"constructor"!=i&&r.push(i);return r}(e)}(h)):[],a=a&&!u?function(e){var n=function(e){return e?(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||k(e)&&"[object Symbol]"==g.call(e)}(e))return NaN;if(w(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=w(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(r,"");var n=o.test(e);return n||s.test(e)?c(e.slice(2),n?2:8):i.test(e)?NaN:+e}(e))===t||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),a=n%1;return n==n?a?n-a:n:0}(a):0;var I=e.length;return a<0&&(a=y(I+a,0)),function(e){return"string"==typeof e||!T(e)&&k(e)&&"[object String]"==g.call(e)}(e)?a<=I&&e.indexOf(n,a)>-1:!!I&&function(e,t,n){if(t!=t)return function(e,t,n){for(var r=e.length,i=n+-1;++i<r;)if(t(e[i],i,e))return i;return-1}(e,l,n);for(var r=n-1,i=e.length;++r<i;)if(e[r]===t)return r;return-1}(e,n,a)>-1}},47019(e,t,n){const r=n(1977),i=n(34623),o={ec:["ES256","ES384","ES512"],rsa:["RS256","PS256","RS384","PS384","RS512","PS512"],"rsa-pss":["PS256","PS384","PS512"]},s={ES256:"prime256v1",ES384:"secp384r1",ES512:"secp521r1"};e.exports=function(e,t){if(!e||!t)return;const n=t.asymmetricKeyType;if(!n)return;const a=o[n];if(!a)throw new Error(`Unknown key type "${n}".`);if(!a.includes(e))throw new Error(`"alg" parameter for "${n}" key type must be one of: ${a.join(", ")}.`);if(r)switch(n){case"ec":const n=t.asymmetricKeyDetails.namedCurve,r=s[e];if(n!==r)throw new Error(`"alg" parameter "${e}" requires curve "${r}".`);break;case"rsa-pss":if(i){const n=parseInt(e.slice(-3),10),{hashAlgorithm:r,mgf1HashAlgorithm:i,saltLength:o}=t.asymmetricKeyDetails;if(r!==`sha${n}`||i!==r)throw new Error(`Invalid key for this operation, its RSA-PSS parameters do not meet the requirements of "alg" ${e}.`);if(void 0!==o&&o>n>>3)throw new Error(`Invalid key for this operation, its RSA-PSS parameter saltLength does not meet the requirements of "alg" ${e}.`)}}}},57599(e,t,n){var r=n(92861).Buffer,i=n(18948),o=n(58789),s=n(2203),a=n(82851),c=n(39023),l=/^[a-zA-Z0-9\-_]+?\.[a-zA-Z0-9\-_]+?\.([a-zA-Z0-9\-_]+)?$/;function u(e){var t=e.split(".",1)[0];return function(e){if(function(e){return"[object Object]"===Object.prototype.toString.call(e)}(e))return e;try{return JSON.parse(e)}catch(e){return}}(r.from(t,"base64").toString("binary"))}function h(e){return e.split(".")[2]}function d(e){return l.test(e)&&!!u(e)}function p(e,t,n){if(!t){var r=new Error("Missing algorithm parameter for jws.verify");throw r.code="MISSING_ALGORITHM",r}var i=h(e=a(e)),s=function(e){return e.split(".",2).join(".")}(e);return o(t).verify(s,i,n)}function g(e,t){if(t=t||{},!d(e=a(e)))return null;var n=u(e);if(!n)return null;var i=function(e,t){t=t||"utf8";var n=e.split(".")[1];return r.from(n,"base64").toString(t)}(e);return("JWT"===n.typ||t.json)&&(i=JSON.parse(i,t.encoding)),{header:n,payload:i,signature:h(e)}}function f(e){var t=(e=e||{}).secret;if(t=null==(t=null==t?e.publicKey:t)?e.key:t,!0===/^hs/i.test(e.algorithm)&&null==t)throw new TypeError("secret must be a string or buffer or a KeyObject");var n=new i(t);this.readable=!0,this.algorithm=e.algorithm,this.encoding=e.encoding,this.secret=this.publicKey=this.key=n,this.signature=new i(e.signature),this.secret.once("close",function(){!this.signature.writable&&this.readable&&this.verify()}.bind(this)),this.signature.once("close",function(){!this.secret.writable&&this.readable&&this.verify()}.bind(this))}c.inherits(f,s),f.prototype.verify=function(){try{var e=p(this.signature.buffer,this.algorithm,this.key.buffer),t=g(this.signature.buffer,this.encoding);return this.emit("done",e,t),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},f.decode=g,f.isValid=d,f.verify=p,e.exports=f},58789(e,t,n){var r,i=n(92861).Buffer,o=n(76982),s=n(22010),a=n(39023),c="secret must be a string or buffer",l="key must be a string or a buffer",u="function"==typeof o.createPublicKey;function h(e){if(!i.isBuffer(e)&&"string"!=typeof e){if(!u)throw f(l);if("object"!=typeof e)throw f(l);if("string"!=typeof e.type)throw f(l);if("string"!=typeof e.asymmetricKeyType)throw f(l);if("function"!=typeof e.export)throw f(l)}}function d(e){if(!i.isBuffer(e)&&"string"!=typeof e&&"object"!=typeof e)throw f("key must be a string, a buffer or an object")}function p(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function g(e){var t=4-(e=e.toString()).length%4;if(4!==t)for(var n=0;n<t;++n)e+="=";return e.replace(/\-/g,"+").replace(/_/g,"/")}function f(e){var t=[].slice.call(arguments,1),n=a.format.bind(a,e).apply(null,t);return new TypeError(n)}function m(e){var t;return t=e,i.isBuffer(t)||"string"==typeof t||(e=JSON.stringify(e)),e}function y(e){return function(t,n){!function(e){if(!i.isBuffer(e)){if("string"==typeof e)return e;if(!u)throw f(c);if("object"!=typeof e)throw f(c);if("secret"!==e.type)throw f(c);if("function"!=typeof e.export)throw f(c)}}(n),t=m(t);var r=o.createHmac("sha"+e,n);return p((r.update(t),r.digest("base64")))}}u&&(l+=" or a KeyObject",c+="or a KeyObject");var C="timingSafeEqual"in o?function(e,t){return e.byteLength===t.byteLength&&o.timingSafeEqual(e,t)}:function(e,t){return r||(r=n(41045)),r(e,t)};function T(e){return function(t,n,r){var o=y(e)(t,r);return C(i.from(n),i.from(o))}}function A(e){return function(t,n){d(n),t=m(t);var r=o.createSign("RSA-SHA"+e);return p((r.update(t),r.sign(n,"base64")))}}function w(e){return function(t,n,r){h(r),t=m(t),n=g(n);var i=o.createVerify("RSA-SHA"+e);return i.update(t),i.verify(r,n,"base64")}}function k(e){return function(t,n){d(n),t=m(t);var r=o.createSign("RSA-SHA"+e);return p((r.update(t),r.sign({key:n,padding:o.constants.RSA_PKCS1_PSS_PADDING,saltLength:o.constants.RSA_PSS_SALTLEN_DIGEST},"base64")))}}function I(e){return function(t,n,r){h(r),t=m(t),n=g(n);var i=o.createVerify("RSA-SHA"+e);return i.update(t),i.verify({key:r,padding:o.constants.RSA_PKCS1_PSS_PADDING,saltLength:o.constants.RSA_PSS_SALTLEN_DIGEST},n,"base64")}}function v(e){var t=A(e);return function(){var n=t.apply(null,arguments);return s.derToJose(n,"ES"+e)}}function b(e){var t=w(e);return function(n,r,i){return r=s.joseToDer(r,"ES"+e).toString("base64"),t(n,r,i)}}function S(){return function(){return""}}function _(){return function(e,t){return""===t}}e.exports=function(e){var t={hs:y,rs:A,ps:k,es:v,none:S},n={hs:T,rs:w,ps:I,es:b,none:_},r=e.match(/^(RS|PS|ES|HS)(256|384|512)$|^(none)$/i);if(!r)throw f('"%s" is not a valid algorithm.\n  Supported algorithms are:\n  "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "PS256", "PS384", "PS512", "ES256", "ES384", "ES512" and "none".',e);var i=(r[1]||r[3]).toLowerCase(),o=r[2];return{sign:t[i](o),verify:n[i](o)}}},58928(e){var t=1/0,n=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,i=/^0b[01]+$/i,o=/^0o[0-7]+$/i,s=parseInt,a=Object.prototype.toString;function c(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}e.exports=function(e){return"number"==typeof e&&e==function(e){var l=function(e){return e?(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==a.call(e)}(e))return NaN;if(c(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=c(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(n,"");var l=i.test(e);return l||o.test(e)?s(e.slice(2),l?2:8):r.test(e)?NaN:+e}(e))===t||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),u=l%1;return l==l?u?l-u:l:0}(e)}},60823(e,t,n){"use strict";n.d(t,{ClientAssertionCredential:()=>ss});const r="4.13.0",i="04b07795-8ddb-461a-bbee-02f9e1bf7b46";var o;!function(e){e.AzureChina="https://login.chinacloudapi.cn",e.AzureGermany="https://login.microsoftonline.de",e.AzureGovernment="https://login.microsoftonline.us",e.AzurePublicCloud="https://login.microsoftonline.com"}(o||(o={}));const s=o.AzurePublicCloud,a=["*"];const c={vsCode:{credentialName:"Visual Studio Code Credential",packageName:"@azure/identity-vscode",pluginVar:"vsCodePlugin",get brokerInfo(){}},native:{credentialName:"Broker for WAM",packageName:"@azure/identity-broker",pluginVar:"nativeBrokerPlugin",get brokerInfo(){}}},l=function(e){const t={cache:{},broker:{...e.brokerOptions,isEnabled:e.brokerOptions?.enabled??!1,enableMsaPassthrough:e.brokerOptions?.legacyEnableMsaPassthrough??!1}};if(e.tokenCachePersistenceOptions?.enabled)throw new Error(["Persistent token caching was requested, but no persistence provider was configured.","You must install the identity-cache-persistence plugin package (`npm install --save @azure/identity-cache-persistence`)","and enable it by importing `useIdentityPlugin` from `@azure/identity` and calling","`useIdentityPlugin(cachePersistencePlugin)` before using `tokenCachePersistenceOptions`."].join(" "));return e.brokerOptions?.enabled&&(t.broker.nativeBrokerPlugin=function(e){const{credentialName:t,packageName:n,pluginVar:r,brokerInfo:i}=c[e?"vsCode":"native"];if(void 0===i)throw new Error(((e,t,n)=>[`${e} was requested, but no plugin was configured or no authentication record was found.`,`You must install the ${t} plugin package (npm install --save ${t})`,"and enable it by importing `useIdentityPlugin` from `@azure/identity` and calling",`useIdentityPlugin(${n}) before using enableBroker.`].join(" "))(t,n,r));if(!1===i.broker.isBrokerAvailable)throw new Error(((e,t)=>[`${e} was requested, and the plugin is configured, but the broker is unavailable.`,`Ensure the ${e} plugin is properly installed and configured.`,"Check for missing native dependencies and ensure the package is properly installed.",`See the README for prerequisites on installing and using ${t}.`].join(" "))(t,n));return i.broker}(e.isVSCodeCredential||!1)),t};class u extends Error{constructor(e,t){super(e,t),this.name="CredentialUnavailableError"}}const h="AuthenticationError";class d extends Error{statusCode;errorResponse;constructor(e,t,n){let r={error:"unknown",errorDescription:"An unknown error occurred and no additional details are available."};if(function(e){return e&&"string"==typeof e.error&&"string"==typeof e.error_description}(t))r=p(t);else if("string"==typeof t)try{r=p(JSON.parse(t))}catch(n){r=400===e?{error:"invalid_request",errorDescription:`The service indicated that the request was invalid.\n\n${t}`}:{error:"unknown_error",errorDescription:`An unknown error has occurred. Response body:\n\n${t}`}}else r={error:"unknown_error",errorDescription:"An unknown error occurred and no additional details are available."};super(`${r.error} Status code: ${e}\nMore details:\n${r.errorDescription},`,n),this.statusCode=e,this.errorResponse=r,this.name=h}}function p(e){return{error:e.error,errorDescription:e.error_description,correlationId:e.correlation_id,errorCodes:e.error_codes,timestamp:e.timestamp,traceId:e.trace_id}}Error;class g extends Error{scopes;getTokenOptions;constructor(e){super(e.message,e.cause?{cause:e.cause}:void 0),this.scopes=e.scopes,this.getTokenOptions=e.getTokenOptions,this.name="AuthenticationRequiredError"}}var f=n(69325);const m=(0,f.KV)("identity");function y(e){return`SUCCESS. Scopes: ${Array.isArray(e)?e.join(", "):e}.`}function C(e,t){let n="ERROR.";return e?.length&&(n+=` Scopes: ${Array.isArray(e)?e.join(", "):e}.`),`${n} Error message: ${"string"==typeof t?t:t.message}.`}function T(e,t,n=m){const r=t?`${t.fullTitle} ${e}`:e;return{title:e,fullTitle:r,info:function(e){n.info(`${r} =>`,e)},warning:function(e){n.warning(`${r} =>`,e)},verbose:function(e){n.verbose(`${r} =>`,e)},error:function(e){n.error(`${r} =>`,e)}}}function A(e,t=m){const n=T(e,void 0,t);return{...n,parent:t,getToken:T("=> getToken()",n,t)}}const w=(0,n(11652).y)({namespace:"Microsoft.AAD",packageName:"@azure/identity",packageVersion:r});A("ChainedTokenCredential");const k={LIBRARY_NAME:"MSAL.JS",SKU:"msal.js.common",DEFAULT_AUTHORITY:"https://login.microsoftonline.com/common/",DEFAULT_AUTHORITY_HOST:"login.microsoftonline.com",DEFAULT_COMMON_TENANT:"common",ADFS:"adfs",DSTS:"dstsv2",AAD_INSTANCE_DISCOVERY_ENDPT:"https://login.microsoftonline.com/common/discovery/instance?api-version=1.1&authorization_endpoint=",CIAM_AUTH_URL:".ciamlogin.com",AAD_TENANT_DOMAIN_SUFFIX:".onmicrosoft.com",RESOURCE_DELIM:"|",NO_ACCOUNT:"NO_ACCOUNT",CLAIMS:"claims",CONSUMER_UTID:"9188040d-6c67-4c5b-b112-36a304b66dad",OPENID_SCOPE:"openid",PROFILE_SCOPE:"profile",OFFLINE_ACCESS_SCOPE:"offline_access",EMAIL_SCOPE:"email",CODE_GRANT_TYPE:"authorization_code",RT_GRANT_TYPE:"refresh_token",S256_CODE_CHALLENGE_METHOD:"S256",URL_FORM_CONTENT_TYPE:"application/x-www-form-urlencoded;charset=utf-8",AUTHORIZATION_PENDING:"authorization_pending",NOT_DEFINED:"not_defined",EMPTY_STRING:"",NOT_APPLICABLE:"N/A",NOT_AVAILABLE:"Not Available",FORWARD_SLASH:"/",IMDS_ENDPOINT:"http://169.254.169.254/metadata/instance/compute/location",IMDS_VERSION:"2020-06-01",IMDS_TIMEOUT:2e3,AZURE_REGION_AUTO_DISCOVER_FLAG:"TryAutoDetect",REGIONAL_AUTH_PUBLIC_CLOUD_SUFFIX:"login.microsoft.com",KNOWN_PUBLIC_CLOUDS:["login.microsoftonline.com","login.windows.net","login.microsoft.com","sts.windows.net"],SHR_NONCE_VALIDITY:240,INVALID_INSTANCE:"invalid_instance"},I=[k.OPENID_SCOPE,k.PROFILE_SCOPE,k.OFFLINE_ACCESS_SCOPE],v=[...I,k.EMAIL_SCOPE],b="Content-Type",S="Retry-After",_="X-AnchorMailbox",E="x-ms-request-id",O="x-ms-httpver",R={COMMON:"common",ORGANIZATIONS:"organizations",CONSUMERS:"consumers"},P="access_token",M="none",N="query",q="Generic",x={ID_TOKEN:"IdToken",ACCESS_TOKEN:"AccessToken",ACCESS_TOKEN_WITH_AUTH_SCHEME:"AccessToken_With_AuthScheme",REFRESH_TOKEN:"RefreshToken"},U="appmetadata",H="1",D="authority-metadata",L="config",B="cache",F="network",$="hardcoded_values",j={SCHEMA_VERSION:5,MAX_LAST_HEADER_BYTES:330,MAX_CACHED_ERRORS:50,CACHE_KEY:"server-telemetry",CATEGORY_SEPARATOR:"|",VALUE_SEPARATOR:",",OVERFLOW_TRUE:"1",OVERFLOW_FALSE:"0",UNKNOWN_ERROR:"unknown_error"},K={BEARER:"Bearer",POP:"pop",SSH:"ssh-cert"},z="throttling",G="0",V="2",Y="3",W="4",Q="base64",J="get",Z="post",X=200,ee=299,te=500,ne="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",re="msal.js.node",ie="urn:ietf:params:oauth:client-assertion-type:jwt-bearer",oe="x5c",se="aud",ae="exp",ce="iss",le="sub",ue="nbf",he="jti",de="unexpected_error",pe="post_request_failed",ge={[de]:"Unexpected error in authentication.",[pe]:"Post request failed from the network, could be a 4xx/5xx or a network unavailability. Please check the exact error code for details."};class fe extends Error{constructor(e,t,n){super(t?`${e}: ${t}`:e),Object.setPrototypeOf(this,fe.prototype),this.errorCode=e||k.EMPTY_STRING,this.errorMessage=t||k.EMPTY_STRING,this.subError=n||k.EMPTY_STRING,this.name="AuthError"}setCorrelationId(e){this.correlationId=e}}function me(e,t){return new fe(e,t?`${ge[e]} ${t}`:ge[e])}class ye{constructor(e,t){this.cacheOutcome=G,this.cacheManager=t,this.apiId=e.apiId,this.correlationId=e.correlationId,this.wrapperSKU=e.wrapperSKU||k.EMPTY_STRING,this.wrapperVer=e.wrapperVer||k.EMPTY_STRING,this.telemetryCacheKey=j.CACHE_KEY+"-"+e.clientId}generateCurrentRequestHeaderValue(){const e=`${this.apiId}${j.VALUE_SEPARATOR}${this.cacheOutcome}`,t=[this.wrapperSKU,this.wrapperVer],n=this.getNativeBrokerErrorCode();n?.length&&t.push(`broker_error=${n}`);const r=t.join(j.VALUE_SEPARATOR),i=[e,this.getRegionDiscoveryFields()].join(j.VALUE_SEPARATOR);return[j.SCHEMA_VERSION,i,r].join(j.CATEGORY_SEPARATOR)}generateLastRequestHeaderValue(){const e=this.getLastRequests(),t=ye.maxErrorsToSend(e),n=e.failedRequests.slice(0,2*t).join(j.VALUE_SEPARATOR),r=e.errors.slice(0,t).join(j.VALUE_SEPARATOR),i=e.errors.length,o=[i,t<i?j.OVERFLOW_TRUE:j.OVERFLOW_FALSE].join(j.VALUE_SEPARATOR);return[j.SCHEMA_VERSION,e.cacheHits,n,r,o].join(j.CATEGORY_SEPARATOR)}cacheFailedRequest(e){const t=this.getLastRequests();t.errors.length>=j.MAX_CACHED_ERRORS&&(t.failedRequests.shift(),t.failedRequests.shift(),t.errors.shift()),t.failedRequests.push(this.apiId,this.correlationId),e instanceof Error&&e&&e.toString()?e instanceof fe?e.subError?t.errors.push(e.subError):e.errorCode?t.errors.push(e.errorCode):t.errors.push(e.toString()):t.errors.push(e.toString()):t.errors.push(j.UNKNOWN_ERROR),this.cacheManager.setServerTelemetry(this.telemetryCacheKey,t,this.correlationId)}incrementCacheHits(){const e=this.getLastRequests();return e.cacheHits+=1,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,e,this.correlationId),e.cacheHits}getLastRequests(){return this.cacheManager.getServerTelemetry(this.telemetryCacheKey)||{failedRequests:[],errors:[],cacheHits:0}}clearTelemetryCache(){const e=this.getLastRequests(),t=ye.maxErrorsToSend(e);if(t===e.errors.length)this.cacheManager.removeItem(this.telemetryCacheKey,this.correlationId);else{const n={failedRequests:e.failedRequests.slice(2*t),errors:e.errors.slice(t),cacheHits:0};this.cacheManager.setServerTelemetry(this.telemetryCacheKey,n,this.correlationId)}}static maxErrorsToSend(e){let t,n=0,r=0;const i=e.errors.length;for(t=0;t<i;t++){const i=e.failedRequests[2*t]||k.EMPTY_STRING,o=e.failedRequests[2*t+1]||k.EMPTY_STRING,s=e.errors[t]||k.EMPTY_STRING;if(r+=i.toString().length+o.toString().length+s.length+3,!(r<j.MAX_LAST_HEADER_BYTES))break;n+=1}return n}getRegionDiscoveryFields(){const e=[];return e.push(this.regionUsed||k.EMPTY_STRING),e.push(this.regionSource||k.EMPTY_STRING),e.push(this.regionOutcome||k.EMPTY_STRING),e.join(",")}updateRegionDiscoveryMetadata(e){this.regionUsed=e.region_used,this.regionSource=e.region_source,this.regionOutcome=e.region_outcome}setCacheOutcome(e){this.cacheOutcome=e}setNativeBrokerErrorCode(e){const t=this.getLastRequests();t.nativeBrokerErrorCode=e,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,t,this.correlationId)}getNativeBrokerErrorCode(){return this.getLastRequests().nativeBrokerErrorCode}clearNativeBrokerErrorCode(){const e=this.getLastRequests();delete e.nativeBrokerErrorCode,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,e,this.correlationId)}static makeExtraSkuString(e){return function(e){const{skus:t,libraryName:n,libraryVersion:r,extensionName:i,extensionVersion:o}=e,s=new Map([[0,[n,r]],[2,[i,o]]]);let a=[];if(t?.length){if(a=t.split(","),a.length<4)return t}else a=Array.from({length:4},()=>"|");return s.forEach((e,t)=>{2===e.length&&e[0]?.length&&e[1]?.length&&function(e){const{skuArr:t,index:n,skuName:r,skuVersion:i}=e;n>=t.length||(t[n]=[r,i].join("|"))}({skuArr:a,index:t,skuName:e[0],skuVersion:e[1]})}),a.join(",")}(e)}}const Ce="client_id",Te="redirect_uri",Ae="token_type",we="req_cnf",ke="return_spa_code",Ie="x-client-xtra-sku",ve="brk_client_id",be="brk_redirect_uri",Se="instance_aware";class _e extends fe{constructor(e,t,n,r,i){super(e,t,n),this.name="ServerError",this.errorNo=r,this.status=i,Object.setPrototypeOf(this,_e.prototype)}}var Ee;!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose",e[e.Trace=4]="Trace"}(Ee||(Ee={}));class Oe{constructor(e,t,n){this.level=Ee.Info;const r=e||Oe.createDefaultLoggerOptions();this.localCallback=r.loggerCallback||(()=>{}),this.piiLoggingEnabled=r.piiLoggingEnabled||!1,this.level="number"==typeof r.logLevel?r.logLevel:Ee.Info,this.correlationId=r.correlationId||k.EMPTY_STRING,this.packageName=t||k.EMPTY_STRING,this.packageVersion=n||k.EMPTY_STRING}static createDefaultLoggerOptions(){return{loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:Ee.Info}}clone(e,t,n){return new Oe({loggerCallback:this.localCallback,piiLoggingEnabled:this.piiLoggingEnabled,logLevel:this.level,correlationId:n||this.correlationId},e,t)}logMessage(e,t){if(t.logLevel>this.level||!this.piiLoggingEnabled&&t.containsPii)return;const n=`[${(new Date).toUTCString()}] : [${t.correlationId||this.correlationId||""}] : ${this.packageName}@${this.packageVersion} : ${Ee[t.logLevel]} - ${e}`;this.executeCallback(t.logLevel,n,t.containsPii||!1)}executeCallback(e,t,n){this.localCallback&&this.localCallback(e,t,n)}error(e,t){this.logMessage(e,{logLevel:Ee.Error,containsPii:!1,correlationId:t||k.EMPTY_STRING})}errorPii(e,t){this.logMessage(e,{logLevel:Ee.Error,containsPii:!0,correlationId:t||k.EMPTY_STRING})}warning(e,t){this.logMessage(e,{logLevel:Ee.Warning,containsPii:!1,correlationId:t||k.EMPTY_STRING})}warningPii(e,t){this.logMessage(e,{logLevel:Ee.Warning,containsPii:!0,correlationId:t||k.EMPTY_STRING})}info(e,t){this.logMessage(e,{logLevel:Ee.Info,containsPii:!1,correlationId:t||k.EMPTY_STRING})}infoPii(e,t){this.logMessage(e,{logLevel:Ee.Info,containsPii:!0,correlationId:t||k.EMPTY_STRING})}verbose(e,t){this.logMessage(e,{logLevel:Ee.Verbose,containsPii:!1,correlationId:t||k.EMPTY_STRING})}verbosePii(e,t){this.logMessage(e,{logLevel:Ee.Verbose,containsPii:!0,correlationId:t||k.EMPTY_STRING})}trace(e,t){this.logMessage(e,{logLevel:Ee.Trace,containsPii:!1,correlationId:t||k.EMPTY_STRING})}tracePii(e,t){this.logMessage(e,{logLevel:Ee.Trace,containsPii:!0,correlationId:t||k.EMPTY_STRING})}isPiiLoggingEnabled(){return this.piiLoggingEnabled||!1}}const Re="redirect_uri_empty",Pe="claims_request_parsing_error",Me="authority_uri_insecure",Ne="url_parse_error",qe="empty_url_error",xe="empty_input_scopes_error",Ue="invalid_claims",He="token_request_empty",De="logout_request_empty",Le="invalid_code_challenge_method",Be="pkce_params_missing",Fe="invalid_cloud_discovery_metadata",$e="invalid_authority_metadata",je="untrusted_authority",Ke="missing_ssh_jwk",ze="missing_ssh_kid",Ge="missing_nonce_authentication_header",Ve="invalid_authentication_header",Ye="cannot_set_OIDCOptions",We="cannot_allow_platform_broker",Qe="authority_mismatch",Je="invalid_request_method_for_EAR",Ze="invalid_authorize_post_body_parameters",Xe={[Re]:"A redirect URI is required for all calls, and none has been set.",[Pe]:"Could not parse the given claims request object.",[Me]:"Authority URIs must use https.  Please see here for valid authority configuration options: https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-js-initializing-client-applications#configuration-options",[Ne]:"URL could not be parsed into appropriate segments.",[qe]:"URL was empty or null.",[xe]:"Scopes cannot be passed as null, undefined or empty array because they are required to obtain an access token.",[Ue]:"Given claims parameter must be a stringified JSON object.",[He]:"Token request was empty and not found in cache.",[De]:"The logout request was null or undefined.",[Le]:'code_challenge_method passed is invalid. Valid values are "plain" and "S256".',[Be]:"Both params: code_challenge and code_challenge_method are to be passed if to be sent in the request",[Fe]:"Invalid cloudDiscoveryMetadata provided. Must be a stringified JSON object containing tenant_discovery_endpoint and metadata fields",[$e]:"Invalid authorityMetadata provided. Must by a stringified JSON object containing authorization_endpoint, token_endpoint, issuer fields.",[je]:"The provided authority is not a trusted authority. Please include this authority in the knownAuthorities config parameter.",[Ke]:"Missing sshJwk in SSH certificate request. A stringified JSON Web Key is required when using the SSH authentication scheme.",[ze]:"Missing sshKid in SSH certificate request. A string that uniquely identifies the public SSH key is required when using the SSH authentication scheme.",[Ge]:"Unable to find an authentication header containing server nonce. Either the Authentication-Info or WWW-Authenticate headers must be present in order to obtain a server nonce.",[Ve]:"Invalid authentication header provided",[Ye]:"Cannot set OIDCOptions parameter. Please change the protocol mode to OIDC or use a non-Microsoft authority.",[We]:"Cannot set allowPlatformBroker parameter to true when not in AAD protocol mode.",[Qe]:"Authority mismatch error. Authority provided in login request or PublicClientApplication config does not match the environment of the provided account. Please use a matching account or make an interactive request to login to this authority.",[Ze]:"Invalid authorize post body parameters provided. If you are using authorizePostBodyParameters, the request method must be POST. Please check the request method and parameters.",[Je]:"Invalid request method for EAR protocol mode. The request method cannot be GET when using EAR protocol mode. Please change the request method to POST."};class et extends fe{constructor(e){super(e,Xe[e]),this.name="ClientConfigurationError",Object.setPrototypeOf(this,et.prototype)}}function tt(e){return new et(e)}class nt{static isEmptyObj(e){if(e)try{const t=JSON.parse(e);return 0===Object.keys(t).length}catch(e){}return!0}static startsWith(e,t){return 0===e.indexOf(t)}static endsWith(e,t){return e.length>=t.length&&e.lastIndexOf(t)===e.length-t.length}static queryStringToObject(e){const t={},n=e.split("&"),r=e=>decodeURIComponent(e.replace(/\+/g," "));return n.forEach(e=>{if(e.trim()){const[n,i]=e.split(/=(.+)/g,2);n&&i&&(t[r(n)]=r(i))}}),t}static trimArrayEntries(e){return e.map(e=>e.trim())}static removeEmptyStringsFromArray(e){return e.filter(e=>!!e)}static jsonParseHelper(e){try{return JSON.parse(e)}catch(e){return null}}static matchPattern(e,t){return new RegExp(e.replace(/\\/g,"\\\\").replace(/\*/g,"[^ ]*").replace(/\?/g,"\\?")).test(t)}}const rt="client_info_decoding_error",it="client_info_empty_error",ot="token_parsing_error",st="null_or_empty_token",at="endpoints_resolution_error",ct="network_error",lt="openid_config_error",ut="hash_not_deserialized",ht="invalid_state",dt="state_mismatch",pt="state_not_found",gt="nonce_mismatch",ft="auth_time_not_found",mt="max_age_transpired",yt="multiple_matching_tokens",Ct="multiple_matching_accounts",Tt="multiple_matching_appMetadata",At="request_cannot_be_made",wt="cannot_remove_empty_scope",kt="cannot_append_scopeset",It="empty_input_scopeset",vt="device_code_polling_cancelled",bt="device_code_expired",St="device_code_unknown_error",_t="no_account_in_silent_request",Et="invalid_cache_record",Ot="invalid_cache_environment",Rt="no_account_found",Pt="no_crypto_object",Mt="unexpected_credential_type",Nt="invalid_assertion",qt="invalid_client_credential",xt="token_refresh_required",Ut="user_timeout_reached",Ht="token_claims_cnf_required_for_signedjwt",Dt="authorization_code_missing_from_server_response",Lt="binding_key_not_removed",Bt="end_session_endpoint_not_supported",Ft="key_id_missing",$t="no_network_connectivity",jt="user_canceled",Kt="missing_tenant_id_error",zt="method_not_implemented",Gt="nested_app_auth_bridge_disabled",Vt="platform_broker_error",Yt={[rt]:"The client info could not be parsed/decoded correctly",[it]:"The client info was empty",[ot]:"Token cannot be parsed",[st]:"The token is null or empty",[at]:"Endpoints cannot be resolved",[ct]:"Network request failed",[lt]:"Could not retrieve endpoints. Check your authority and verify the .well-known/openid-configuration endpoint returns the required endpoints.",[ut]:"The hash parameters could not be deserialized",[ht]:"State was not the expected format",[dt]:"State mismatch error",[pt]:"State not found",[gt]:"Nonce mismatch error",[ft]:"Max Age was requested and the ID token is missing the auth_time variable. auth_time is an optional claim and is not enabled by default - it must be enabled. See https://aka.ms/msaljs/optional-claims for more information.",[mt]:"Max Age is set to 0, or too much time has elapsed since the last end-user authentication.",[yt]:"The cache contains multiple tokens satisfying the requirements. Call AcquireToken again providing more requirements such as authority or account.",[Ct]:"The cache contains multiple accounts satisfying the given parameters. Please pass more info to obtain the correct account",[Tt]:"The cache contains multiple appMetadata satisfying the given parameters. Please pass more info to obtain the correct appMetadata",[At]:"Token request cannot be made without authorization code or refresh token.",[wt]:"Cannot remove null or empty scope from ScopeSet",[kt]:"Cannot append ScopeSet",[It]:"Empty input ScopeSet cannot be processed",[vt]:"Caller has cancelled token endpoint polling during device code flow by setting DeviceCodeRequest.cancel = true.",[bt]:"Device code is expired.",[St]:"Device code stopped polling for unknown reasons.",[_t]:"Please pass an account object, silent flow is not supported without account information",[Et]:"Cache record object was null or undefined.",[Ot]:"Invalid environment when attempting to create cache entry",[Rt]:"No account found in cache for given key.",[Pt]:"No crypto object detected.",[Mt]:"Unexpected credential type.",[Nt]:"Client assertion must meet requirements described in https://tools.ietf.org/html/rfc7515",[qt]:"Client credential (secret, certificate, or assertion) must not be empty when creating a confidential client. An application should at most have one credential",[xt]:"Cannot return token from cache because it must be refreshed. This may be due to one of the following reasons: forceRefresh parameter is set to true, claims have been requested, there is no cached access token or it is expired.",[Ut]:"User defined timeout for device code polling reached",[Ht]:"Cannot generate a POP jwt if the token_claims are not populated",[Dt]:"Server response does not contain an authorization code to proceed",[Lt]:"Could not remove the credential's binding key from storage.",[Bt]:"The provided authority does not support logout",[Ft]:"A keyId value is missing from the requested bound token's cache record and is required to match the token to it's stored binding key.",[$t]:"No network connectivity. Check your internet connection.",[jt]:"User cancelled the flow.",[Kt]:"A tenant id - not common, organizations, or consumers - must be specified when using the client_credentials flow.",[zt]:"This method has not been implemented",[Gt]:"The nested app auth bridge is disabled",[Vt]:"An error occurred in the native broker. See the platformBrokerError property for details."};class Wt extends fe{constructor(e,t){super(e,t?`${Yt[e]}: ${t}`:Yt[e]),this.name="ClientAuthError",Object.setPrototypeOf(this,Wt.prototype)}}function Qt(e,t){return new Wt(e,t)}function Jt(e){if(!e||e.indexOf("=")<0)return null;try{const t=function(e){return e.startsWith("#/")?e.substring(2):e.startsWith("#")||e.startsWith("?")?e.substring(1):e}(e),n=Object.fromEntries(new URLSearchParams(t));if(n.code||n.ear_jwe||n.error||n.error_description||n.state)return n}catch(e){throw Qt(ut)}return null}function Zt(e,t=!0,n){const r=new Array;return e.forEach((e,i)=>{!t&&n&&i in n?r.push(`${i}=${e}`):r.push(`${i}=${encodeURIComponent(e)}`)}),r.join("&")}class Xt{get urlString(){return this._urlString}constructor(e){if(this._urlString=e,!this._urlString)throw tt(qe);e.includes("#")||(this._urlString=Xt.canonicalizeUri(e))}static canonicalizeUri(e){if(e){let t=e.toLowerCase();return nt.endsWith(t,"?")?t=t.slice(0,-1):nt.endsWith(t,"?/")&&(t=t.slice(0,-2)),nt.endsWith(t,"/")||(t+="/"),t}return e}validateAsUri(){let e;try{e=this.getUrlComponents()}catch(e){throw tt(Ne)}if(!e.HostNameAndPort||!e.PathSegments)throw tt(Ne);if(!e.Protocol||"https:"!==e.Protocol.toLowerCase())throw tt(Me)}static appendQueryString(e,t){return t?e.indexOf("?")<0?`${e}?${t}`:`${e}&${t}`:e}static removeHashFromUrl(e){return Xt.canonicalizeUri(e.split("#")[0])}replaceTenantPath(e){const t=this.getUrlComponents(),n=t.PathSegments;return!e||0===n.length||n[0]!==R.COMMON&&n[0]!==R.ORGANIZATIONS||(n[0]=e),Xt.constructAuthorityUriFromObject(t)}getUrlComponents(){const e=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),t=this.urlString.match(e);if(!t)throw tt(Ne);const n={Protocol:t[1],HostNameAndPort:t[4],AbsolutePath:t[5],QueryString:t[7]};let r=n.AbsolutePath.split("/");return r=r.filter(e=>e&&e.length>0),n.PathSegments=r,n.QueryString&&n.QueryString.endsWith("/")&&(n.QueryString=n.QueryString.substring(0,n.QueryString.length-1)),n}static getDomainFromUrl(e){const t=RegExp("^([^:/?#]+://)?([^/?#]*)"),n=e.match(t);if(!n)throw tt(Ne);return n[2]}static getAbsoluteUrl(e,t){if(e[0]===k.FORWARD_SLASH){const n=new Xt(t).getUrlComponents();return n.Protocol+"//"+n.HostNameAndPort+e}return e}static constructAuthorityUriFromObject(e){return new Xt(e.Protocol+"//"+e.HostNameAndPort+"/"+e.PathSegments.join("/"))}static hashContainsKnownProperties(e){return!!Jt(e)}}const en={"login.microsoftonline.com":{token_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.com/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.com/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/logout"},"login.chinacloudapi.cn":{token_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.chinacloudapi.cn/{tenantid}/discovery/v2.0/keys",issuer:"https://login.partner.microsoftonline.cn/{tenantid}/v2.0",authorization_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/logout"},"login.microsoftonline.us":{token_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.us/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.us/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/logout"}},tn={metadata:[{preferred_network:"login.microsoftonline.com",preferred_cache:"login.windows.net",aliases:["login.microsoftonline.com","login.windows.net","login.microsoft.com","sts.windows.net"]},{preferred_network:"login.partner.microsoftonline.cn",preferred_cache:"login.partner.microsoftonline.cn",aliases:["login.partner.microsoftonline.cn","login.chinacloudapi.cn"]},{preferred_network:"login.microsoftonline.de",preferred_cache:"login.microsoftonline.de",aliases:["login.microsoftonline.de"]},{preferred_network:"login.microsoftonline.us",preferred_cache:"login.microsoftonline.us",aliases:["login.microsoftonline.us","login.usgovcloudapi.net"]},{preferred_network:"login-us.microsoftonline.com",preferred_cache:"login-us.microsoftonline.com",aliases:["login-us.microsoftonline.com"]}]},nn=new Set;function rn(e,t,n,r){if(r?.trace(`getAliasesFromMetadata called with source: ${n}`),e&&t){const i=on(t,e);if(i)return r?.trace(`getAliasesFromMetadata: found cloud discovery metadata in ${n}, returning aliases`),i.aliases;r?.trace(`getAliasesFromMetadata: did not find cloud discovery metadata in ${n}`)}return null}function on(e,t){for(let n=0;n<e.length;n++){const r=e[n];if(r.aliases.includes(t))return r}return null}tn.metadata.forEach(e=>{e.aliases.forEach(e=>{nn.add(e)})});const sn="OIDC",an="none",cn="networkClientSendPostRequestAsync",ln="refreshTokenClientExecutePostToTokenEndpoint",un="authorizationCodeClientExecutePostToTokenEndpoint",hn="refreshTokenClientExecuteTokenRequest",dn="refreshTokenClientAcquireToken",pn="refreshTokenClientAcquireTokenWithCachedRefreshToken",gn="refreshTokenClientAcquireTokenByRefreshToken",fn="refreshTokenClientCreateTokenRequestBody",mn="silentFlowClientAcquireCachedToken",yn="silentFlowClientGenerateResultFromCacheRecord",Cn="updateTokenEndpointAuthority",Tn="authClientAcquireToken",An="authClientExecuteTokenRequest",wn="authClientCreateTokenRequestBody",kn="popTokenGenerateCnf",In="popTokenGenerateKid",vn="handleServerTokenResponse",bn="authorityFactoryCreateDiscoveredInstance",Sn="authorityResolveEndpointsAsync",_n="authorityGetCloudDiscoveryMetadataFromNetwork",En="authorityUpdateCloudDiscoveryMetadata",On="authorityGetEndpointMetadataFromNetwork",Rn="authorityUpdateEndpointMetadata",Pn="authorityUpdateMetadataWithRegionalInformation",Mn="regionDiscoveryDetectRegion",Nn="regionDiscoveryGetRegionFromIMDS",qn="regionDiscoveryGetCurrentVersion",xn="cacheManagerGetRefreshToken",Un=(new Map([["acquireTokenByCode","ATByCode"],["acquireTokenByRefreshToken","ATByRT"],["acquireTokenSilent","ATS"],["acquireTokenSilentAsync","ATSAsync"],["acquireTokenPopup","ATPopup"],["acquireTokenRedirect","ATRedirect"],["cryptoOptsGetPublicKeyThumbprint","CryptoGetPKThumb"],["cryptoOptsSignJwt","CryptoSignJwt"],["silentCacheClientAcquireToken","SltCacheClientAT"],["silentIframeClientAcquireToken","SltIframeClientAT"],["silentRefreshClientAcquireToken","SltRClientAT"],["ssoSilent","SsoSlt"],["standardInteractionClientGetDiscoveredAuthority","StdIntClientGetDiscAuth"],["fetchAccountIdWithNativeBroker","FetchAccIdWithNtvBroker"],["nativeInteractionClientAcquireToken","NtvIntClientAT"],["baseClientCreateTokenRequestHeaders","BaseClientCreateTReqHead"],[cn,"NetClientSendPost"],[ln,"RTClientExecPost"],[un,"AuthCodeClientExecPost"],["brokerHandshake","BrokerHandshake"],["acquireTokenByRefreshTokenInBroker","ATByRTInBroker"],["acquireTokenByBroker","ATByBroker"],[hn,"RTClientExecTReq"],[dn,"RTClientAT"],[pn,"RTClientATWithCachedRT"],[gn,"RTClientATByRT"],[fn,"RTClientCreateTReqBody"],["acquireTokenFromCache","ATFromCache"],[mn,"SltFlowClientATCached"],[yn,"SltFlowClientGenResFromCache"],["acquireTokenBySilentIframe","ATBySltIframe"],["initializeBaseRequest","InitBaseReq"],["initializeSilentRequest","InitSltReq"],["initializeClientApplication","InitClientApplication"],["initializeCache","InitCache"],["importExistingCache","importCache"],["setUserData","setUserData"],["localStorageUpdated","localStorageUpdated"],["silentIframeClientTokenHelper","SIClientTHelper"],["silentHandlerInitiateAuthRequest","SHandlerInitAuthReq"],["silentHandlerMonitorIframeForHash","SltHandlerMonitorIframeForHash"],["silentHandlerLoadFrame","SHandlerLoadFrame"],["silentHandlerLoadFrameSync","SHandlerLoadFrameSync"],["standardInteractionClientCreateAuthCodeClient","StdIntClientCreateAuthCodeClient"],["standardInteractionClientGetClientConfiguration","StdIntClientGetClientConf"],["standardInteractionClientInitializeAuthorizationRequest","StdIntClientInitAuthReq"],["getAuthCodeUrl","GetAuthCodeUrl"],["handleCodeResponseFromServer","HandleCodeResFromServer"],["handleCodeResponse","HandleCodeResp"],["handleResponseEar","HandleRespEar"],["handleResponseCode","HandleRespCode"],["handleResponsePlatformBroker","HandleRespPlatBroker"],[Cn,"UpdTEndpointAuth"],[Tn,"AuthClientAT"],[An,"AuthClientExecTReq"],[wn,"AuthClientCreateTReqBody"],[kn,"PopTGenCnf"],[In,"PopTGenKid"],[vn,"HandleServerTRes"],["deserializeResponse","DeserializeRes"],[bn,"AuthFactCreateDiscInst"],[Sn,"AuthResolveEndpointsAsync"],["authorityResolveEndpointsFromLocalSources","AuthResolveEndpointsFromLocal"],[_n,"AuthGetCDMetaFromNet"],[En,"AuthUpdCDMeta"],[On,"AuthUpdCDMetaFromNet"],[Rn,"AuthUpdEndpointMeta"],[Pn,"AuthUpdMetaWithRegInfo"],[Mn,"RegDiscDetectReg"],[Nn,"RegDiscGetRegFromIMDS"],[qn,"RegDiscGetCurrentVer"],["acquireTokenByCodeAsync","ATByCodeAsync"],["getEndpointMetadataFromNetwork","GetEndpointMetaFromNet"],["getCloudDiscoveryMetadataFromNetworkMeasurement","GetCDMetaFromNet"],["handleRedirectPromise","HandleRedirectPromise"],["handleNativeRedirectPromise","HandleNtvRedirectPromise"],["updateCloudDiscoveryMetadataMeasurement","UpdateCDMeta"],["usernamePasswordClientAcquireToken","UserPassClientAT"],["nativeMessageHandlerHandshake","NtvMsgHandlerHandshake"],["nativeGenerateAuthResult","NtvGenAuthRes"],["removeHiddenIframe","RemoveHiddenIframe"],["clearTokensAndKeysWithClaims","ClearTAndKeysWithClaims"],[xn,"CacheManagerGetRT"],["generatePkceCodes","GenPkceCodes"],["generateCodeVerifier","GenCodeVerifier"],["generateCodeChallengeFromVerifier","GenCodeChallengeFromVerifier"],["sha256Digest","Sha256Digest"],["getRandomValues","GetRandomValues"],["generateHKDF","genHKDF"],["generateBaseKey","genBaseKey"],["base64Decode","b64Decode"],["urlEncodeArr","urlEncArr"],["encrypt","encrypt"],["decrypt","decrypt"],["generateEarKey","genEarKey"],["decryptEarResponse","decryptEarResp"]]),1),Hn=(new Set(["accessTokenSize","durationMs","idTokenSize","matsSilentStatus","matsHttpStatus","refreshTokenSize","queuedTimeMs","startTimeMs","status","multiMatchedAT","multiMatchedID","multiMatchedRT","unencryptedCacheCount","encryptedCacheExpiredCount","oldAccountCount","oldAccessCount","oldIdCount","oldRefreshCount","currAccountCount","currAccessCount","currIdCount","currRefreshCount","expiredCacheRemovedCount","upgradedCacheCount"]),(e,t,n,r,i)=>(...o)=>{n.trace(`Executing function ${t}`);const s=r?.startMeasurement(t,i);if(i){const e=t+"CallCount";r?.incrementFields({[e]:1},i)}return r?.setPreQueueTime(t,i),e(...o).then(e=>(n.trace(`Returning result from ${t}`),s?.end({success:!0}),e)).catch(e=>{n.trace(`Error occurred in ${t}`);try{n.trace(JSON.stringify(e))}catch(e){n.trace("Unable to print error message.")}throw s?.end({success:!1},e),e})});class Dn{constructor(e,t,n,r){this.networkInterface=e,this.logger=t,this.performanceClient=n,this.correlationId=r}async detectRegion(e,t){this.performanceClient?.addQueueMeasurement(Mn,this.correlationId);let n=e;if(n)t.region_source="3";else{const e=Dn.IMDS_OPTIONS;try{const r=await Hn(this.getRegionFromIMDS.bind(this),Nn,this.logger,this.performanceClient,this.correlationId)(k.IMDS_VERSION,e);if(200===r.status&&(n=r.body,t.region_source="4"),400===r.status){const r=await Hn(this.getCurrentVersion.bind(this),qn,this.logger,this.performanceClient,this.correlationId)(e);if(!r)return t.region_source="1",null;const i=await Hn(this.getRegionFromIMDS.bind(this),Nn,this.logger,this.performanceClient,this.correlationId)(r,e);200===i.status&&(n=i.body,t.region_source="4")}}catch(e){return t.region_source="1",null}}return n||(t.region_source="1"),n||null}async getRegionFromIMDS(e,t){return this.performanceClient?.addQueueMeasurement(Nn,this.correlationId),this.networkInterface.sendGetRequestAsync(`${k.IMDS_ENDPOINT}?api-version=${e}&format=text`,t,k.IMDS_TIMEOUT)}async getCurrentVersion(e){this.performanceClient?.addQueueMeasurement(qn,this.correlationId);try{const t=await this.networkInterface.sendGetRequestAsync(`${k.IMDS_ENDPOINT}?format=json`,e);return 400===t.status&&t.body&&t.body["newest-versions"]&&t.body["newest-versions"].length>0?t.body["newest-versions"][0]:null}catch(e){return null}}}function Ln(e,t){const n=function(e){if(!e)throw Qt(st);const t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(!t||t.length<4)throw Qt(ot);return t[2]}(e);try{const e=t(n);return JSON.parse(e)}catch(e){throw Qt(ot)}}function Bn(e,t){if(0===t||Date.now()-3e5>e+t)throw Qt(mt)}function Fn(){return Math.round((new Date).getTime()/1e3)}function $n(e){return e?new Date(1e3*Number(e)):new Date}function jn(e,t){const n=Number(e)||0;return Fn()+t>n}function Kn(e,t){return new Promise(n=>setTimeout(()=>n(t),e))}function zn(e){return e.hasOwnProperty("homeAccountId")&&e.hasOwnProperty("environment")&&e.hasOwnProperty("credentialType")&&e.hasOwnProperty("clientId")&&e.hasOwnProperty("secret")}function Gn(e){return!!e&&zn(e)&&e.hasOwnProperty("realm")&&e.hasOwnProperty("target")&&(e.credentialType===x.ACCESS_TOKEN||e.credentialType===x.ACCESS_TOKEN_WITH_AUTH_SCHEME)}function Vn(e){return!!e&&zn(e)&&e.hasOwnProperty("realm")&&e.credentialType===x.ID_TOKEN}function Yn(e){return!!e&&zn(e)&&e.credentialType===x.REFRESH_TOKEN}function Wn(e,t){return!!t&&0===e.indexOf(U)&&t.hasOwnProperty("clientId")&&t.hasOwnProperty("environment")}function Qn(){return Fn()+86400}function Jn(e,t,n){e.authorization_endpoint=t.authorization_endpoint,e.token_endpoint=t.token_endpoint,e.end_session_endpoint=t.end_session_endpoint,e.issuer=t.issuer,e.endpointsFromNetwork=n,e.jwks_uri=t.jwks_uri}function Zn(e,t,n){e.aliases=t.aliases,e.preferred_cache=t.preferred_cache,e.preferred_network=t.preferred_network,e.aliasesFromNetwork=n}function Xn(e){return e.expiresAt<=Fn()}Dn.IMDS_OPTIONS={headers:{Metadata:"true"}};class er{constructor(e,t,n,r,i,o,s,a){this.canonicalAuthority=e,this._canonicalAuthority.validateAsUri(),this.networkInterface=t,this.cacheManager=n,this.authorityOptions=r,this.regionDiscoveryMetadata={region_used:void 0,region_source:void 0,region_outcome:void 0},this.logger=i,this.performanceClient=s,this.correlationId=o,this.managedIdentity=a||!1,this.regionDiscovery=new Dn(t,this.logger,this.performanceClient,this.correlationId)}getAuthorityType(e){if(e.HostNameAndPort.endsWith(k.CIAM_AUTH_URL))return 3;const t=e.PathSegments;if(t.length)switch(t[0].toLowerCase()){case k.ADFS:return 1;case k.DSTS:return 2}return 0}get authorityType(){return this.getAuthorityType(this.canonicalAuthorityUrlComponents)}get protocolMode(){return this.authorityOptions.protocolMode}get options(){return this.authorityOptions}get canonicalAuthority(){return this._canonicalAuthority.urlString}set canonicalAuthority(e){this._canonicalAuthority=new Xt(e),this._canonicalAuthority.validateAsUri(),this._canonicalAuthorityUrlComponents=null}get canonicalAuthorityUrlComponents(){return this._canonicalAuthorityUrlComponents||(this._canonicalAuthorityUrlComponents=this._canonicalAuthority.getUrlComponents()),this._canonicalAuthorityUrlComponents}get hostnameAndPort(){return this.canonicalAuthorityUrlComponents.HostNameAndPort.toLowerCase()}get tenant(){return this.canonicalAuthorityUrlComponents.PathSegments[0]}get authorizationEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.authorization_endpoint);throw Qt(at)}get tokenEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint);throw Qt(at)}get deviceCodeEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint.replace("/token","/devicecode"));throw Qt(at)}get endSessionEndpoint(){if(this.discoveryComplete()){if(!this.metadata.end_session_endpoint)throw Qt(Bt);return this.replacePath(this.metadata.end_session_endpoint)}throw Qt(at)}get selfSignedJwtAudience(){if(this.discoveryComplete())return this.replacePath(this.metadata.issuer);throw Qt(at)}get jwksUri(){if(this.discoveryComplete())return this.replacePath(this.metadata.jwks_uri);throw Qt(at)}canReplaceTenant(e){return 1===e.PathSegments.length&&!er.reservedTenantDomains.has(e.PathSegments[0])&&0===this.getAuthorityType(e)&&this.protocolMode!==sn}replaceTenant(e){return e.replace(/{tenant}|{tenantid}/g,this.tenant)}replacePath(e){let t=e;const n=new Xt(this.metadata.canonical_authority).getUrlComponents(),r=n.PathSegments;return this.canonicalAuthorityUrlComponents.PathSegments.forEach((e,i)=>{let o=r[i];if(0===i&&this.canReplaceTenant(n)){const e=new Xt(this.metadata.authorization_endpoint).getUrlComponents().PathSegments[0];o!==e&&(this.logger.verbose(`Replacing tenant domain name ${o} with id ${e}`),o=e)}e!==o&&(t=t.replace(`/${o}/`,`/${e}/`))}),this.replaceTenant(t)}get defaultOpenIdConfigurationEndpoint(){const e=this.hostnameAndPort;return this.canonicalAuthority.endsWith("v2.0/")||1===this.authorityType||this.protocolMode===sn&&!this.isAliasOfKnownMicrosoftAuthority(e)?`${this.canonicalAuthority}.well-known/openid-configuration`:`${this.canonicalAuthority}v2.0/.well-known/openid-configuration`}discoveryComplete(){return!!this.metadata}async resolveEndpointsAsync(){this.performanceClient?.addQueueMeasurement(Sn,this.correlationId);const e=this.getCurrentMetadataEntity(),t=await Hn(this.updateCloudDiscoveryMetadata.bind(this),En,this.logger,this.performanceClient,this.correlationId)(e);this.canonicalAuthority=this.canonicalAuthority.replace(this.hostnameAndPort,e.preferred_network);const n=await Hn(this.updateEndpointMetadata.bind(this),Rn,this.logger,this.performanceClient,this.correlationId)(e);this.updateCachedMetadata(e,t,{source:n}),this.performanceClient?.addFields({cloudDiscoverySource:t,authorityEndpointSource:n},this.correlationId)}getCurrentMetadataEntity(){let e=this.cacheManager.getAuthorityMetadataByAlias(this.hostnameAndPort);return e||(e={aliases:[],preferred_cache:this.hostnameAndPort,preferred_network:this.hostnameAndPort,canonical_authority:this.canonicalAuthority,authorization_endpoint:"",token_endpoint:"",end_session_endpoint:"",issuer:"",aliasesFromNetwork:!1,endpointsFromNetwork:!1,expiresAt:Qn(),jwks_uri:""}),e}updateCachedMetadata(e,t,n){t!==B&&n?.source!==B&&(e.expiresAt=Qn(),e.canonical_authority=this.canonicalAuthority);const r=this.cacheManager.generateAuthorityMetadataCacheKey(e.preferred_cache);this.cacheManager.setAuthorityMetadata(r,e),this.metadata=e}async updateEndpointMetadata(e){this.performanceClient?.addQueueMeasurement(Rn,this.correlationId);const t=this.updateEndpointMetadataFromLocalSources(e);if(t)return t.source===$&&this.authorityOptions.azureRegionConfiguration?.azureRegion&&t.metadata&&(Jn(e,await Hn(this.updateMetadataWithRegionalInformation.bind(this),Pn,this.logger,this.performanceClient,this.correlationId)(t.metadata),!1),e.canonical_authority=this.canonicalAuthority),t.source;let n=await Hn(this.getEndpointMetadataFromNetwork.bind(this),On,this.logger,this.performanceClient,this.correlationId)();if(n)return this.authorityOptions.azureRegionConfiguration?.azureRegion&&(n=await Hn(this.updateMetadataWithRegionalInformation.bind(this),Pn,this.logger,this.performanceClient,this.correlationId)(n)),Jn(e,n,!0),F;throw Qt(lt,this.defaultOpenIdConfigurationEndpoint)}updateEndpointMetadataFromLocalSources(e){this.logger.verbose("Attempting to get endpoint metadata from authority configuration");const t=this.getEndpointMetadataFromConfig();if(t)return this.logger.verbose("Found endpoint metadata in authority configuration"),Jn(e,t,!1),{source:L};if(this.logger.verbose("Did not find endpoint metadata in the config... Attempting to get endpoint metadata from the hardcoded values."),this.authorityOptions.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get endpoint metadata from the network metadata cache.");else{const t=this.getEndpointMetadataFromHardcodedValues();if(t)return Jn(e,t,!1),{source:$,metadata:t};this.logger.verbose("Did not find endpoint metadata in hardcoded values... Attempting to get endpoint metadata from the network metadata cache.")}const n=Xn(e);return this.isAuthoritySameType(e)&&e.endpointsFromNetwork&&!n?(this.logger.verbose("Found endpoint metadata in the cache."),{source:B}):(n&&this.logger.verbose("The metadata entity is expired."),null)}isAuthoritySameType(e){return new Xt(e.canonical_authority).getUrlComponents().PathSegments.length===this.canonicalAuthorityUrlComponents.PathSegments.length}getEndpointMetadataFromConfig(){if(this.authorityOptions.authorityMetadata)try{return JSON.parse(this.authorityOptions.authorityMetadata)}catch(e){throw tt($e)}return null}async getEndpointMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(On,this.correlationId);const e={},t=this.defaultOpenIdConfigurationEndpoint;this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: attempting to retrieve OAuth endpoints from ${t}`);try{const n=await this.networkInterface.sendGetRequestAsync(t,e),r=function(e){return e.hasOwnProperty("authorization_endpoint")&&e.hasOwnProperty("token_endpoint")&&e.hasOwnProperty("issuer")&&e.hasOwnProperty("jwks_uri")}(n.body);return r?n.body:(this.logger.verbose("Authority.getEndpointMetadataFromNetwork: could not parse response as OpenID configuration"),null)}catch(e){return this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: ${e}`),null}}getEndpointMetadataFromHardcodedValues(){return this.hostnameAndPort in en?en[this.hostnameAndPort]:null}async updateMetadataWithRegionalInformation(e){this.performanceClient?.addQueueMeasurement(Pn,this.correlationId);const t=this.authorityOptions.azureRegionConfiguration?.azureRegion;if(t){if(t!==k.AZURE_REGION_AUTO_DISCOVER_FLAG)return this.regionDiscoveryMetadata.region_outcome="2",this.regionDiscoveryMetadata.region_used=t,er.replaceWithRegionalInformation(e,t);const n=await Hn(this.regionDiscovery.detectRegion.bind(this.regionDiscovery),Mn,this.logger,this.performanceClient,this.correlationId)(this.authorityOptions.azureRegionConfiguration?.environmentRegion,this.regionDiscoveryMetadata);if(n)return this.regionDiscoveryMetadata.region_outcome="4",this.regionDiscoveryMetadata.region_used=n,er.replaceWithRegionalInformation(e,n);this.regionDiscoveryMetadata.region_outcome="5"}return e}async updateCloudDiscoveryMetadata(e){this.performanceClient?.addQueueMeasurement(En,this.correlationId);const t=this.updateCloudDiscoveryMetadataFromLocalSources(e);if(t)return t;const n=await Hn(this.getCloudDiscoveryMetadataFromNetwork.bind(this),_n,this.logger,this.performanceClient,this.correlationId)();if(n)return Zn(e,n,!0),F;throw tt(je)}updateCloudDiscoveryMetadataFromLocalSources(e){this.logger.verbose("Attempting to get cloud discovery metadata  from authority configuration"),this.logger.verbosePii(`Known Authorities: ${this.authorityOptions.knownAuthorities||k.NOT_APPLICABLE}`),this.logger.verbosePii(`Authority Metadata: ${this.authorityOptions.authorityMetadata||k.NOT_APPLICABLE}`),this.logger.verbosePii(`Canonical Authority: ${e.canonical_authority||k.NOT_APPLICABLE}`);const t=this.getCloudDiscoveryMetadataFromConfig();if(t)return this.logger.verbose("Found cloud discovery metadata in authority configuration"),Zn(e,t,!1),L;if(this.logger.verbose("Did not find cloud discovery metadata in the config... Attempting to get cloud discovery metadata from the hardcoded values."),this.options.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded cloud discovery metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get cloud discovery metadata from the network metadata cache.");else{const t=(n=this.hostnameAndPort,on(tn.metadata,n));if(t)return this.logger.verbose("Found cloud discovery metadata from hardcoded values."),Zn(e,t,!1),$;this.logger.verbose("Did not find cloud discovery metadata in hardcoded values... Attempting to get cloud discovery metadata from the network metadata cache.")}var n;const r=Xn(e);return this.isAuthoritySameType(e)&&e.aliasesFromNetwork&&!r?(this.logger.verbose("Found cloud discovery metadata in the cache."),B):(r&&this.logger.verbose("The metadata entity is expired."),null)}getCloudDiscoveryMetadataFromConfig(){if(3===this.authorityType)return this.logger.verbose("CIAM authorities do not support cloud discovery metadata, generate the aliases from authority host."),er.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort);if(this.authorityOptions.cloudDiscoveryMetadata){this.logger.verbose("The cloud discovery metadata has been provided as a network response, in the config.");try{this.logger.verbose("Attempting to parse the cloud discovery metadata.");const e=on(JSON.parse(this.authorityOptions.cloudDiscoveryMetadata).metadata,this.hostnameAndPort);if(this.logger.verbose("Parsed the cloud discovery metadata."),e)return this.logger.verbose("There is returnable metadata attached to the parsed cloud discovery metadata."),e;this.logger.verbose("There is no metadata attached to the parsed cloud discovery metadata.")}catch(e){throw this.logger.verbose("Unable to parse the cloud discovery metadata. Throwing Invalid Cloud Discovery Metadata Error."),tt(Fe)}}return this.isInKnownAuthorities()?(this.logger.verbose("The host is included in knownAuthorities. Creating new cloud discovery metadata from the host."),er.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)):null}async getCloudDiscoveryMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(_n,this.correlationId);const e=`${k.AAD_INSTANCE_DISCOVERY_ENDPT}${this.canonicalAuthority}oauth2/v2.0/authorize`,t={};let n=null;try{const r=await this.networkInterface.sendGetRequestAsync(e,t);let i,o;if(function(e){return e.hasOwnProperty("tenant_discovery_endpoint")&&e.hasOwnProperty("metadata")}(r.body))i=r.body,o=i.metadata,this.logger.verbosePii(`tenant_discovery_endpoint is: ${i.tenant_discovery_endpoint}`);else{if(!function(e){return e.hasOwnProperty("error")&&e.hasOwnProperty("error_description")}(r.body))return this.logger.error("AAD did not return a CloudInstanceDiscoveryResponse or CloudInstanceDiscoveryErrorResponse"),null;if(this.logger.warning(`A CloudInstanceDiscoveryErrorResponse was returned. The cloud instance discovery network request's status code is: ${r.status}`),i=r.body,i.error===k.INVALID_INSTANCE)return this.logger.error("The CloudInstanceDiscoveryErrorResponse error is invalid_instance."),null;this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error is ${i.error}`),this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error description is ${i.error_description}`),this.logger.warning("Setting the value of the CloudInstanceDiscoveryMetadata (returned from the network) to []"),o=[]}this.logger.verbose("Attempting to find a match between the developer's authority and the CloudInstanceDiscoveryMetadata returned from the network request."),n=on(o,this.hostnameAndPort)}catch(e){if(e instanceof fe)this.logger.error(`There was a network error while attempting to get the cloud discovery instance metadata.\nError: ${e.errorCode}\nError Description: ${e.errorMessage}`);else{const t=e;this.logger.error(`A non-MSALJS error was thrown while attempting to get the cloud instance discovery metadata.\nError: ${t.name}\nError Description: ${t.message}`)}return null}return n||(this.logger.warning("The developer's authority was not found within the CloudInstanceDiscoveryMetadata returned from the network request."),this.logger.verbose("Creating custom Authority for custom domain scenario."),n=er.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)),n}isInKnownAuthorities(){return this.authorityOptions.knownAuthorities.filter(e=>e&&Xt.getDomainFromUrl(e).toLowerCase()===this.hostnameAndPort).length>0}static generateAuthority(e,t){let n;if(t&&t.azureCloudInstance!==an){const e=t.tenant?t.tenant:k.DEFAULT_COMMON_TENANT;n=`${t.azureCloudInstance}/${e}/`}return n||e}static createCloudDiscoveryMetadataFromHost(e){return{preferred_network:e,preferred_cache:e,aliases:[e]}}getPreferredCache(){if(this.managedIdentity)return k.DEFAULT_AUTHORITY_HOST;if(this.discoveryComplete())return this.metadata.preferred_cache;throw Qt(at)}isAlias(e){return this.metadata.aliases.indexOf(e)>-1}isAliasOfKnownMicrosoftAuthority(e){return nn.has(e)}static isPublicCloudAuthority(e){return k.KNOWN_PUBLIC_CLOUDS.indexOf(e)>=0}static buildRegionalAuthorityString(e,t,n){const r=new Xt(e);r.validateAsUri();const i=r.getUrlComponents();let o=`${t}.${i.HostNameAndPort}`;this.isPublicCloudAuthority(i.HostNameAndPort)&&(o=`${t}.${k.REGIONAL_AUTH_PUBLIC_CLOUD_SUFFIX}`);const s=Xt.constructAuthorityUriFromObject({...r.getUrlComponents(),HostNameAndPort:o}).urlString;return n?`${s}?${n}`:s}static replaceWithRegionalInformation(e,t){const n={...e};return n.authorization_endpoint=er.buildRegionalAuthorityString(n.authorization_endpoint,t),n.token_endpoint=er.buildRegionalAuthorityString(n.token_endpoint,t),n.end_session_endpoint&&(n.end_session_endpoint=er.buildRegionalAuthorityString(n.end_session_endpoint,t)),n}static transformCIAMAuthority(e){let t=e;const n=new Xt(e).getUrlComponents();return 0===n.PathSegments.length&&n.HostNameAndPort.endsWith(k.CIAM_AUTH_URL)&&(t=`${t}${n.HostNameAndPort.split(".")[0]}${k.AAD_TENANT_DOMAIN_SUFFIX}`),t}}function tr(e){return e.endsWith(k.FORWARD_SLASH)?e:`${e}${k.FORWARD_SLASH}`}er.reservedTenantDomains=new Set(["{tenant}","{tenantid}",R.COMMON,R.CONSUMERS,R.ORGANIZATIONS]);const nr={createNewGuid:()=>{throw Qt(zt)},base64Decode:()=>{throw Qt(zt)},base64Encode:()=>{throw Qt(zt)},base64UrlEncode:()=>{throw Qt(zt)},encodeKid:()=>{throw Qt(zt)},async getPublicKeyThumbprint(){throw Qt(zt)},async removeTokenBindingKey(){throw Qt(zt)},async clearKeystore(){throw Qt(zt)},async signJwt(){throw Qt(zt)},async hashString(){throw Qt(zt)}},rr="@azure/msal-common",ir="15.13.2";class or{constructor(e){const t=e?nt.trimArrayEntries([...e]):[],n=t?nt.removeEmptyStringsFromArray(t):[];if(!n||!n.length)throw tt(xe);this.scopes=new Set,n.forEach(e=>this.scopes.add(e))}static fromString(e){const t=(e||k.EMPTY_STRING).split(" ");return new or(t)}static createSearchScopes(e){const t=e&&e.length>0?e:[...I],n=new or(t);return n.containsOnlyOIDCScopes()?n.removeScope(k.OFFLINE_ACCESS_SCOPE):n.removeOIDCScopes(),n}containsScope(e){const t=this.printScopesLowerCase().split(" "),n=new or(t);return!!e&&n.scopes.has(e.toLowerCase())}containsScopeSet(e){return!(!e||e.scopes.size<=0)&&this.scopes.size>=e.scopes.size&&e.asArray().every(e=>this.containsScope(e))}containsOnlyOIDCScopes(){let e=0;return v.forEach(t=>{this.containsScope(t)&&(e+=1)}),this.scopes.size===e}appendScope(e){e&&this.scopes.add(e.trim())}appendScopes(e){try{e.forEach(e=>this.appendScope(e))}catch(e){throw Qt(kt)}}removeScope(e){if(!e)throw Qt(wt);this.scopes.delete(e.trim())}removeOIDCScopes(){v.forEach(e=>{this.scopes.delete(e)})}unionScopeSets(e){if(!e)throw Qt(It);const t=new Set;return e.scopes.forEach(e=>t.add(e.toLowerCase())),this.scopes.forEach(e=>t.add(e.toLowerCase())),t}intersectingScopeSets(e){if(!e)throw Qt(It);e.containsOnlyOIDCScopes()||e.removeOIDCScopes();const t=this.unionScopeSets(e),n=e.getScopeCount(),r=this.getScopeCount();return t.size<r+n}getScopeCount(){return this.scopes.size}asArray(){const e=[];return this.scopes.forEach(t=>e.push(t)),e}printScopes(){return this.scopes?this.asArray().join(" "):k.EMPTY_STRING}printScopesLowerCase(){return this.printScopes().toLowerCase()}}function sr(e,t){if(!e)throw Qt(it);try{const n=t(e);return JSON.parse(n)}catch(e){throw Qt(rt)}}function ar(e){if(!e)throw Qt(rt);const t=e.split(".",2);return{uid:t[0],utid:t.length<2?k.EMPTY_STRING:t[1]}}function cr(e,t){return!!e&&!!t&&e===t.split(".")[1]}function lr(e,t,n,r){if(r){const{oid:t,sub:n,tid:i,name:o,tfp:s,acr:a,preferred_username:c,upn:l,login_hint:u}=r,h=i||s||a||"";return{tenantId:h,localAccountId:t||n||"",name:o,username:c||l||"",loginHint:u,isHomeTenant:cr(h,e)}}return{tenantId:n,localAccountId:t,username:"",isHomeTenant:cr(n,e)}}function ur(e,t,n,r){let i=e;if(t){const{isHomeTenant:n,...r}=t;i={...e,...r}}if(n){const{isHomeTenant:t,...o}=lr(e.homeAccountId,e.localAccountId,e.tenantId,n);return i={...i,...o,idTokenClaims:n,idToken:r},i}return i}function hr(e){return e&&(e.tid||e.tfp||e.acr)||null}class dr{static getAccountInfo(e){return{homeAccountId:e.homeAccountId,environment:e.environment,tenantId:e.realm,username:e.username,localAccountId:e.localAccountId,loginHint:e.loginHint,name:e.name,nativeAccountId:e.nativeAccountId,authorityType:e.authorityType,tenantProfiles:new Map((e.tenantProfiles||[]).map(e=>[e.tenantId,e])),dataBoundary:e.dataBoundary}}isSingleTenant(){return!this.tenantProfiles}static createAccount(e,t,n){const r=new dr;let i;1===t.authorityType?r.authorityType="ADFS":t.protocolMode===sn?r.authorityType=q:r.authorityType="MSSTS",e.clientInfo&&n&&(i=sr(e.clientInfo,n),i.xms_tdbr&&(r.dataBoundary="EU"===i.xms_tdbr?"EU":"None")),r.clientInfo=e.clientInfo,r.homeAccountId=e.homeAccountId,r.nativeAccountId=e.nativeAccountId;const o=e.environment||t&&t.getPreferredCache();if(!o)throw Qt(Ot);r.environment=o,r.realm=i?.utid||hr(e.idTokenClaims)||"",r.localAccountId=i?.uid||e.idTokenClaims?.oid||e.idTokenClaims?.sub||"";const s=e.idTokenClaims?.preferred_username||e.idTokenClaims?.upn,a=e.idTokenClaims?.emails?e.idTokenClaims.emails[0]:null;if(r.username=s||a||"",r.loginHint=e.idTokenClaims?.login_hint,r.name=e.idTokenClaims?.name||"",r.cloudGraphHostName=e.cloudGraphHostName,r.msGraphHost=e.msGraphHost,e.tenantProfiles)r.tenantProfiles=e.tenantProfiles;else{const t=lr(e.homeAccountId,r.localAccountId,r.realm,e.idTokenClaims);r.tenantProfiles=[t]}return r}static createFromAccountInfo(e,t,n){const r=new dr;return r.authorityType=e.authorityType||q,r.homeAccountId=e.homeAccountId,r.localAccountId=e.localAccountId,r.nativeAccountId=e.nativeAccountId,r.realm=e.tenantId,r.environment=e.environment,r.username=e.username,r.name=e.name,r.loginHint=e.loginHint,r.cloudGraphHostName=t,r.msGraphHost=n,r.tenantProfiles=Array.from(e.tenantProfiles?.values()||[]),r.dataBoundary=e.dataBoundary,r}static generateHomeAccountId(e,t,n,r,i){if(1!==t&&2!==t){if(e)try{const t=sr(e,r.base64Decode);if(t.uid&&t.utid)return`${t.uid}.${t.utid}`}catch(e){}n.warning("No client info in response")}return i?.sub||""}static isAccountEntity(e){return!!e&&e.hasOwnProperty("homeAccountId")&&e.hasOwnProperty("environment")&&e.hasOwnProperty("realm")&&e.hasOwnProperty("localAccountId")&&e.hasOwnProperty("username")&&e.hasOwnProperty("authorityType")}static accountInfoIsEqual(e,t,n){if(!e||!t)return!1;let r=!0;if(n){const n=e.idTokenClaims||{},i=t.idTokenClaims||{};r=n.iat===i.iat&&n.nonce===i.nonce}return e.homeAccountId===t.homeAccountId&&e.localAccountId===t.localAccountId&&e.username===t.username&&e.tenantId===t.tenantId&&e.loginHint===t.loginHint&&e.environment===t.environment&&e.nativeAccountId===t.nativeAccountId&&r}}const pr="cache_quota_exceeded",gr="cache_error_unknown",fr={[pr]:"Exceeded cache storage capacity.",[gr]:"Unexpected error occurred when using cache storage."};class mr extends fe{constructor(e,t){const n=t||(fr[e]?fr[e]:fr[gr]);super(`${e}: ${n}`),Object.setPrototypeOf(this,mr.prototype),this.name="CacheError",this.errorCode=e,this.errorMessage=n}}class yr{constructor(e,t,n,r,i){this.clientId=e,this.cryptoImpl=t,this.commonLogger=n.clone(rr,ir),this.staticAuthorityOptions=i,this.performanceClient=r}getAllAccounts(e,t){return this.buildTenantProfiles(this.getAccountsFilteredBy(e,t),t,e)}getAccountInfoFilteredBy(e,t){if(0===Object.keys(e).length||Object.values(e).every(e=>!e))return this.commonLogger.warning("getAccountInfoFilteredBy: Account filter is empty or invalid, returning null"),null;const n=this.getAllAccounts(e,t);return n.length>1?n.sort(e=>e.idTokenClaims?-1:1)[0]:1===n.length?n[0]:null}getBaseAccountInfo(e,t){const n=this.getAccountsFilteredBy(e,t);return n.length>0?dr.getAccountInfo(n[0]):null}buildTenantProfiles(e,t,n){return e.flatMap(e=>this.getTenantProfilesFromAccountEntity(e,t,n?.tenantId,n))}getTenantedAccountInfoByFilter(e,t,n,r,i){let o,s=null;if(i&&!this.tenantProfileMatchesFilter(n,i))return null;const a=this.getIdToken(e,r,t,n.tenantId);return a&&(o=Ln(a.secret,this.cryptoImpl.base64Decode),!this.idTokenClaimsMatchTenantProfileFilter(o,i))?null:(s=ur(e,n,o,a?.secret),s)}getTenantProfilesFromAccountEntity(e,t,n,r){const i=dr.getAccountInfo(e);let o=i.tenantProfiles||new Map;const s=this.getTokenKeys();if(n){const e=o.get(n);if(!e)return[];o=new Map([[n,e]])}const a=[];return o.forEach(e=>{const n=this.getTenantedAccountInfoByFilter(i,s,e,t,r);n&&a.push(n)}),a}tenantProfileMatchesFilter(e,t){return!(t.localAccountId&&!this.matchLocalAccountIdFromTenantProfile(e,t.localAccountId)||t.name&&e.name!==t.name||void 0!==t.isHomeTenant&&e.isHomeTenant!==t.isHomeTenant)}idTokenClaimsMatchTenantProfileFilter(e,t){if(t){if(t.localAccountId&&!this.matchLocalAccountIdFromTokenClaims(e,t.localAccountId))return!1;if(t.loginHint&&!this.matchLoginHintFromTokenClaims(e,t.loginHint))return!1;if(t.username&&!this.matchUsername(e.preferred_username,t.username))return!1;if(t.name&&!this.matchName(e,t.name))return!1;if(t.sid&&!this.matchSid(e,t.sid))return!1}return!0}async saveCacheRecord(e,t,n,r){if(!e)throw Qt(Et);try{e.account&&await this.setAccount(e.account,t,n),e.idToken&&!1!==r?.idToken&&await this.setIdTokenCredential(e.idToken,t,n),e.accessToken&&!1!==r?.accessToken&&await this.saveAccessToken(e.accessToken,t,n),e.refreshToken&&!1!==r?.refreshToken&&await this.setRefreshTokenCredential(e.refreshToken,t,n),e.appMetadata&&this.setAppMetadata(e.appMetadata,t)}catch(e){throw this.commonLogger?.error("CacheManager.saveCacheRecord: failed"),e instanceof fe?e:function(e){return e instanceof Error?"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name||e.message.includes("exceeded the quota")?new mr(pr):new mr(e.name,e.message):new mr(gr)}(e)}}async saveAccessToken(e,t,n){const r={clientId:e.clientId,credentialType:e.credentialType,environment:e.environment,homeAccountId:e.homeAccountId,realm:e.realm,tokenType:e.tokenType,requestedClaimsHash:e.requestedClaimsHash},i=this.getTokenKeys(),o=or.fromString(e.target);i.accessToken.forEach(e=>{if(!this.accessTokenKeyMatchesFilter(e,r,!1))return;const n=this.getAccessTokenCredential(e,t);n&&this.credentialMatchesFilter(n,r)&&or.fromString(n.target).intersectingScopeSets(o)&&this.removeAccessToken(e,t)}),await this.setAccessTokenCredential(e,t,n)}getAccountsFilteredBy(e,t){const n=this.getAccountKeys(),r=[];return n.forEach(n=>{const i=this.getAccount(n,t);if(!i)return;if(e.homeAccountId&&!this.matchHomeAccountId(i,e.homeAccountId))return;if(e.username&&!this.matchUsername(i.username,e.username))return;if(e.environment&&!this.matchEnvironment(i,e.environment))return;if(e.realm&&!this.matchRealm(i,e.realm))return;if(e.nativeAccountId&&!this.matchNativeAccountId(i,e.nativeAccountId))return;if(e.authorityType&&!this.matchAuthorityType(i,e.authorityType))return;const o={localAccountId:e?.localAccountId,name:e?.name},s=i.tenantProfiles?.filter(e=>this.tenantProfileMatchesFilter(e,o));s&&0===s.length||r.push(i)}),r}credentialMatchesFilter(e,t){if(t.clientId&&!this.matchClientId(e,t.clientId))return!1;if(t.userAssertionHash&&!this.matchUserAssertionHash(e,t.userAssertionHash))return!1;if("string"==typeof t.homeAccountId&&!this.matchHomeAccountId(e,t.homeAccountId))return!1;if(t.environment&&!this.matchEnvironment(e,t.environment))return!1;if(t.realm&&!this.matchRealm(e,t.realm))return!1;if(t.credentialType&&!this.matchCredentialType(e,t.credentialType))return!1;if(t.familyId&&!this.matchFamilyId(e,t.familyId))return!1;if(t.target&&!this.matchTarget(e,t.target))return!1;if((t.requestedClaimsHash||e.requestedClaimsHash)&&e.requestedClaimsHash!==t.requestedClaimsHash)return!1;if(e.credentialType===x.ACCESS_TOKEN_WITH_AUTH_SCHEME){if(t.tokenType&&!this.matchTokenType(e,t.tokenType))return!1;if(t.tokenType===K.SSH&&t.keyId&&!this.matchKeyId(e,t.keyId))return!1}return!0}getAppMetadataFilteredBy(e){const t=this.getKeys(),n={};return t.forEach(t=>{if(!this.isAppMetadata(t))return;const r=this.getAppMetadata(t);r&&(e.environment&&!this.matchEnvironment(r,e.environment)||e.clientId&&!this.matchClientId(r,e.clientId)||(n[t]=r))}),n}getAuthorityMetadataByAlias(e){const t=this.getAuthorityMetadataKeys();let n=null;return t.forEach(t=>{if(!this.isAuthorityMetadata(t)||-1===t.indexOf(this.clientId))return;const r=this.getAuthorityMetadata(t);r&&-1!==r.aliases.indexOf(e)&&(n=r)}),n}removeAllAccounts(e){this.getAllAccounts({},e).forEach(t=>{this.removeAccount(t,e)})}removeAccount(e,t){this.removeAccountContext(e,t),this.getAccountKeys().filter(t=>t.includes(e.homeAccountId)&&t.includes(e.environment)).forEach(e=>{this.removeItem(e,t),this.performanceClient.incrementFields({accountsRemoved:1},t)})}removeAccountContext(e,t){const n=this.getTokenKeys(),r=t=>t.includes(e.homeAccountId)&&t.includes(e.environment);n.idToken.filter(r).forEach(e=>{this.removeIdToken(e,t)}),n.accessToken.filter(r).forEach(e=>{this.removeAccessToken(e,t)}),n.refreshToken.filter(r).forEach(e=>{this.removeRefreshToken(e,t)})}removeAccessToken(e,t){const n=this.getAccessTokenCredential(e,t);if(this.removeItem(e,t),this.performanceClient.incrementFields({accessTokensRemoved:1},t),!n||n.credentialType.toLowerCase()!==x.ACCESS_TOKEN_WITH_AUTH_SCHEME.toLowerCase()||n.tokenType!==K.POP)return;const r=n.keyId;r&&this.cryptoImpl.removeTokenBindingKey(r).catch(()=>{this.commonLogger.error(`Failed to remove token binding key ${r}`,t),this.performanceClient?.incrementFields({removeTokenBindingKeyFailure:1},t)})}removeAppMetadata(e){return this.getKeys().forEach(t=>{this.isAppMetadata(t)&&this.removeItem(t,e)}),!0}getIdToken(e,t,n,r,i){this.commonLogger.trace("CacheManager - getIdToken called");const o={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:x.ID_TOKEN,clientId:this.clientId,realm:r},s=this.getIdTokensByFilter(o,t,n),a=s.size;if(a<1)return this.commonLogger.info("CacheManager:getIdToken - No token found"),null;if(a>1){let n=s;if(!r){const t=new Map;s.forEach((n,r)=>{n.realm===e.tenantId&&t.set(r,n)});const r=t.size;if(r<1)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account but none match account entity tenant id, returning first result"),s.values().next().value;if(1===r)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account, defaulting to home tenant profile"),t.values().next().value;n=t}return this.commonLogger.info("CacheManager:getIdToken - Multiple matching ID tokens found, clearing them"),n.forEach((e,n)=>{this.removeIdToken(n,t)}),i&&t&&i.addFields({multiMatchedID:s.size},t),null}return this.commonLogger.info("CacheManager:getIdToken - Returning ID token"),s.values().next().value}getIdTokensByFilter(e,t,n){const r=n&&n.idToken||this.getTokenKeys().idToken,i=new Map;return r.forEach(n=>{if(!this.idTokenKeyMatchesFilter(n,{clientId:this.clientId,...e}))return;const r=this.getIdTokenCredential(n,t);r&&this.credentialMatchesFilter(r,e)&&i.set(n,r)}),i}idTokenKeyMatchesFilter(e,t){const n=e.toLowerCase();return!(t.clientId&&-1===n.indexOf(t.clientId.toLowerCase())||t.homeAccountId&&-1===n.indexOf(t.homeAccountId.toLowerCase()))}removeIdToken(e,t){this.removeItem(e,t)}removeRefreshToken(e,t){this.removeItem(e,t)}getAccessToken(e,t,n,r){const i=t.correlationId;this.commonLogger.trace("CacheManager - getAccessToken called",i);const o=or.createSearchScopes(t.scopes),s=t.authenticationScheme||K.BEARER,a=s&&s.toLowerCase()!==K.BEARER.toLowerCase()?x.ACCESS_TOKEN_WITH_AUTH_SCHEME:x.ACCESS_TOKEN,c={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:a,clientId:this.clientId,realm:r||e.tenantId,target:o,tokenType:s,keyId:t.sshKid,requestedClaimsHash:t.requestedClaimsHash},l=n&&n.accessToken||this.getTokenKeys().accessToken,u=[];l.forEach(e=>{if(this.accessTokenKeyMatchesFilter(e,c,!0)){const t=this.getAccessTokenCredential(e,i);t&&this.credentialMatchesFilter(t,c)&&u.push(t)}});const h=u.length;return h<1?(this.commonLogger.info("CacheManager:getAccessToken - No token found",i),null):h>1?(this.commonLogger.info("CacheManager:getAccessToken - Multiple access tokens found, clearing them",i),u.forEach(e=>{this.removeAccessToken(this.generateCredentialKey(e),i)}),this.performanceClient.addFields({multiMatchedAT:u.length},i),null):(this.commonLogger.info("CacheManager:getAccessToken - Returning access token",i),u[0])}accessTokenKeyMatchesFilter(e,t,n){const r=e.toLowerCase();if(t.clientId&&-1===r.indexOf(t.clientId.toLowerCase()))return!1;if(t.homeAccountId&&-1===r.indexOf(t.homeAccountId.toLowerCase()))return!1;if(t.realm&&-1===r.indexOf(t.realm.toLowerCase()))return!1;if(t.requestedClaimsHash&&-1===r.indexOf(t.requestedClaimsHash.toLowerCase()))return!1;if(t.target){const e=t.target.asArray();for(let t=0;t<e.length;t++){if(n&&!r.includes(e[t].toLowerCase()))return!1;if(!n&&r.includes(e[t].toLowerCase()))return!0}}return!0}getAccessTokensByFilter(e,t){const n=this.getTokenKeys(),r=[];return n.accessToken.forEach(n=>{if(!this.accessTokenKeyMatchesFilter(n,e,!0))return;const i=this.getAccessTokenCredential(n,t);i&&this.credentialMatchesFilter(i,e)&&r.push(i)}),r}getRefreshToken(e,t,n,r,i){this.commonLogger.trace("CacheManager - getRefreshToken called");const o=t?H:void 0,s={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:x.REFRESH_TOKEN,clientId:this.clientId,familyId:o},a=r&&r.refreshToken||this.getTokenKeys().refreshToken,c=[];a.forEach(e=>{if(this.refreshTokenKeyMatchesFilter(e,s)){const t=this.getRefreshTokenCredential(e,n);t&&this.credentialMatchesFilter(t,s)&&c.push(t)}});const l=c.length;return l<1?(this.commonLogger.info("CacheManager:getRefreshToken - No refresh token found."),null):(l>1&&i&&n&&i.addFields({multiMatchedRT:l},n),this.commonLogger.info("CacheManager:getRefreshToken - returning refresh token"),c[0])}refreshTokenKeyMatchesFilter(e,t){const n=e.toLowerCase();return!(t.familyId&&-1===n.indexOf(t.familyId.toLowerCase())||!t.familyId&&t.clientId&&-1===n.indexOf(t.clientId.toLowerCase())||t.homeAccountId&&-1===n.indexOf(t.homeAccountId.toLowerCase()))}readAppMetadataFromCache(e){const t={environment:e,clientId:this.clientId},n=this.getAppMetadataFilteredBy(t),r=Object.keys(n).map(e=>n[e]),i=r.length;if(i<1)return null;if(i>1)throw Qt(Tt);return r[0]}isAppMetadataFOCI(e){const t=this.readAppMetadataFromCache(e);return!(!t||t.familyId!==H)}matchHomeAccountId(e,t){return!("string"!=typeof e.homeAccountId||t!==e.homeAccountId)}matchLocalAccountIdFromTokenClaims(e,t){return t===(e.oid||e.sub)}matchLocalAccountIdFromTenantProfile(e,t){return e.localAccountId===t}matchName(e,t){return!(t.toLowerCase()!==e.name?.toLowerCase())}matchUsername(e,t){return!(!e||"string"!=typeof e||t?.toLowerCase()!==e.toLowerCase())}matchUserAssertionHash(e,t){return!(!e.userAssertionHash||t!==e.userAssertionHash)}matchEnvironment(e,t){if(this.staticAuthorityOptions){const n=function(e,t){let n;const r=e.canonicalAuthority;if(r){const i=new Xt(r).getUrlComponents().HostNameAndPort;n=rn(i,e.cloudDiscoveryMetadata?.metadata,L,t)||rn(i,tn.metadata,$,t)||e.knownAuthorities}return n||[]}(this.staticAuthorityOptions,this.commonLogger);if(n.includes(t)&&n.includes(e.environment))return!0}const n=this.getAuthorityMetadataByAlias(t);return!!(n&&n.aliases.indexOf(e.environment)>-1)}matchCredentialType(e,t){return e.credentialType&&t.toLowerCase()===e.credentialType.toLowerCase()}matchClientId(e,t){return!(!e.clientId||t!==e.clientId)}matchFamilyId(e,t){return!(!e.familyId||t!==e.familyId)}matchRealm(e,t){return!(e.realm?.toLowerCase()!==t.toLowerCase())}matchNativeAccountId(e,t){return!(!e.nativeAccountId||t!==e.nativeAccountId)}matchLoginHintFromTokenClaims(e,t){return e.login_hint===t||e.preferred_username===t||e.upn===t}matchSid(e,t){return e.sid===t}matchAuthorityType(e,t){return!(!e.authorityType||t.toLowerCase()!==e.authorityType.toLowerCase())}matchTarget(e,t){return!(e.credentialType!==x.ACCESS_TOKEN&&e.credentialType!==x.ACCESS_TOKEN_WITH_AUTH_SCHEME||!e.target)&&or.fromString(e.target).containsScopeSet(t)}matchTokenType(e,t){return!(!e.tokenType||e.tokenType!==t)}matchKeyId(e,t){return!(!e.keyId||e.keyId!==t)}isAppMetadata(e){return-1!==e.indexOf(U)}isAuthorityMetadata(e){return-1!==e.indexOf(D)}generateAuthorityMetadataCacheKey(e){return`${D}-${this.clientId}-${e}`}static toObject(e,t){for(const n in t)e[n]=t[n];return e}}class Cr extends yr{async setAccount(){throw Qt(zt)}getAccount(){throw Qt(zt)}async setIdTokenCredential(){throw Qt(zt)}getIdTokenCredential(){throw Qt(zt)}async setAccessTokenCredential(){throw Qt(zt)}getAccessTokenCredential(){throw Qt(zt)}async setRefreshTokenCredential(){throw Qt(zt)}getRefreshTokenCredential(){throw Qt(zt)}setAppMetadata(){throw Qt(zt)}getAppMetadata(){throw Qt(zt)}setServerTelemetry(){throw Qt(zt)}getServerTelemetry(){throw Qt(zt)}setAuthorityMetadata(){throw Qt(zt)}getAuthorityMetadata(){throw Qt(zt)}getAuthorityMetadataKeys(){throw Qt(zt)}setThrottlingCache(){throw Qt(zt)}getThrottlingCache(){throw Qt(zt)}removeItem(){throw Qt(zt)}getKeys(){throw Qt(zt)}getAccountKeys(){throw Qt(zt)}getTokenKeys(){throw Qt(zt)}generateCredentialKey(){throw Qt(zt)}generateAccountKey(){throw Qt(zt)}}class Tr{startMeasurement(){}endMeasurement(){}flushMeasurement(){return null}}class Ar{generateId(){return"callback-id"}startMeasurement(e,t){return{end:()=>null,discard:()=>{},add:()=>{},increment:()=>{},event:{eventId:this.generateId(),status:Un,authority:"",libraryName:"",libraryVersion:"",clientId:"",name:e,startTimeMs:Date.now(),correlationId:t||""},measurement:new Tr}}startPerformanceMeasurement(){return new Tr}calculateQueuedTime(){return 0}addQueueMeasurement(){}setPreQueueTime(){}endMeasurement(){return null}discardMeasurements(){}removePerformanceCallback(){return!0}addPerformanceCallback(){return""}emitEvents(){}addFields(){}incrementFields(){}cacheEventByCorrelationId(){}}const wr={tokenRenewalOffsetSeconds:300,preventCorsPreflight:!1},kr={loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:Ee.Info,correlationId:k.EMPTY_STRING},Ir={claimsBasedCachingEnabled:!1},vr={async sendGetRequestAsync(){throw Qt(zt)},async sendPostRequestAsync(){throw Qt(zt)}},br={sku:k.SKU,version:ir,cpu:k.EMPTY_STRING,os:k.EMPTY_STRING},Sr={clientSecret:k.EMPTY_STRING,clientAssertion:void 0},_r={azureCloudInstance:an,tenant:`${k.DEFAULT_COMMON_TENANT}`},Er={application:{appName:"",appVersion:""}};function Or(e){return e.authOptions.authority.options.protocolMode===sn}const Rr="home_account_id",Pr="UPN";function Mr(e,t,n){if(!t)return;const r=e.get(Ce);r&&e.has(ve)&&n?.addFields({embeddedClientId:r,embeddedRedirectUri:e.get(Te)},t)}function Nr(e,t){e.set("response_type",t)}function qr(e,t,n=!0,r=I){!n||r.includes("openid")||t.includes("openid")||r.push("openid");const i=n?[...t||[],...r]:t||[],o=new or(i);e.set("scope",o.printScopes())}function xr(e,t){e.set(Ce,t)}function Ur(e,t){e.set(Te,t)}function Hr(e,t){e.set("login_hint",t)}function Dr(e,t){e.set(_,`UPN:${t}`)}function Lr(e,t){e.set(_,`Oid:${t.uid}@${t.utid}`)}function Br(e,t){e.set("sid",t)}function Fr(e,t,n){const r=function(e,t){let n;if(e)try{n=JSON.parse(e)}catch(e){throw tt(Ue)}else n={};return t&&t.length>0&&(n.hasOwnProperty(P)||(n[P]={}),n[P].xms_cc={values:t}),JSON.stringify(n)}(t,n);try{JSON.parse(r)}catch(e){throw tt(Ue)}e.set("claims",r)}function $r(e,t){e.set("client-request-id",t)}function jr(e,t){e.set("x-client-SKU",t.sku),e.set("x-client-VER",t.version),t.os&&e.set("x-client-OS",t.os),t.cpu&&e.set("x-client-CPU",t.cpu)}function Kr(e,t){t?.appName&&e.set("x-app-name",t.appName),t?.appVersion&&e.set("x-app-ver",t.appVersion)}function zr(e,t){t&&e.set("state",t)}function Gr(e,t){e.set("client_secret",t)}function Vr(e,t){t&&e.set("client_assertion",t)}function Yr(e,t){t&&e.set("client_assertion_type",t)}function Wr(e,t){e.set("grant_type",t)}function Qr(e){e.set("client_info","1")}function Jr(e){e.has(Se)||e.set(Se,"true")}function Zr(e,t){Object.entries(t).forEach(([t,n])=>{!e.has(t)&&n&&e.set(t,n)})}function Xr(e,t){t&&(e.set(Ae,K.POP),e.set(we,t))}function ei(e,t){t&&(e.set(Ae,K.SSH),e.set(we,t))}function ti(e,t){e.set("x-client-current-telemetry",t.generateCurrentRequestHeaderValue()),e.set("x-client-last-telemetry",t.generateLastRequestHeaderValue())}function ni(e){e.set("x-ms-lib-capability","retry-after, h429")}function ri(e,t,n){e.has(ve)||e.set(ve,t),e.has(be)||e.set(be,n)}async function ii(e,t,n,r,i,o,s){s?.addQueueMeasurement(bn,o);const a=er.transformCIAMAuthority(tr(e)),c=new er(a,t,n,r,i,o,s);try{return await Hn(c.resolveEndpointsAsync.bind(c),Sn,i,s,o)(),c}catch(e){throw Qt(at)}}function oi(e,t,n){return{clientId:e,authority:t.authority,scopes:t.scopes,homeAccountIdentifier:n,claims:t.claims,authenticationScheme:t.authenticationScheme,resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,sshKid:t.sshKid,embeddedClientId:t.embeddedClientId||t.tokenBodyParameters?.clientId}}class si{static generateThrottlingStorageKey(e){return`${z}.${JSON.stringify(e)}`}static preProcess(e,t,n){const r=si.generateThrottlingStorageKey(t),i=e.getThrottlingCache(r);if(i){if(i.throttleTime<Date.now())return void e.removeItem(r,n);throw new _e(i.errorCodes?.join(" ")||k.EMPTY_STRING,i.errorMessage,i.subError)}}static postProcess(e,t,n,r){if(si.checkResponseStatus(n)||si.checkResponseForRetryAfter(n)){const i={throttleTime:si.calculateThrottleTime(parseInt(n.headers[S])),error:n.body.error,errorCodes:n.body.error_codes,errorMessage:n.body.error_description,subError:n.body.suberror};e.setThrottlingCache(si.generateThrottlingStorageKey(t),i,r)}}static checkResponseStatus(e){return 429===e.status||e.status>=500&&e.status<600}static checkResponseForRetryAfter(e){return!!e.headers&&e.headers.hasOwnProperty(S)&&(e.status<200||e.status>=300)}static calculateThrottleTime(e){const t=e<=0?0:e,n=Date.now()/1e3;return Math.floor(1e3*Math.min(n+(t||60),n+3600))}static removeThrottle(e,t,n,r){const i=oi(t,n,r),o=this.generateThrottlingStorageKey(i);e.removeItem(o,n.correlationId)}}class ai extends fe{constructor(e,t,n){super(e.errorCode,e.errorMessage,e.subError),Object.setPrototypeOf(this,ai.prototype),this.name="NetworkError",this.error=e,this.httpStatus=t,this.responseHeaders=n}}class ci{constructor(e,t){this.config=function({authOptions:e,systemOptions:t,loggerOptions:n,cacheOptions:r,storageInterface:i,networkInterface:o,cryptoInterface:s,clientCredentials:a,libraryInfo:c,telemetry:l,serverTelemetryManager:u,persistencePlugin:h,serializableCache:d}){const p={...kr,...n};return{authOptions:(g=e,{clientCapabilities:[],azureCloudOptions:_r,skipAuthorityMetadataCache:!1,instanceAware:!1,encodeExtraQueryParams:!1,...g}),systemOptions:{...wr,...t},loggerOptions:p,cacheOptions:{...Ir,...r},storageInterface:i||new Cr(e.clientId,nr,new Oe(p),new Ar),networkInterface:o||vr,cryptoInterface:s||nr,clientCredentials:a||Sr,libraryInfo:{...br,...c},telemetry:{...Er,...l},serverTelemetryManager:u||null,persistencePlugin:h||null,serializableCache:d||null};var g}(e),this.logger=new Oe(this.config.loggerOptions,rr,ir),this.cryptoUtils=this.config.cryptoInterface,this.cacheManager=this.config.storageInterface,this.networkClient=this.config.networkInterface,this.serverTelemetryManager=this.config.serverTelemetryManager,this.authority=this.config.authOptions.authority,this.performanceClient=t}createTokenRequestHeaders(e){const t={};if(t[b]=k.URL_FORM_CONTENT_TYPE,!this.config.systemOptions.preventCorsPreflight&&e)switch(e.type){case Rr:try{const n=ar(e.credential);t[_]=`Oid:${n.uid}@${n.utid}`}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case Pr:t[_]=`UPN: ${e.credential}`}return t}async executePostToTokenEndpoint(e,t,n,r,i,o){o&&this.performanceClient?.addQueueMeasurement(o,i);const s=await this.sendPostRequest(r,e,{body:t,headers:n},i);return this.config.serverTelemetryManager&&s.status<500&&429!==s.status&&this.config.serverTelemetryManager.clearTelemetryCache(),s}async sendPostRequest(e,t,n,r){let i;si.preProcess(this.cacheManager,e,r);try{i=await Hn(this.networkClient.sendPostRequestAsync.bind(this.networkClient),cn,this.logger,this.performanceClient,r)(t,n);const e=i.headers||{};this.performanceClient?.addFields({refreshTokenSize:i.body.refresh_token?.length||0,httpVerToken:e[O]||"",requestId:e[E]||""},r)}catch(e){if(e instanceof ai){const t=e.responseHeaders;throw t&&this.performanceClient?.addFields({httpVerToken:t[O]||"",requestId:t[E]||"",contentTypeHeader:t[b]||void 0,contentLengthHeader:t["Content-Length"]||void 0,httpStatus:e.httpStatus},r),e.error}throw e instanceof fe?e:Qt(ct)}return si.postProcess(this.cacheManager,e,i,r),i}async updateAuthority(e,t){this.performanceClient?.addQueueMeasurement(Cn,t);const n=`https://${e}/${this.authority.tenant}/`,r=await ii(n,this.networkClient,this.cacheManager,this.authority.options,this.logger,t,this.performanceClient);this.authority=r}createTokenQueryParameters(e){const t=new Map;return e.embeddedClientId&&ri(t,this.config.authOptions.clientId,this.config.authOptions.redirectUri),e.tokenQueryParameters&&Zr(t,e.tokenQueryParameters),$r(t,e.correlationId),Mr(t,e.correlationId,this.performanceClient),Zt(t)}}const li="no_tokens_found",ui="native_account_unavailable",hi="refresh_token_expired",di="ux_not_allowed",pi="bad_token",gi=["interaction_required","consent_required","login_required",pi,di],fi=["message_only","additional_action","basic_action","user_password_expired","consent_required","bad_token"],mi={[li]:"No refresh token found in the cache. Please sign-in.",[ui]:"The requested account is not available in the native broker. It may have been deleted or logged out. Please sign-in again using an interactive API.",[hi]:"Refresh token has expired.",[pi]:"Identity provider returned bad_token due to an expired or invalid refresh token. Please invoke an interactive API to resolve.",[di]:"`canShowUI` flag in Edge was set to false. User interaction required on web page. Please invoke an interactive API to resolve."};class yi extends fe{constructor(e,t,n,r,i,o,s,a){super(e,t,n),Object.setPrototypeOf(this,yi.prototype),this.timestamp=r||k.EMPTY_STRING,this.traceId=i||k.EMPTY_STRING,this.correlationId=o||k.EMPTY_STRING,this.claims=s||k.EMPTY_STRING,this.name="InteractionRequiredAuthError",this.errorNo=a}}function Ci(e){return new yi(e,mi[e])}class Ti{static setRequestState(e,t,n){const r=Ti.generateLibraryState(e,n);return t?`${r}${k.RESOURCE_DELIM}${t}`:r}static generateLibraryState(e,t){if(!e)throw Qt(Pt);const n={id:e.createNewGuid()};t&&(n.meta=t);const r=JSON.stringify(n);return e.base64Encode(r)}static parseRequestState(e,t){if(!e)throw Qt(Pt);if(!t)throw Qt(ht);try{const n=t.split(k.RESOURCE_DELIM),r=n[0],i=n.length>1?n.slice(1).join(k.RESOURCE_DELIM):k.EMPTY_STRING,o=e.base64Decode(r),s=JSON.parse(o);return{userRequestState:i||k.EMPTY_STRING,libraryState:s}}catch(e){throw Qt(ht)}}}class Ai{constructor(e,t){this.cryptoUtils=e,this.performanceClient=t}async generateCnf(e,t){this.performanceClient?.addQueueMeasurement(kn,e.correlationId);const n=await Hn(this.generateKid.bind(this),kn,t,this.performanceClient,e.correlationId)(e),r=this.cryptoUtils.base64UrlEncode(JSON.stringify(n));return{kid:n.kid,reqCnfString:r}}async generateKid(e){return this.performanceClient?.addQueueMeasurement(In,e.correlationId),{kid:await this.cryptoUtils.getPublicKeyThumbprint(e),xms_ksl:"sw"}}async signPopToken(e,t,n){return this.signPayload(e,t,n)}async signPayload(e,t,n,r){const{resourceRequestMethod:i,resourceRequestUri:o,shrClaims:s,shrNonce:a,shrOptions:c}=n,l=o?new Xt(o):void 0,u=l?.getUrlComponents();return this.cryptoUtils.signJwt({at:e,ts:Fn(),m:i?.toUpperCase(),u:u?.HostNameAndPort,nonce:a||this.cryptoUtils.createNewGuid(),p:u?.AbsolutePath,q:u?.QueryString?[[],u.QueryString]:void 0,client_claims:s||void 0,...r},t,c,n.correlationId)}}class wi{constructor(e,t){this.cache=e,this.hasChanged=t}get cacheHasChanged(){return this.hasChanged}get tokenCache(){return this.cache}}class ki{constructor(e,t,n,r,i,o,s){this.clientId=e,this.cacheStorage=t,this.cryptoObj=n,this.logger=r,this.serializableCache=i,this.persistencePlugin=o,this.performanceClient=s}validateTokenResponse(e,t){if(e.error||e.error_description||e.suberror){const n=`Error(s): ${e.error_codes||k.NOT_AVAILABLE} - Timestamp: ${e.timestamp||k.NOT_AVAILABLE} - Description: ${e.error_description||k.NOT_AVAILABLE} - Correlation ID: ${e.correlation_id||k.NOT_AVAILABLE} - Trace ID: ${e.trace_id||k.NOT_AVAILABLE}`,r=e.error_codes?.length?e.error_codes[0]:void 0,i=new _e(e.error,n,e.suberror,r,e.status);if(t&&e.status&&e.status>=500&&e.status<=599)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently unavailable and the access token is unable to be refreshed.\n${i}`);if(t&&e.status&&e.status>=400&&e.status<=499)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently available but is unable to refresh the access token.\n${i}`);if(function(e,t,n){const r=!!e&&gi.indexOf(e)>-1,i=!!n&&fi.indexOf(n)>-1,o=!!t&&gi.some(e=>t.indexOf(e)>-1);return r||o||i}(e.error,e.error_description,e.suberror))throw new yi(e.error,e.error_description,e.suberror,e.timestamp||k.EMPTY_STRING,e.trace_id||k.EMPTY_STRING,e.correlation_id||k.EMPTY_STRING,e.claims||k.EMPTY_STRING,r);throw i}}async handleServerTokenResponse(e,t,n,r,i,o,s,a,c){let l,u;if(this.performanceClient?.addQueueMeasurement(vn,e.correlation_id),e.id_token){if(l=Ln(e.id_token||k.EMPTY_STRING,this.cryptoObj.base64Decode),i&&i.nonce&&l.nonce!==i.nonce)throw Qt(gt);if(r.maxAge||0===r.maxAge){const e=l.auth_time;if(!e)throw Qt(ft);Bn(e,r.maxAge)}}this.homeAccountIdentifier=dr.generateHomeAccountId(e.client_info||k.EMPTY_STRING,t.authorityType,this.logger,this.cryptoObj,l),i&&i.state&&(u=Ti.parseRequestState(this.cryptoObj,i.state)),e.key_id=e.key_id||r.sshKid||void 0;const h=this.generateCacheRecord(e,t,n,r,l,o,i);let d;try{if(this.persistencePlugin&&this.serializableCache&&(this.logger.verbose("Persistence enabled, calling beforeCacheAccess"),d=new wi(this.serializableCache,!0),await this.persistencePlugin.beforeCacheAccess(d)),s&&!a&&h.account){const e=this.cacheStorage.generateAccountKey(dr.getAccountInfo(h.account));if(!this.cacheStorage.getAccount(e,r.correlationId))return this.logger.warning("Account used to refresh tokens not in persistence, refreshed tokens will not be stored in the cache"),await ki.generateAuthenticationResult(this.cryptoObj,t,h,!1,r,l,u,void 0,c)}await this.cacheStorage.saveCacheRecord(h,r.correlationId,function(e){if(!e.signin_state)return!1;const t=["kmsi","dvc_dmjd"];return e.signin_state.some(e=>t.includes(e.trim().toLowerCase()))}(l||{}),r.storeInCache)}finally{this.persistencePlugin&&this.serializableCache&&d&&(this.logger.verbose("Persistence enabled, calling afterCacheAccess"),await this.persistencePlugin.afterCacheAccess(d))}return ki.generateAuthenticationResult(this.cryptoObj,t,h,!1,r,l,u,e,c)}generateCacheRecord(e,t,n,r,i,o,s){const a=t.getPreferredCache();if(!a)throw Qt(Ot);const c=hr(i);let l,u;var h,d,p,g,f;e.id_token&&i&&(h=this.homeAccountIdentifier,d=a,p=e.id_token,g=this.clientId,f=c||"",l={credentialType:x.ID_TOKEN,homeAccountId:h,environment:d,clientId:g,secret:p,realm:f,lastUpdatedAt:Date.now().toString()},u=function(e,t,n,r,i,o,s,a,c,l,u,h){h?.verbose("setCachedAccount called");const d=e.getAccountKeys().find(e=>e.startsWith(n));let p=null;d&&(p=e.getAccount(d,i));const g=p||dr.createAccount({homeAccountId:n,idTokenClaims:o,clientInfo:s,environment:a,cloudGraphHostName:l?.cloud_graph_host_name,msGraphHost:l?.msgraph_host,nativeAccountId:void 0},t,r),f=g.tenantProfiles||[],m=c||g.realm;if(m&&!f.find(e=>e.tenantId===m)){const e=lr(n,g.localAccountId,m,o);f.push(e)}return g.tenantProfiles=f,g}(this.cacheStorage,t,this.homeAccountIdentifier,this.cryptoObj.base64Decode,r.correlationId,i,e.client_info,a,c,s,0,this.logger));let m=null;if(e.access_token){const i=e.scope?or.fromString(e.scope):new or(r.scopes||[]),s=("string"==typeof e.expires_in?parseInt(e.expires_in,10):e.expires_in)||0,l=("string"==typeof e.ext_expires_in?parseInt(e.ext_expires_in,10):e.ext_expires_in)||0,u=("string"==typeof e.refresh_in?parseInt(e.refresh_in,10):e.refresh_in)||void 0,h=n+s,d=h+l,p=u&&u>0?n+u:void 0;m=function(e,t,n,r,i,o,s,a,c,l,u,h,d,p,g){const f={homeAccountId:e,credentialType:x.ACCESS_TOKEN,secret:n,cachedAt:Fn().toString(),expiresOn:s.toString(),extendedExpiresOn:a.toString(),environment:t,clientId:r,realm:i,target:o,tokenType:u||K.BEARER,lastUpdatedAt:Date.now().toString()};if(h&&(f.userAssertionHash=h),l&&(f.refreshOn=l.toString()),p&&(f.requestedClaims=p,f.requestedClaimsHash=g),f.tokenType?.toLowerCase()!==K.BEARER.toLowerCase())switch(f.credentialType=x.ACCESS_TOKEN_WITH_AUTH_SCHEME,f.tokenType){case K.POP:const e=Ln(n,c);if(!e?.cnf?.kid)throw Qt(Ht);f.keyId=e.cnf.kid;break;case K.SSH:f.keyId=d}return f}(this.homeAccountIdentifier,a,e.access_token,this.clientId,c||t.tenant||"",i.printScopes(),h,d,this.cryptoObj.base64Decode,p,e.token_type,o,e.key_id,r.claims,r.requestedClaimsHash)}let y=null;if(e.refresh_token){let t;e.refresh_token_expires_in&&(t=n+("string"==typeof e.refresh_token_expires_in?parseInt(e.refresh_token_expires_in,10):e.refresh_token_expires_in)),y=function(e,t,n,r,i,o,s){const a={credentialType:x.REFRESH_TOKEN,homeAccountId:e,environment:t,clientId:r,secret:n,lastUpdatedAt:Date.now().toString()};return o&&(a.userAssertionHash=o),i&&(a.familyId=i),s&&(a.expiresOn=s.toString()),a}(this.homeAccountIdentifier,a,e.refresh_token,this.clientId,e.foci,o,t)}let C=null;return e.foci&&(C={clientId:this.clientId,environment:a,familyId:e.foci}),{account:u,idToken:l,accessToken:m,refreshToken:y,appMetadata:C}}static async generateAuthenticationResult(e,t,n,r,i,o,s,a,c){let l,u,h=k.EMPTY_STRING,d=[],p=null,g=k.EMPTY_STRING;if(n.accessToken){if(n.accessToken.tokenType!==K.POP||i.popKid)h=n.accessToken.secret;else{const t=new Ai(e),{secret:r,keyId:o}=n.accessToken;if(!o)throw Qt(Ft);h=await t.signPopToken(r,o,i)}d=or.fromString(n.accessToken.target).asArray(),p=$n(n.accessToken.expiresOn),l=$n(n.accessToken.extendedExpiresOn),n.accessToken.refreshOn&&(u=$n(n.accessToken.refreshOn))}n.appMetadata&&(g=n.appMetadata.familyId===H?H:"");const f=o?.oid||o?.sub||"",m=o?.tid||"";a?.spa_accountid&&n.account&&(n.account.nativeAccountId=a?.spa_accountid);const y=n.account?ur(dr.getAccountInfo(n.account),void 0,o,n.idToken?.secret):null;return{authority:t.canonicalAuthority,uniqueId:f,tenantId:m,scopes:d,account:y,idToken:n?.idToken?.secret||"",idTokenClaims:o||{},accessToken:h,fromCache:r,expiresOn:p,extExpiresOn:l,refreshOn:u,correlationId:i.correlationId,requestId:c||k.EMPTY_STRING,familyId:g,tokenType:n.accessToken?.tokenType||k.EMPTY_STRING,state:s?s.userRequestState:k.EMPTY_STRING,cloudGraphHostName:n.account?.cloudGraphHostName||k.EMPTY_STRING,msGraphHost:n.account?.msGraphHost||k.EMPTY_STRING,code:a?.spa_code,fromNativeBroker:!1}}}async function Ii(e,t,n){return"string"==typeof e?e:e({clientId:t,tokenEndpoint:n})}class vi extends ci{constructor(e,t){super(e,t),this.includeRedirectUri=!0,this.oidcDefaultScopes=this.config.authOptions.authority.options.OIDCOptions?.defaultScopes}async acquireToken(e,t){if(this.performanceClient?.addQueueMeasurement(Tn,e.correlationId),!e.code)throw Qt(At);const n=Fn(),r=await Hn(this.executeTokenRequest.bind(this),An,this.logger,this.performanceClient,e.correlationId)(this.authority,e),i=r.headers?.[E],o=new ki(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin,this.performanceClient);return o.validateTokenResponse(r.body),Hn(o.handleServerTokenResponse.bind(o),vn,this.logger,this.performanceClient,e.correlationId)(r.body,this.authority,n,e,t,void 0,void 0,void 0,i)}getLogoutUri(e){if(!e)throw tt(De);const t=this.createLogoutUrlQueryString(e);return Xt.appendQueryString(this.authority.endSessionEndpoint,t)}async executeTokenRequest(e,t){this.performanceClient?.addQueueMeasurement(An,t.correlationId);const n=this.createTokenQueryParameters(t),r=Xt.appendQueryString(e.tokenEndpoint,n),i=await Hn(this.createTokenRequestBody.bind(this),wn,this.logger,this.performanceClient,t.correlationId)(t);let o;if(t.clientInfo)try{const e=sr(t.clientInfo,this.cryptoUtils.base64Decode);o={credential:`${e.uid}.${e.utid}`,type:Rr}}catch(e){this.logger.verbose("Could not parse client info for CCS Header: "+e)}const s=this.createTokenRequestHeaders(o||t.ccsCredential),a=oi(this.config.authOptions.clientId,t);return Hn(this.executePostToTokenEndpoint.bind(this),un,this.logger,this.performanceClient,t.correlationId)(r,i,s,a,t.correlationId,un)}async createTokenRequestBody(e){this.performanceClient?.addQueueMeasurement(wn,e.correlationId);const t=new Map;if(xr(t,e.embeddedClientId||e.tokenBodyParameters?.[Ce]||this.config.authOptions.clientId),this.includeRedirectUri)Ur(t,e.redirectUri);else if(!e.redirectUri)throw tt(Re);if(qr(t,e.scopes,!0,this.oidcDefaultScopes),function(e,t){e.set("code",t)}(t,e.code),jr(t,this.config.libraryInfo),Kr(t,this.config.telemetry.application),ni(t),this.serverTelemetryManager&&!Or(this.config)&&ti(t,this.serverTelemetryManager),e.codeVerifier&&function(e,t){e.set("code_verifier",t)}(t,e.codeVerifier),this.config.clientCredentials.clientSecret&&Gr(t,this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){const n=this.config.clientCredentials.clientAssertion;Vr(t,await Ii(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),Yr(t,n.assertionType)}if(Wr(t,"authorization_code"),Qr(t),e.authenticationScheme===K.POP){const n=new Ai(this.cryptoUtils,this.performanceClient);let r;r=e.popKid?this.cryptoUtils.encodeKid(e.popKid):(await Hn(n.generateCnf.bind(n),kn,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString,Xr(t,r)}else if(e.authenticationScheme===K.SSH){if(!e.sshJwk)throw tt(Ke);ei(t,e.sshJwk)}let n;if((!nt.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&Fr(t,e.claims,this.config.authOptions.clientCapabilities),e.clientInfo)try{const t=sr(e.clientInfo,this.cryptoUtils.base64Decode);n={credential:`${t.uid}.${t.utid}`,type:Rr}}catch(e){this.logger.verbose("Could not parse client info for CCS Header: "+e)}else n=e.ccsCredential;if(this.config.systemOptions.preventCorsPreflight&&n)switch(n.type){case Rr:try{Lr(t,ar(n.credential))}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case Pr:Dr(t,n.credential)}return e.embeddedClientId&&ri(t,this.config.authOptions.clientId,this.config.authOptions.redirectUri),e.tokenBodyParameters&&Zr(t,e.tokenBodyParameters),!e.enableSpaAuthorizationCode||e.tokenBodyParameters&&e.tokenBodyParameters[ke]||Zr(t,{[ke]:"1"}),Mr(t,e.correlationId,this.performanceClient),Zt(t)}createLogoutUrlQueryString(e){const t=new Map;return e.postLogoutRedirectUri&&function(e,t){e.set("post_logout_redirect_uri",t)}(t,e.postLogoutRedirectUri),e.correlationId&&$r(t,e.correlationId),e.idTokenHint&&function(e,t){e.set("id_token_hint",t)}(t,e.idTokenHint),e.state&&zr(t,e.state),e.logoutHint&&function(e,t){e.set("logout_hint",t)}(t,e.logoutHint),e.extraQueryParameters&&Zr(t,e.extraQueryParameters),this.config.authOptions.instanceAware&&Jr(t),Zt(t,this.config.authOptions.encodeExtraQueryParams,e.extraQueryParameters)}}class bi extends ci{constructor(e,t){super(e,t)}async acquireToken(e){this.performanceClient?.addQueueMeasurement(dn,e.correlationId);const t=Fn(),n=await Hn(this.executeTokenRequest.bind(this),hn,this.logger,this.performanceClient,e.correlationId)(e,this.authority),r=n.headers?.[E],i=new ki(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return i.validateTokenResponse(n.body),Hn(i.handleServerTokenResponse.bind(i),vn,this.logger,this.performanceClient,e.correlationId)(n.body,this.authority,t,e,void 0,void 0,!0,e.forceCache,r)}async acquireTokenByRefreshToken(e){if(!e)throw tt(He);if(this.performanceClient?.addQueueMeasurement(gn,e.correlationId),!e.account)throw Qt(_t);if(this.cacheManager.isAppMetadataFOCI(e.account.environment))try{return await Hn(this.acquireTokenWithCachedRefreshToken.bind(this),pn,this.logger,this.performanceClient,e.correlationId)(e,!0)}catch(t){const n=t instanceof yi&&t.errorCode===li,r=t instanceof _e&&"invalid_grant"===t.errorCode&&"client_mismatch"===t.subError;if(n||r)return Hn(this.acquireTokenWithCachedRefreshToken.bind(this),pn,this.logger,this.performanceClient,e.correlationId)(e,!1);throw t}return Hn(this.acquireTokenWithCachedRefreshToken.bind(this),pn,this.logger,this.performanceClient,e.correlationId)(e,!1)}async acquireTokenWithCachedRefreshToken(e,t){this.performanceClient?.addQueueMeasurement(pn,e.correlationId);const n=((e,t,n,r,i)=>(...o)=>{n.trace(`Executing function ${t}`);const s=r?.startMeasurement(t,i);if(i){const e=t+"CallCount";r?.incrementFields({[e]:1},i)}try{const r=e(...o);return s?.end({success:!0}),n.trace(`Returning result from ${t}`),r}catch(e){n.trace(`Error occurred in ${t}`);try{n.trace(JSON.stringify(e))}catch(e){n.trace("Unable to print error message.")}throw s?.end({success:!1},e),e}})(this.cacheManager.getRefreshToken.bind(this.cacheManager),xn,this.logger,this.performanceClient,e.correlationId)(e.account,t,e.correlationId,void 0,this.performanceClient);if(!n)throw Ci(li);if(n.expiresOn&&jn(n.expiresOn,e.refreshTokenExpirationOffsetSeconds||300))throw this.performanceClient?.addFields({rtExpiresOnMs:Number(n.expiresOn)},e.correlationId),Ci(hi);const r={...e,refreshToken:n.secret,authenticationScheme:e.authenticationScheme||K.BEARER,ccsCredential:{credential:e.account.homeAccountId,type:Rr}};try{return await Hn(this.acquireToken.bind(this),dn,this.logger,this.performanceClient,e.correlationId)(r)}catch(t){if(t instanceof yi&&(this.performanceClient?.addFields({rtExpiresOnMs:Number(n.expiresOn)},e.correlationId),t.subError===pi)){this.logger.verbose("acquireTokenWithRefreshToken: bad refresh token, removing from cache");const t=this.cacheManager.generateCredentialKey(n);this.cacheManager.removeRefreshToken(t,e.correlationId)}throw t}}async executeTokenRequest(e,t){this.performanceClient?.addQueueMeasurement(hn,e.correlationId);const n=this.createTokenQueryParameters(e),r=Xt.appendQueryString(t.tokenEndpoint,n),i=await Hn(this.createTokenRequestBody.bind(this),fn,this.logger,this.performanceClient,e.correlationId)(e),o=this.createTokenRequestHeaders(e.ccsCredential),s=oi(this.config.authOptions.clientId,e);return Hn(this.executePostToTokenEndpoint.bind(this),ln,this.logger,this.performanceClient,e.correlationId)(r,i,o,s,e.correlationId,ln)}async createTokenRequestBody(e){this.performanceClient?.addQueueMeasurement(fn,e.correlationId);const t=new Map;if(xr(t,e.embeddedClientId||e.tokenBodyParameters?.[Ce]||this.config.authOptions.clientId),e.redirectUri&&Ur(t,e.redirectUri),qr(t,e.scopes,!0,this.config.authOptions.authority.options.OIDCOptions?.defaultScopes),Wr(t,"refresh_token"),Qr(t),jr(t,this.config.libraryInfo),Kr(t,this.config.telemetry.application),ni(t),this.serverTelemetryManager&&!Or(this.config)&&ti(t,this.serverTelemetryManager),function(e,t){e.set("refresh_token",t)}(t,e.refreshToken),this.config.clientCredentials.clientSecret&&Gr(t,this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){const n=this.config.clientCredentials.clientAssertion;Vr(t,await Ii(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),Yr(t,n.assertionType)}if(e.authenticationScheme===K.POP){const n=new Ai(this.cryptoUtils,this.performanceClient);let r;r=e.popKid?this.cryptoUtils.encodeKid(e.popKid):(await Hn(n.generateCnf.bind(n),kn,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString,Xr(t,r)}else if(e.authenticationScheme===K.SSH){if(!e.sshJwk)throw tt(Ke);ei(t,e.sshJwk)}if((!nt.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&Fr(t,e.claims,this.config.authOptions.clientCapabilities),this.config.systemOptions.preventCorsPreflight&&e.ccsCredential)switch(e.ccsCredential.type){case Rr:try{Lr(t,ar(e.ccsCredential.credential))}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case Pr:Dr(t,e.ccsCredential.credential)}return e.embeddedClientId&&ri(t,this.config.authOptions.clientId,this.config.authOptions.redirectUri),e.tokenBodyParameters&&Zr(t,e.tokenBodyParameters),Mr(t,e.correlationId,this.performanceClient),Zt(t)}}class Si extends ci{constructor(e,t){super(e,t)}async acquireCachedToken(e){this.performanceClient?.addQueueMeasurement(mn,e.correlationId);let t=G;if(e.forceRefresh||!this.config.cacheOptions.claimsBasedCachingEnabled&&!nt.isEmptyObj(e.claims))throw this.setCacheOutcome("1",e.correlationId),Qt(xt);if(!e.account)throw Qt(_t);const n=e.account.tenantId||function(e){const t=new Xt(e).getUrlComponents(),n=t.PathSegments.slice(-1)[0]?.toLowerCase();switch(n){case R.COMMON:case R.ORGANIZATIONS:case R.CONSUMERS:return;default:return n}}(e.authority),r=this.cacheManager.getTokenKeys(),i=this.cacheManager.getAccessToken(e.account,e,r,n);if(!i)throw this.setCacheOutcome(V,e.correlationId),Qt(xt);if(o=i.cachedAt,Number(o)>Fn()||jn(i.expiresOn,this.config.systemOptions.tokenRenewalOffsetSeconds))throw this.setCacheOutcome(Y,e.correlationId),Qt(xt);var o;i.refreshOn&&jn(i.refreshOn,0)&&(t=W);const s=e.authority||this.authority.getPreferredCache(),a={account:this.cacheManager.getAccount(this.cacheManager.generateAccountKey(e.account),e.correlationId),accessToken:i,idToken:this.cacheManager.getIdToken(e.account,e.correlationId,r,n,this.performanceClient),refreshToken:null,appMetadata:this.cacheManager.readAppMetadataFromCache(s)};return this.setCacheOutcome(t,e.correlationId),this.config.serverTelemetryManager&&this.config.serverTelemetryManager.incrementCacheHits(),[await Hn(this.generateResultFromCacheRecord.bind(this),yn,this.logger,this.performanceClient,e.correlationId)(a,e),t]}setCacheOutcome(e,t){this.serverTelemetryManager?.setCacheOutcome(e),this.performanceClient?.addFields({cacheOutcome:e},t),e!==G&&this.logger.info(`Token refresh is required due to cache outcome: ${e}`)}async generateResultFromCacheRecord(e,t){let n;if(this.performanceClient?.addQueueMeasurement(yn,t.correlationId),e.idToken&&(n=Ln(e.idToken.secret,this.config.cryptoInterface.base64Decode)),t.maxAge||0===t.maxAge){const e=n?.auth_time;if(!e)throw Qt(ft);Bn(e,t.maxAge)}return ki.generateAuthenticationResult(this.cryptoUtils,this.authority,e,!0,t,n)}}class _i{static getNetworkResponse(e,t,n){return{headers:e,body:t,status:n}}static urlToHttpOptions(e){const t={protocol:e.protocol,hostname:e.hostname&&e.hostname.startsWith("[")?e.hostname.slice(1,-1):e.hostname,hash:e.hash,search:e.search,pathname:e.pathname,path:`${e.pathname||""}${e.search||""}`,href:e.href};return""!==e.port&&(t.port=Number(e.port)),(e.username||e.password)&&(t.auth=`${decodeURIComponent(e.username)}:${decodeURIComponent(e.password)}`),t}}const Ei="@azure/msal-node",Oi="3.8.3";var Ri=n(58611),Pi=n(65692);class Mi{constructor(e,t,n){this.networkRequestViaProxy=(e,t,n,r)=>{const i=new URL(t),o=new URL(this.proxyUrl),s=n?.headers||{},a={host:o.hostname,port:o.port,method:"CONNECT",path:i.hostname,headers:s};this.customAgentOptions&&Object.keys(this.customAgentOptions).length&&(a.agent=new Ri.Agent(this.customAgentOptions));let c="";if(e===Z){const e=n?.body||"";c=`Content-Type: application/x-www-form-urlencoded\r\nContent-Length: ${e.length}\r\n\r\n${e}`}else r&&(a.timeout=r);const l=`${e.toUpperCase()} ${i.href} HTTP/1.1\r\nHost: ${i.host}\r\nConnection: close\r\n`+c+"\r\n";return new Promise((n,i)=>{const o=Ri.request(a);r&&o.on("timeout",()=>{this.logUrlWithPiiAwareness(`Request timeout after ${r}ms for URL`,t),o.destroy(),i(new Error(`Request time out after ${r}ms`))}),o.end(),o.on("connect",(e,t)=>{const r=e?.statusCode||te;(r<X||r>ee)&&(o.destroy(),t.destroy(),i(new Error(`Error connecting to proxy. Http status code: ${e.statusCode}. Http status message: ${e?.statusMessage||"Unknown"}`))),t.write(l);const s=[];t.on("data",e=>{s.push(e)}),t.on("end",()=>{const e=Buffer.concat([...s]).toString().split("\r\n"),t=parseInt(e[0].split(" ")[1]),r=e[0].split(" ").slice(2).join(" "),i=e[e.length-1],a=e.slice(1,e.length-2),c=new Map;a.forEach(e=>{const t=e.split(new RegExp(/:\s(.*)/s)),n=t[0];let r=t[1];try{const e=JSON.parse(r);e&&"object"==typeof e&&(r=e)}catch(e){}c.set(n,r)});const l=Object.fromEntries(c),u=_i.getNetworkResponse(l,this.parseBody(t,r,l,i),t);this.shouldDestroyRequest(t,u)&&o.destroy(),n(u)}),t.on("error",e=>{o.destroy(),t.destroy(),i(new Error(e.toString()))})}),o.on("error",n=>{this.logger.error(`HttpClient - Proxy request error: ${n.toString()}`,""),this.logUrlWithPiiAwareness("Destination URL",t),this.logUrlWithPiiAwareness("Proxy URL",this.proxyUrl),this.logger.error(`HttpClient - Method: ${e}`,""),this.logger.errorPii(`HttpClient - Headers: ${JSON.stringify(s)}`,""),o.destroy(),i(new Error(n.toString()))})})},this.networkRequestViaHttps=(e,t,n,r)=>{const i=e===Z,o=n?.body||"",s=new URL(t),a=n?.headers||{},c={method:e,headers:a,..._i.urlToHttpOptions(s)};return this.customAgentOptions&&Object.keys(this.customAgentOptions).length&&(c.agent=new Pi.Agent(this.customAgentOptions)),i?c.headers={...c.headers,"Content-Length":o.length}:r&&(c.timeout=r),new Promise((n,s)=>{let l;l="http:"===c.protocol?Ri.request(c):Pi.request(c),i&&l.write(o),r&&l.on("timeout",()=>{this.logUrlWithPiiAwareness(`HTTPS request timeout after ${r}ms for URL`,t),l.destroy(),s(new Error(`Request time out after ${r}ms`))}),l.end(),l.on("response",e=>{const t=e.headers,r=e.statusCode,i=e.statusMessage,o=[];e.on("data",e=>{o.push(e)}),e.on("end",()=>{const e=Buffer.concat([...o]).toString(),s=t,a=_i.getNetworkResponse(s,this.parseBody(r,i,s,e),r);this.shouldDestroyRequest(r,a)&&l.destroy(),n(a)})}),l.on("error",n=>{this.logger.error(`HttpClient - HTTPS request error: ${n.toString()}`,""),this.logUrlWithPiiAwareness("URL",t),this.logger.error(`HttpClient - Method: ${e}`,""),this.logger.errorPii(`HttpClient - Headers: ${JSON.stringify(a)}`,""),l.destroy(),s(new Error(n.toString()))})})},this.parseBody=(e,t,n,r)=>{let i;try{i=JSON.parse(r)}catch(r){let o,s;e>=400&&e<=499?(o="client_error",s="A client"):e>=500&&e<=599?(o="server_error",s="A server"):(o="unknown_error",s="An unknown"),i={error:o,error_description:`${s} error occured.\nHttp status code: ${e}\nHttp status message: ${t||"Unknown"}\nHeaders: ${JSON.stringify(n)}`}}return i},this.logUrlWithPiiAwareness=(e,t)=>{if(this.isPiiEnabled)this.logger.errorPii(`HttpClient - ${e}: ${t}`,"");else{let n;try{const e=new URL(t);n=`${e.protocol}//${e.host}${e.pathname}`}catch{n=t.split("?")[0]||"unknown"}this.logger.error(`HttpClient - ${e}: ${n} [Enable PII logging to see additional details]`,"")}},this.shouldDestroyRequest=(e,t)=>(e<200||e>299)&&!(t.body&&"object"==typeof t.body&&"error"in t.body&&"authorization_pending"===t.body.error),this.proxyUrl=e||"",this.customAgentOptions=t||{},this.logger=new Oe(n||{},Ei,Oi),this.isPiiEnabled=this.logger.isPiiLoggingEnabled()}async sendGetRequestAsync(e,t,n){return this.proxyUrl?this.networkRequestViaProxy(J,e,t,n):this.networkRequestViaHttps(J,e,t,n)}async sendPostRequestAsync(e,t){return this.proxyUrl?this.networkRequestViaProxy(Z,e,t):this.networkRequestViaHttps(Z,e,t)}}const Ni="invalid_loopback_server_address_type",qi="Loopback server address is not type string. This is unexpected.",xi="unable_to_load_redirectUrl",Ui="Loopback server callback was invoked without a url. This is unexpected.",Hi="no_auth_code_in_response",Di="No auth code found in the server response. Please check your network trace to determine what happened.",Li="no_loopback_server_exists",Bi="No loopback server exists yet.",Fi="loopback_server_already_exists",$i="Loopback server already exists. Cannot create another.",ji="loopback_server_timeout",Ki="Timed out waiting for auth code listener to be registered.",zi="state_not_found",Gi="State not found. Please verify that the request originated from msal.",Vi="thumbprint_missing_from_client_certificate",Yi="Client certificate does not contain a SHA-1 or SHA-256 thumbprint.",Wi="redirect_uri_not_supported",Qi="RedirectUri is not supported in this scenario. Please remove redirectUri from the request.";class Ji extends fe{constructor(e,t){super(e,t),this.name="NodeAuthError"}static createInvalidLoopbackAddressTypeError(){return new Ji(Ni,`${qi}`)}static createUnableToLoadRedirectUrlError(){return new Ji(xi,`${Ui}`)}static createNoAuthCodeInResponseError(){return new Ji(Hi,`${Di}`)}static createNoLoopbackServerExistsError(){return new Ji(Li,`${Bi}`)}static createLoopbackServerAlreadyExistsError(){return new Ji(Fi,`${$i}`)}static createLoopbackServerTimeoutError(){return new Ji(ji,`${Ki}`)}static createStateNotFoundError(){return new Ji(zi,Gi)}static createThumbprintMissingError(){return new Ji(Vi,Yi)}static createRedirectUriNotSupportedError(){return new Ji(Wi,Qi)}}const Zi={clientId:k.EMPTY_STRING,authority:k.DEFAULT_AUTHORITY,clientSecret:k.EMPTY_STRING,clientAssertion:k.EMPTY_STRING,clientCertificate:{thumbprint:k.EMPTY_STRING,thumbprintSha256:k.EMPTY_STRING,privateKey:k.EMPTY_STRING,x5c:k.EMPTY_STRING},knownAuthorities:[],cloudDiscoveryMetadata:k.EMPTY_STRING,authorityMetadata:k.EMPTY_STRING,clientCapabilities:[],protocolMode:"AAD",azureCloudOptions:{azureCloudInstance:an,tenant:k.EMPTY_STRING},skipAuthorityMetadataCache:!1,encodeExtraQueryParams:!1},Xi={claimsBasedCachingEnabled:!1},eo={loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:Ee.Info},to={loggerOptions:eo,networkClient:new Mi,proxyUrl:k.EMPTY_STRING,customAgentOptions:{},disableInternalRetries:!1},no={application:{appName:k.EMPTY_STRING,appVersion:k.EMPTY_STRING}};var ro=n(76982),io=n.n(ro);const oo=new Uint8Array(256);let so=oo.length;function ao(){return so>oo.length-16&&(io().randomFillSync(oo),so=0),oo.slice(so,so+=16)}const co=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,lo=[];for(let e=0;e<256;++e)lo.push((e+256).toString(16).substr(1));const uo=function(e,t=0){const n=(lo[e[t+0]]+lo[e[t+1]]+lo[e[t+2]]+lo[e[t+3]]+"-"+lo[e[t+4]]+lo[e[t+5]]+"-"+lo[e[t+6]]+lo[e[t+7]]+"-"+lo[e[t+8]]+lo[e[t+9]]+"-"+lo[e[t+10]]+lo[e[t+11]]+lo[e[t+12]]+lo[e[t+13]]+lo[e[t+14]]+lo[e[t+15]]).toLowerCase();if(!function(e){return"string"==typeof e&&co.test(e)}(n))throw TypeError("Stringified UUID is invalid");return n},ho=function(e,t,n){const r=(e=e||{}).random||(e.rng||ao)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return uo(r)};class po{generateGuid(){return ho()}isGuid(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}}class go{static base64Encode(e,t){return Buffer.from(e,t).toString(Q)}static base64EncodeUrl(e,t){return go.base64Encode(e,t).replace(/=/g,k.EMPTY_STRING).replace(/\+/g,"-").replace(/\//g,"_")}static base64Decode(e){return Buffer.from(e,Q).toString("utf8")}static base64DecodeUrl(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";return go.base64Decode(t)}}class fo{sha256(e){return ro.createHash("sha256").update(e).digest()}}class mo{constructor(){this.hashUtils=new fo}async generatePkceCodes(){const e=this.generateCodeVerifier();return{verifier:e,challenge:this.generateCodeChallengeFromVerifier(e)}}generateCodeVerifier(){const e=[];for(;e.length<=32;){const t=ro.randomBytes(1)[0];if(t>=198)continue;const n=t%66;e.push(ne[n])}const t=e.join(k.EMPTY_STRING);return go.base64EncodeUrl(t)}generateCodeChallengeFromVerifier(e){return go.base64EncodeUrl(this.hashUtils.sha256(e).toString(Q),Q)}}class yo{constructor(){this.pkceGenerator=new mo,this.guidGenerator=new po,this.hashUtils=new fo}base64UrlEncode(){throw new Error("Method not implemented.")}encodeKid(){throw new Error("Method not implemented.")}createNewGuid(){return this.guidGenerator.generateGuid()}base64Encode(e){return go.base64Encode(e)}base64Decode(e){return go.base64Decode(e)}generatePkceCodes(){return this.pkceGenerator.generatePkceCodes()}getPublicKeyThumbprint(){throw new Error("Method not implemented.")}removeTokenBindingKey(){throw new Error("Method not implemented.")}clearKeystore(){throw new Error("Method not implemented.")}signJwt(){throw new Error("Method not implemented.")}async hashString(e){return go.base64EncodeUrl(this.hashUtils.sha256(e).toString(Q),Q)}}class Co{static deserializeJSONBlob(e){return e?JSON.parse(e):{}}static deserializeAccounts(e){const t={};return e&&Object.keys(e).map(function(n){const r=e[n],i={homeAccountId:r.home_account_id,environment:r.environment,realm:r.realm,localAccountId:r.local_account_id,username:r.username,authorityType:r.authority_type,name:r.name,clientInfo:r.client_info,lastModificationTime:r.last_modification_time,lastModificationApp:r.last_modification_app,tenantProfiles:r.tenantProfiles?.map(e=>JSON.parse(e)),lastUpdatedAt:Date.now().toString()},o=new dr;yr.toObject(o,i),t[n]=o}),t}static deserializeIdTokens(e){const t={};return e&&Object.keys(e).map(function(n){const r=e[n],i={homeAccountId:r.home_account_id,environment:r.environment,credentialType:r.credential_type,clientId:r.client_id,secret:r.secret,realm:r.realm,lastUpdatedAt:Date.now().toString()};t[n]=i}),t}static deserializeAccessTokens(e){const t={};return e&&Object.keys(e).map(function(n){const r=e[n],i={homeAccountId:r.home_account_id,environment:r.environment,credentialType:r.credential_type,clientId:r.client_id,secret:r.secret,realm:r.realm,target:r.target,cachedAt:r.cached_at,expiresOn:r.expires_on,extendedExpiresOn:r.extended_expires_on,refreshOn:r.refresh_on,keyId:r.key_id,tokenType:r.token_type,requestedClaims:r.requestedClaims,requestedClaimsHash:r.requestedClaimsHash,userAssertionHash:r.userAssertionHash,lastUpdatedAt:Date.now().toString()};t[n]=i}),t}static deserializeRefreshTokens(e){const t={};return e&&Object.keys(e).map(function(n){const r=e[n],i={homeAccountId:r.home_account_id,environment:r.environment,credentialType:r.credential_type,clientId:r.client_id,secret:r.secret,familyId:r.family_id,target:r.target,realm:r.realm,lastUpdatedAt:Date.now().toString()};t[n]=i}),t}static deserializeAppMetadata(e){const t={};return e&&Object.keys(e).map(function(n){const r=e[n];t[n]={clientId:r.client_id,environment:r.environment,familyId:r.family_id}}),t}static deserializeAllCache(e){return{accounts:e.Account?this.deserializeAccounts(e.Account):{},idTokens:e.IdToken?this.deserializeIdTokens(e.IdToken):{},accessTokens:e.AccessToken?this.deserializeAccessTokens(e.AccessToken):{},refreshTokens:e.RefreshToken?this.deserializeRefreshTokens(e.RefreshToken):{},appMetadata:e.AppMetadata?this.deserializeAppMetadata(e.AppMetadata):{}}}}class To{static serializeJSONBlob(e){return JSON.stringify(e)}static serializeAccounts(e){const t={};return Object.keys(e).map(function(n){const r=e[n];t[n]={home_account_id:r.homeAccountId,environment:r.environment,realm:r.realm,local_account_id:r.localAccountId,username:r.username,authority_type:r.authorityType,name:r.name,client_info:r.clientInfo,last_modification_time:r.lastModificationTime,last_modification_app:r.lastModificationApp,tenantProfiles:r.tenantProfiles?.map(e=>JSON.stringify(e))}}),t}static serializeIdTokens(e){const t={};return Object.keys(e).map(function(n){const r=e[n];t[n]={home_account_id:r.homeAccountId,environment:r.environment,credential_type:r.credentialType,client_id:r.clientId,secret:r.secret,realm:r.realm}}),t}static serializeAccessTokens(e){const t={};return Object.keys(e).map(function(n){const r=e[n];t[n]={home_account_id:r.homeAccountId,environment:r.environment,credential_type:r.credentialType,client_id:r.clientId,secret:r.secret,realm:r.realm,target:r.target,cached_at:r.cachedAt,expires_on:r.expiresOn,extended_expires_on:r.extendedExpiresOn,refresh_on:r.refreshOn,key_id:r.keyId,token_type:r.tokenType,requestedClaims:r.requestedClaims,requestedClaimsHash:r.requestedClaimsHash,userAssertionHash:r.userAssertionHash}}),t}static serializeRefreshTokens(e){const t={};return Object.keys(e).map(function(n){const r=e[n];t[n]={home_account_id:r.homeAccountId,environment:r.environment,credential_type:r.credentialType,client_id:r.clientId,secret:r.secret,family_id:r.familyId,target:r.target,realm:r.realm}}),t}static serializeAppMetadata(e){const t={};return Object.keys(e).map(function(n){const r=e[n];t[n]={client_id:r.clientId,environment:r.environment,family_id:r.familyId}}),t}static serializeAllCache(e){return{Account:this.serializeAccounts(e.accounts),IdToken:this.serializeIdTokens(e.idTokens),AccessToken:this.serializeAccessTokens(e.accessTokens),RefreshToken:this.serializeRefreshTokens(e.refreshTokens),AppMetadata:this.serializeAppMetadata(e.appMetadata)}}}class Ao extends yr{constructor(e,t,n,r){super(t,n,e,new Ar,r),this.cache={},this.changeEmitters=[],this.logger=e}registerChangeEmitter(e){this.changeEmitters.push(e)}emitChange(){this.changeEmitters.forEach(e=>e.call(null))}cacheToInMemoryCache(e){const t={accounts:{},idTokens:{},accessTokens:{},refreshTokens:{},appMetadata:{}};for(const n in e){const r=e[n];if("object"==typeof r)if(r instanceof dr)t.accounts[n]=r;else if(Vn(r))t.idTokens[n]=r;else if(Gn(r))t.accessTokens[n]=r;else if(Yn(r))t.refreshTokens[n]=r;else{if(!Wn(n,r))continue;t.appMetadata[n]=r}}return t}inMemoryCacheToCache(e){let t=this.getCache();return t={...t,...e.accounts,...e.idTokens,...e.accessTokens,...e.refreshTokens,...e.appMetadata},t}getInMemoryCache(){return this.logger.trace("Getting in-memory cache"),this.cacheToInMemoryCache(this.getCache())}setInMemoryCache(e){this.logger.trace("Setting in-memory cache");const t=this.inMemoryCacheToCache(e);this.setCache(t),this.emitChange()}getCache(){return this.logger.trace("Getting cache key-value store"),this.cache}setCache(e){this.logger.trace("Setting cache key value store"),this.cache=e,this.emitChange()}getItem(e){return this.logger.tracePii(`Item key: ${e}`),this.getCache()[e]}setItem(e,t){this.logger.tracePii(`Item key: ${e}`);const n=this.getCache();n[e]=t,this.setCache(n)}generateCredentialKey(e){return function(e){const t=e.credentialType===x.REFRESH_TOKEN&&e.familyId||e.clientId,n=e.tokenType&&e.tokenType.toLowerCase()!==K.BEARER.toLowerCase()?e.tokenType.toLowerCase():"";return[e.homeAccountId,e.environment,e.credentialType,t,e.realm||"",e.target||"",e.requestedClaimsHash||"",n].join("-").toLowerCase()}(e)}generateAccountKey(e){return function(e){const t=e.homeAccountId.split(".")[1];return[e.homeAccountId,e.environment,t||e.tenantId||""].join("-").toLowerCase()}(e)}getAccountKeys(){const e=this.getInMemoryCache();return Object.keys(e.accounts)}getTokenKeys(){const e=this.getInMemoryCache();return{idToken:Object.keys(e.idTokens),accessToken:Object.keys(e.accessTokens),refreshToken:Object.keys(e.refreshTokens)}}getAccount(e){return this.getItem(e)?Object.assign(new dr,this.getItem(e)):null}async setAccount(e){const t=this.generateAccountKey(dr.getAccountInfo(e));this.setItem(t,e)}getIdTokenCredential(e){const t=this.getItem(e);return Vn(t)?t:null}async setIdTokenCredential(e){const t=this.generateCredentialKey(e);this.setItem(t,e)}getAccessTokenCredential(e){const t=this.getItem(e);return Gn(t)?t:null}async setAccessTokenCredential(e){const t=this.generateCredentialKey(e);this.setItem(t,e)}getRefreshTokenCredential(e){const t=this.getItem(e);return Yn(t)?t:null}async setRefreshTokenCredential(e){const t=this.generateCredentialKey(e);this.setItem(t,e)}getAppMetadata(e){const t=this.getItem(e);return Wn(e,t)?t:null}setAppMetadata(e){const t=function({environment:e,clientId:t}){return[U,e,t].join("-").toLowerCase()}(e);this.setItem(t,e)}getServerTelemetry(e){const t=this.getItem(e);return t&&function(e,t){const n=0===e.indexOf(j.CACHE_KEY);let r=!0;return t&&(r=t.hasOwnProperty("failedRequests")&&t.hasOwnProperty("errors")&&t.hasOwnProperty("cacheHits")),n&&r}(e,t)?t:null}setServerTelemetry(e,t){this.setItem(e,t)}getAuthorityMetadata(e){const t=this.getItem(e);return t&&function(e,t){return!!t&&0===e.indexOf(D)&&t.hasOwnProperty("aliases")&&t.hasOwnProperty("preferred_cache")&&t.hasOwnProperty("preferred_network")&&t.hasOwnProperty("canonical_authority")&&t.hasOwnProperty("authorization_endpoint")&&t.hasOwnProperty("token_endpoint")&&t.hasOwnProperty("issuer")&&t.hasOwnProperty("aliasesFromNetwork")&&t.hasOwnProperty("endpointsFromNetwork")&&t.hasOwnProperty("expiresAt")&&t.hasOwnProperty("jwks_uri")}(e,t)?t:null}getAuthorityMetadataKeys(){return this.getKeys().filter(e=>this.isAuthorityMetadata(e))}setAuthorityMetadata(e,t){this.setItem(e,t)}getThrottlingCache(e){const t=this.getItem(e);return t&&function(e,t){let n=!1;e&&(n=0===e.indexOf(z));let r=!0;return t&&(r=t.hasOwnProperty("throttleTime")),n&&r}(e,t)?t:null}setThrottlingCache(e,t){this.setItem(e,t)}removeItem(e){this.logger.tracePii(`Item key: ${e}`);let t=!1;const n=this.getCache();return n[e]&&(delete n[e],t=!0),t&&(this.setCache(n),this.emitChange()),t}removeOutdatedAccount(e){this.removeItem(e)}containsKey(e){return this.getKeys().includes(e)}getKeys(){this.logger.trace("Retrieving all cache keys");const e=this.getCache();return[...Object.keys(e)]}clear(){this.logger.trace("Clearing cache entries created by MSAL"),this.getKeys().forEach(e=>{this.removeItem(e)}),this.emitChange()}static generateInMemoryCache(e){return Co.deserializeAllCache(Co.deserializeJSONBlob(e))}static generateJsonCache(e){return To.serializeAllCache(e)}updateCredentialCacheKey(e,t){const n=this.generateCredentialKey(t);if(e!==n){const r=this.getItem(e);if(r)return this.removeItem(e),this.setItem(n,r),this.logger.verbose(`Updated an outdated ${t.credentialType} cache key`),n;this.logger.error(`Attempted to update an outdated ${t.credentialType} cache key but no item matching the outdated key was found in storage`)}return e}}const wo={},ko={},Io={},vo={},bo={};class So{constructor(e,t,n){this.cacheHasChanged=!1,this.storage=e,this.storage.registerChangeEmitter(this.handleChangeEvent.bind(this)),n&&(this.persistence=n),this.logger=t}hasChanged(){return this.cacheHasChanged}serialize(){this.logger.trace("Serializing in-memory cache");let e=To.serializeAllCache(this.storage.getInMemoryCache());return this.cacheSnapshot?(this.logger.trace("Reading cache snapshot from disk"),e=this.mergeState(JSON.parse(this.cacheSnapshot),e)):this.logger.trace("No cache snapshot to merge"),this.cacheHasChanged=!1,JSON.stringify(e)}deserialize(e){if(this.logger.trace("Deserializing JSON to in-memory cache"),this.cacheSnapshot=e,this.cacheSnapshot){this.logger.trace("Reading cache snapshot from disk");const e=Co.deserializeAllCache(this.overlayDefaults(JSON.parse(this.cacheSnapshot)));this.storage.setInMemoryCache(e)}else this.logger.trace("No cache snapshot to deserialize")}getKVStore(){return this.storage.getCache()}getCacheSnapshot(){const e=Ao.generateInMemoryCache(this.cacheSnapshot);return this.storage.inMemoryCacheToCache(e)}async getAllAccounts(e=(new yo).createNewGuid()){let t;this.logger.trace("getAllAccounts called");try{return this.persistence&&(t=new wi(this,!1),await this.persistence.beforeCacheAccess(t)),this.storage.getAllAccounts({},e)}finally{this.persistence&&t&&await this.persistence.afterCacheAccess(t)}}async getAccountByHomeId(e){const t=await this.getAllAccounts();return e&&t&&t.length&&t.filter(t=>t.homeAccountId===e)[0]||null}async getAccountByLocalId(e){const t=await this.getAllAccounts();return e&&t&&t.length&&t.filter(t=>t.localAccountId===e)[0]||null}async removeAccount(e,t){let n;this.logger.trace("removeAccount called");try{this.persistence&&(n=new wi(this,!0),await this.persistence.beforeCacheAccess(n)),this.storage.removeAccount(e,t||(new po).generateGuid())}finally{this.persistence&&n&&await this.persistence.afterCacheAccess(n)}}async overwriteCache(){if(!this.persistence)return void this.logger.info("No persistence layer specified, cache cannot be overwritten");this.logger.info("Overwriting in-memory cache with persistent cache"),this.storage.clear();const e=new wi(this,!1);await this.persistence.beforeCacheAccess(e);const t=this.getCacheSnapshot();this.storage.setCache(t),await this.persistence.afterCacheAccess(e)}handleChangeEvent(){this.cacheHasChanged=!0}mergeState(e,t){this.logger.trace("Merging in-memory cache with cache snapshot");const n=this.mergeRemovals(e,t);return this.mergeUpdates(n,t)}mergeUpdates(e,t){return Object.keys(t).forEach(n=>{const r=t[n];if(e.hasOwnProperty(n)){const t=null!==r,i="object"==typeof r,o=!Array.isArray(r),s=void 0!==e[n]&&null!==e[n];t&&i&&o&&s?this.mergeUpdates(e[n],r):e[n]=r}else null!==r&&(e[n]=r)}),e}mergeRemovals(e,t){this.logger.trace("Remove updated entries in cache");const n=e.Account?this.mergeRemovalsDict(e.Account,t.Account):e.Account,r=e.AccessToken?this.mergeRemovalsDict(e.AccessToken,t.AccessToken):e.AccessToken,i=e.RefreshToken?this.mergeRemovalsDict(e.RefreshToken,t.RefreshToken):e.RefreshToken,o=e.IdToken?this.mergeRemovalsDict(e.IdToken,t.IdToken):e.IdToken,s=e.AppMetadata?this.mergeRemovalsDict(e.AppMetadata,t.AppMetadata):e.AppMetadata;return{...e,Account:n,AccessToken:r,RefreshToken:i,IdToken:o,AppMetadata:s}}mergeRemovalsDict(e,t){const n={...e};return Object.keys(e).forEach(e=>{t&&t.hasOwnProperty(e)||delete n[e]}),n}overlayDefaults(e){return this.logger.trace("Overlaying input cache with the default cache"),{Account:{...wo,...e.Account},IdToken:{...ko,...e.IdToken},AccessToken:{...Io,...e.AccessToken},RefreshToken:{...vo,...e.RefreshToken},AppMetadata:{...bo,...e.AppMetadata}}}}var _o=n(44040);class Eo{static fromAssertion(e){const t=new Eo;return t.jwt=e,t}static fromCertificate(e,t,n){const r=new Eo;return r.privateKey=t,r.thumbprint=e,r.useSha256=!1,n&&(r.publicCertificate=this.parseCertificate(n)),r}static fromCertificateWithSha256Thumbprint(e,t,n){const r=new Eo;return r.privateKey=t,r.thumbprint=e,r.useSha256=!0,n&&(r.publicCertificate=this.parseCertificate(n)),r}getJwt(e,t,n){if(this.privateKey&&this.thumbprint)return this.jwt&&!this.isExpired()&&t===this.issuer&&n===this.jwtAudience?this.jwt:this.createJwt(e,t,n);if(this.jwt)return this.jwt;throw Qt(Nt)}createJwt(e,t,n){this.issuer=t,this.jwtAudience=n;const r=Fn();this.expirationTime=r+600;const i={alg:this.useSha256?"PS256":"RS256"},o=this.useSha256?"x5t#S256":"x5t";Object.assign(i,{[o]:go.base64EncodeUrl(this.thumbprint,"hex")}),this.publicCertificate&&Object.assign(i,{[oe]:this.publicCertificate});const s={[se]:this.jwtAudience,[ae]:this.expirationTime,[ce]:this.issuer,[le]:this.issuer,[ue]:r,[he]:e.createNewGuid()};return this.jwt=_o.sign(s,this.privateKey,{header:i}),this.jwt}isExpired(){return this.expirationTime<Fn()}static parseCertificate(e){const t=/-----BEGIN CERTIFICATE-----\r*\n(.+?)\r*\n-----END CERTIFICATE-----/gs,n=[];let r;for(;null!==(r=t.exec(e));)n.push(r[1].replace(/\r*\n/g,k.EMPTY_STRING));return n}}class Oo extends ci{constructor(e){super(e)}async acquireToken(e){this.logger.info("in acquireToken call in username-password client");const t=Fn(),n=await this.executeTokenRequest(this.authority,e),r=new ki(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return r.validateTokenResponse(n.body),r.handleServerTokenResponse(n.body,this.authority,t,e)}async executeTokenRequest(e,t){const n=this.createTokenQueryParameters(t),r=Xt.appendQueryString(e.tokenEndpoint,n),i=await this.createTokenRequestBody(t),o=this.createTokenRequestHeaders({credential:t.username,type:Pr}),s={clientId:this.config.authOptions.clientId,authority:e.canonicalAuthority,scopes:t.scopes,claims:t.claims,authenticationScheme:t.authenticationScheme,resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,sshKid:t.sshKid};return this.executePostToTokenEndpoint(r,i,o,s,t.correlationId)}async createTokenRequestBody(e){const t=new Map;xr(t,this.config.authOptions.clientId),function(e,t){e.set("username",t)}(t,e.username),function(e,t){e.set("password",t)}(t,e.password),qr(t,e.scopes),Nr(t,"id_token token"),Wr(t,"password"),Qr(t),jr(t,this.config.libraryInfo),Kr(t,this.config.telemetry.application),ni(t),this.serverTelemetryManager&&ti(t,this.serverTelemetryManager),$r(t,e.correlationId||this.config.cryptoInterface.createNewGuid()),this.config.clientCredentials.clientSecret&&Gr(t,this.config.clientCredentials.clientSecret);const n=this.config.clientCredentials.clientAssertion;return n&&(Vr(t,await Ii(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),Yr(t,n.assertionType)),(!nt.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&Fr(t,e.claims,this.config.authOptions.clientCapabilities),this.config.systemOptions.preventCorsPreflight&&e.username&&Dr(t,e.username),Zt(t)}}function Ro(e,t,n,r){const i=function(e,t,n,r){const i=t.correlationId,o=new Map;if(xr(o,t.embeddedClientId||t.extraQueryParameters?.[Ce]||e.clientId),qr(o,[...t.scopes||[],...t.extraScopesToConsent||[]],!0,e.authority.options.OIDCOptions?.defaultScopes),Ur(o,t.redirectUri),$r(o,i),function(e,t){e.set("response_mode",t||N)}(o,t.responseMode),Qr(o),t.prompt&&(function(e,t){e.set("prompt",t)}(o,t.prompt),r?.addFields({prompt:t.prompt},i)),t.domainHint&&(function(e,t){e.set("domain_hint",t)}(o,t.domainHint),r?.addFields({domainHintFromRequest:!0},i)),"select_account"!==t.prompt)if(t.sid&&t.prompt===M)n.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from request"),Br(o,t.sid),r?.addFields({sidFromRequest:!0},i);else if(t.account){const e=(s=t.account,s.idTokenClaims?.sid||null);let a=function(e){return e.loginHint||e.idTokenClaims?.login_hint||null}(t.account);if(a&&t.domainHint&&(n.warning('AuthorizationCodeClient.createAuthCodeUrlQueryString: "domainHint" param is set, skipping opaque "login_hint" claim. Please consider not passing domainHint'),a=null),a){n.verbose("createAuthCodeUrlQueryString: login_hint claim present on account"),Hr(o,a),r?.addFields({loginHintFromClaim:!0},i);try{Lr(o,ar(t.account.homeAccountId))}catch(e){n.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(e&&t.prompt===M){n.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from account"),Br(o,e),r?.addFields({sidFromClaim:!0},i);try{Lr(o,ar(t.account.homeAccountId))}catch(e){n.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(t.loginHint)n.verbose("createAuthCodeUrlQueryString: Adding login_hint from request"),Hr(o,t.loginHint),Dr(o,t.loginHint),r?.addFields({loginHintFromRequest:!0},i);else if(t.account.username){n.verbose("createAuthCodeUrlQueryString: Adding login_hint from account"),Hr(o,t.account.username),r?.addFields({loginHintFromUpn:!0},i);try{Lr(o,ar(t.account.homeAccountId))}catch(e){n.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}}else t.loginHint&&(n.verbose("createAuthCodeUrlQueryString: No account, adding login_hint from request"),Hr(o,t.loginHint),Dr(o,t.loginHint),r?.addFields({loginHintFromRequest:!0},i));else n.verbose("createAuthCodeUrlQueryString: Prompt is select_account, ignoring account hints");var s;return t.nonce&&function(e,t){e.set("nonce",t)}(o,t.nonce),t.state&&zr(o,t.state),(t.claims||e.clientCapabilities&&e.clientCapabilities.length>0)&&Fr(o,t.claims,e.clientCapabilities),t.embeddedClientId&&ri(o,e.clientId,e.redirectUri),!e.instanceAware||t.extraQueryParameters&&Object.keys(t.extraQueryParameters).includes(Se)||Jr(o),o}({...e.auth,authority:t,redirectUri:n.redirectUri||""},n,r);return jr(i,{sku:re,version:Oi,cpu:process.arch||"",os:process.platform||""}),e.auth.protocolMode!==sn&&Kr(i,e.telemetry.application),Nr(i,"code"),n.codeChallenge&&n.codeChallengeMethod&&function(e,t,n){if(!t||!n)throw tt(Be);e.set("code_challenge",t),e.set("code_challenge_method",n)}(i,n.codeChallenge,n.codeChallengeMethod),Zr(i,n.extraQueryParameters||{}),function(e,t,n,r){const i=Zt(t,n,r);return Xt.appendQueryString(e.authorizationEndpoint,i)}(t,i,e.auth.encodeExtraQueryParams,n.extraQueryParameters)}class Po{constructor(e){this.config=function({auth:e,broker:t,cache:n,system:r,telemetry:i}){const o={...to,networkClient:new Mi(r?.proxyUrl,r?.customAgentOptions),loggerOptions:r?.loggerOptions||eo,disableInternalRetries:r?.disableInternalRetries||!1};if(e.clientCertificate&&!e.clientCertificate.thumbprint&&!e.clientCertificate.thumbprintSha256)throw Ji.createStateNotFoundError();return{auth:{...Zi,...e},broker:{...t},cache:{...Xi,...n},system:{...o,...r},telemetry:{...no,...i}}}(e),this.cryptoProvider=new yo,this.logger=new Oe(this.config.system.loggerOptions,Ei,Oi),this.storage=new Ao(this.logger,this.config.auth.clientId,this.cryptoProvider,function(e){const t=e.cloudDiscoveryMetadata;let n;if(t)try{n=JSON.parse(t)}catch(e){throw tt(Fe)}return{canonicalAuthority:e.authority?tr(e.authority):void 0,knownAuthorities:e.knownAuthorities,cloudDiscoveryMetadata:n}}(this.config.auth)),this.tokenCache=new So(this.storage,this.logger,this.config.cache.cachePlugin)}async getAuthCodeUrl(e){this.logger.info("getAuthCodeUrl called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e),responseMode:e.responseMode||N,authenticationScheme:K.BEARER,state:e.state||"",nonce:e.nonce||""},n=await this.createAuthority(t.authority,t.correlationId,void 0,e.azureCloudOptions);return Ro(this.config,n,t,this.logger)}async acquireTokenByCode(e,t){this.logger.info("acquireTokenByCode called"),e.state&&t&&(this.logger.info("acquireTokenByCode - validating state"),this.validateState(e.state,t.state||""),t={...t,state:""});const n={...e,...await this.initializeBaseRequest(e),authenticationScheme:K.BEARER},r=this.initializeServerTelemetryManager(871,n.correlationId);try{const i=await this.createAuthority(n.authority,n.correlationId,void 0,e.azureCloudOptions),o=await this.buildOauthClientConfiguration(i,n.correlationId,n.redirectUri,r),s=new vi(o);return this.logger.verbose("Auth code client created",n.correlationId),await s.acquireToken(n,t)}catch(e){throw e instanceof fe&&e.setCorrelationId(n.correlationId),r.cacheFailedRequest(e),e}}async acquireTokenByRefreshToken(e){this.logger.info("acquireTokenByRefreshToken called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e),authenticationScheme:K.BEARER},n=this.initializeServerTelemetryManager(872,t.correlationId);try{const r=await this.createAuthority(t.authority,t.correlationId,void 0,e.azureCloudOptions),i=await this.buildOauthClientConfiguration(r,t.correlationId,t.redirectUri||"",n),o=new bi(i);return this.logger.verbose("Refresh token client created",t.correlationId),await o.acquireToken(t)}catch(e){throw e instanceof fe&&e.setCorrelationId(t.correlationId),n.cacheFailedRequest(e),e}}async acquireTokenSilent(e){const t={...e,...await this.initializeBaseRequest(e),forceRefresh:e.forceRefresh||!1},n=this.initializeServerTelemetryManager(62,t.correlationId,t.forceRefresh);try{const r=await this.createAuthority(t.authority,t.correlationId,void 0,e.azureCloudOptions),i=await this.buildOauthClientConfiguration(r,t.correlationId,t.redirectUri||"",n),o=new Si(i);this.logger.verbose("Silent flow client created",t.correlationId);try{return await this.tokenCache.overwriteCache(),await this.acquireCachedTokenSilent(t,o,i)}catch(e){if(e instanceof Wt&&e.errorCode===xt)return new bi(i).acquireTokenByRefreshToken(t);throw e}}catch(e){throw e instanceof fe&&e.setCorrelationId(t.correlationId),n.cacheFailedRequest(e),e}}async acquireCachedTokenSilent(e,t,n){const[r,i]=await t.acquireCachedToken({...e,scopes:e.scopes?.length?e.scopes:[...I]});if(i===W){this.logger.info("ClientApplication:acquireCachedTokenSilent - Cached access token's refreshOn property has been exceeded'. It's not expired, but must be refreshed.");const t=new bi(n);try{await t.acquireTokenByRefreshToken(e)}catch{}}return r}async acquireTokenByUsernamePassword(e){this.logger.info("acquireTokenByUsernamePassword called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e)},n=this.initializeServerTelemetryManager(371,t.correlationId);try{const r=await this.createAuthority(t.authority,t.correlationId,void 0,e.azureCloudOptions),i=await this.buildOauthClientConfiguration(r,t.correlationId,"",n),o=new Oo(i);return this.logger.verbose("Username password client created",t.correlationId),await o.acquireToken(t)}catch(e){throw e instanceof fe&&e.setCorrelationId(t.correlationId),n.cacheFailedRequest(e),e}}getTokenCache(){return this.logger.info("getTokenCache called"),this.tokenCache}validateState(e,t){if(!e)throw Ji.createStateNotFoundError();if(e!==t)throw Qt(dt)}getLogger(){return this.logger}setLogger(e){this.logger=e}async buildOauthClientConfiguration(e,t,n,r){return this.logger.verbose("buildOauthClientConfiguration called",t),this.logger.info(`Building oauth client configuration with the following authority: ${e.tokenEndpoint}.`,t),r?.updateRegionDiscoveryMetadata(e.regionDiscoveryMetadata),{authOptions:{clientId:this.config.auth.clientId,authority:e,clientCapabilities:this.config.auth.clientCapabilities,redirectUri:n},loggerOptions:{logLevel:this.config.system.loggerOptions.logLevel,loggerCallback:this.config.system.loggerOptions.loggerCallback,piiLoggingEnabled:this.config.system.loggerOptions.piiLoggingEnabled,correlationId:t},cacheOptions:{claimsBasedCachingEnabled:this.config.cache.claimsBasedCachingEnabled},cryptoInterface:this.cryptoProvider,networkInterface:this.config.system.networkClient,storageInterface:this.storage,serverTelemetryManager:r,clientCredentials:{clientSecret:this.clientSecret,clientAssertion:await this.getClientAssertion(e)},libraryInfo:{sku:re,version:Oi,cpu:process.arch||k.EMPTY_STRING,os:process.platform||k.EMPTY_STRING},telemetry:this.config.telemetry,persistencePlugin:this.config.cache.cachePlugin,serializableCache:this.tokenCache}}async getClientAssertion(e){return this.developerProvidedClientAssertion&&(this.clientAssertion=Eo.fromAssertion(await Ii(this.developerProvidedClientAssertion,this.config.auth.clientId,e.tokenEndpoint))),this.clientAssertion&&{assertion:this.clientAssertion.getJwt(this.cryptoProvider,this.config.auth.clientId,e.tokenEndpoint),assertionType:ie}}async initializeBaseRequest(e){return this.logger.verbose("initializeRequestScopes called",e.correlationId),e.authenticationScheme&&e.authenticationScheme===K.POP&&this.logger.verbose("Authentication Scheme 'pop' is not supported yet, setting Authentication Scheme to 'Bearer' for request",e.correlationId),e.authenticationScheme=K.BEARER,this.config.cache.claimsBasedCachingEnabled&&e.claims&&!nt.isEmptyObj(e.claims)&&(e.requestedClaimsHash=await this.cryptoProvider.hashString(e.claims)),{...e,scopes:[...e&&e.scopes||[],...I],correlationId:e&&e.correlationId||this.cryptoProvider.createNewGuid(),authority:e.authority||this.config.auth.authority}}initializeServerTelemetryManager(e,t,n){const r={clientId:this.config.auth.clientId,correlationId:t,apiId:e,forceRefresh:n||!1};return new ye(r,this.storage)}async createAuthority(e,t,n,r){this.logger.verbose("createAuthority called",t);const i=er.generateAuthority(e,r||this.config.auth.azureCloudOptions),o={protocolMode:this.config.auth.protocolMode,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,azureRegionConfiguration:n,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache};return ii(i,this.config.system.networkClient,this.storage,o,this.logger,t)}clearCache(){this.storage.clear()}}class Mo{async listenForAuthCode(e,t){if(this.server)throw Ji.createLoopbackServerAlreadyExistsError();return new Promise((n,r)=>{this.server=Ri.createServer((i,o)=>{const s=i.url;if(!s)return o.end(t||"Error occurred loading redirectUrl"),void r(Ji.createUnableToLoadRedirectUrlError());if(s===k.FORWARD_SLASH)return void o.end(e||"Auth code was successfully acquired. You can close this window now.");const a=this.getRedirectUri(),c=Jt(new URL(s,a).search)||{};c.code&&(o.writeHead(302,{location:a}),o.end()),c.error&&o.end(t||`Error occurred: ${c.error}`),n(c)}),this.server.listen(0,"127.0.0.1")})}getRedirectUri(){if(!this.server||!this.server.listening)throw Ji.createNoLoopbackServerExistsError();const e=this.server.address();if(!e||"string"==typeof e||!e.port)throw this.closeServer(),Ji.createInvalidLoopbackAddressTypeError();return`http://localhost:${e&&e.port}`}closeServer(){this.server&&(this.server.close(),"function"==typeof this.server.closeAllConnections&&this.server.closeAllConnections(),this.server.unref(),this.server=void 0)}}class No extends ci{constructor(e){super(e)}async acquireToken(e){const t=await this.getDeviceCode(e);e.deviceCodeCallback(t);const n=Fn(),r=await this.acquireTokenWithDeviceCode(e,t),i=new ki(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return i.validateTokenResponse(r),i.handleServerTokenResponse(r,this.authority,n,e)}async getDeviceCode(e){const t=this.createExtraQueryParameters(e),n=Xt.appendQueryString(this.authority.deviceCodeEndpoint,t),r=this.createQueryString(e),i=this.createTokenRequestHeaders(),o={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid};return this.executePostRequestToDeviceCodeEndpoint(n,r,i,o,e.correlationId)}createExtraQueryParameters(e){const t=new Map;return e.extraQueryParameters&&Zr(t,e.extraQueryParameters),Zt(t)}async executePostRequestToDeviceCodeEndpoint(e,t,n,r,i){const{body:{user_code:o,device_code:s,verification_uri:a,expires_in:c,interval:l,message:u}}=await this.sendPostRequest(r,e,{body:t,headers:n},i);return{userCode:o,deviceCode:s,verificationUri:a,expiresIn:c,interval:l,message:u}}createQueryString(e){const t=new Map;return qr(t,e.scopes),xr(t,this.config.authOptions.clientId),e.extraQueryParameters&&Zr(t,e.extraQueryParameters),(e.claims||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&Fr(t,e.claims,this.config.authOptions.clientCapabilities),Zt(t)}continuePolling(e,t,n){if(n)throw this.logger.error("Token request cancelled by setting DeviceCodeRequest.cancel = true"),Qt(vt);if(t&&t<e&&Fn()>t)throw this.logger.error(`User defined timeout for device code polling reached. The timeout was set for ${t}`),Qt(Ut);if(Fn()>e)throw t&&this.logger.verbose(`User specified timeout ignored as the device code has expired before the timeout elapsed. The user specified timeout was set for ${t}`),this.logger.error(`Device code expired. Expiration time of device code was ${e}`),Qt(bt);return!0}async acquireTokenWithDeviceCode(e,t){const n=this.createTokenQueryParameters(e),r=Xt.appendQueryString(this.authority.tokenEndpoint,n),i=this.createTokenRequestBody(e,t),o=this.createTokenRequestHeaders(),s=e.timeout?Fn()+e.timeout:void 0,a=Fn()+t.expiresIn,c=1e3*t.interval;for(;this.continuePolling(a,s,e.cancel);){const t={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid},n=await this.executePostToTokenEndpoint(r,i,o,t,e.correlationId);if(!n.body||!n.body.error)return this.logger.verbose("Authorization completed successfully. Polling stopped."),n.body;if(n.body.error!==k.AUTHORIZATION_PENDING)throw this.logger.info("Unexpected error in polling from the server"),me(pe,n.body.error);this.logger.info("Authorization pending. Continue polling."),await Kn(c)}throw this.logger.error("Polling stopped for unknown reasons."),Qt(St)}createTokenRequestBody(e,t){const n=new Map;return qr(n,e.scopes),xr(n,this.config.authOptions.clientId),Wr(n,"device_code"),function(e,t){e.set("device_code",t)}(n,t.deviceCode),$r(n,e.correlationId||this.config.cryptoInterface.createNewGuid()),Qr(n),jr(n,this.config.libraryInfo),Kr(n,this.config.telemetry.application),ni(n),this.serverTelemetryManager&&ti(n,this.serverTelemetryManager),(!nt.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&Fr(n,e.claims,this.config.authOptions.clientCapabilities),Zt(n)}}class qo extends Po{constructor(e){super(e),this.config.broker.nativeBrokerPlugin&&(this.config.broker.nativeBrokerPlugin.isBrokerAvailable?(this.nativeBrokerPlugin=this.config.broker.nativeBrokerPlugin,this.nativeBrokerPlugin.setLogger(this.config.system.loggerOptions)):this.logger.warning("NativeBroker implementation was provided but the broker is unavailable.")),this.skus=ye.makeExtraSkuString({libraryName:re,libraryVersion:Oi})}async acquireTokenByDeviceCode(e){this.logger.info("acquireTokenByDeviceCode called",e.correlationId);const t=Object.assign(e,await this.initializeBaseRequest(e)),n=this.initializeServerTelemetryManager(671,t.correlationId);try{const r=await this.createAuthority(t.authority,t.correlationId,void 0,e.azureCloudOptions),i=await this.buildOauthClientConfiguration(r,t.correlationId,"",n),o=new No(i);return this.logger.verbose("Device code client created",t.correlationId),await o.acquireToken(t)}catch(e){throw e instanceof fe&&e.setCorrelationId(t.correlationId),n.cacheFailedRequest(e),e}}async acquireTokenInteractive(e){const t=e.correlationId||this.cryptoProvider.createNewGuid();this.logger.trace("acquireTokenInteractive called",t);const{openBrowser:n,successTemplate:r,errorTemplate:i,windowHandle:o,loopbackClient:s,...a}=e;if(this.nativeBrokerPlugin){const n={...a,clientId:this.config.auth.clientId,scopes:e.scopes||I,redirectUri:e.redirectUri||"",authority:e.authority||this.config.auth.authority,correlationId:t,extraParameters:{...a.extraQueryParameters,...a.tokenQueryParameters,[Ie]:this.skus},accountId:a.account?.nativeAccountId};return this.nativeBrokerPlugin.acquireTokenInteractive(n,o)}if(e.redirectUri){if(!this.config.broker.nativeBrokerPlugin)throw Ji.createRedirectUriNotSupportedError();e.redirectUri=""}const{verifier:c,challenge:l}=await this.cryptoProvider.generatePkceCodes(),u=s||new Mo;let h={},d=null;try{const o=u.listenForAuthCode(r,i).then(e=>{h=e}).catch(e=>{d=e}),s=await this.waitForRedirectUri(u),p={...a,correlationId:t,scopes:e.scopes||I,redirectUri:s,responseMode:N,codeChallenge:l,codeChallengeMethod:"S256"},g=await this.getAuthCodeUrl(p);if(await n(g),await o,d)throw d;if(h.error)throw new _e(h.error,h.error_description,h.suberror);if(!h.code)throw Ji.createNoAuthCodeInResponseError();const f=h.client_info,m={code:h.code,codeVerifier:c,clientInfo:f||k.EMPTY_STRING,...p};return await this.acquireTokenByCode(m)}finally{u.closeServer()}}async acquireTokenSilent(e){const t=e.correlationId||this.cryptoProvider.createNewGuid();if(this.logger.trace("acquireTokenSilent called",t),this.nativeBrokerPlugin){const n={...e,clientId:this.config.auth.clientId,scopes:e.scopes||I,redirectUri:e.redirectUri||"",authority:e.authority||this.config.auth.authority,correlationId:t,extraParameters:{...e.tokenQueryParameters,[Ie]:this.skus},accountId:e.account.nativeAccountId,forceRefresh:e.forceRefresh||!1};return this.nativeBrokerPlugin.acquireTokenSilent(n)}if(e.redirectUri){if(!this.config.broker.nativeBrokerPlugin)throw Ji.createRedirectUriNotSupportedError();e.redirectUri=""}return super.acquireTokenSilent(e)}async signOut(e){if(this.nativeBrokerPlugin&&e.account.nativeAccountId){const t={clientId:this.config.auth.clientId,accountId:e.account.nativeAccountId,correlationId:e.correlationId||this.cryptoProvider.createNewGuid()};await this.nativeBrokerPlugin.signOut(t)}await this.getTokenCache().removeAccount(e.account,e.correlationId)}async getAllAccounts(){if(this.nativeBrokerPlugin){const e=this.cryptoProvider.createNewGuid();return this.nativeBrokerPlugin.getAllAccounts(this.config.auth.clientId,e)}return this.getTokenCache().getAllAccounts()}async waitForRedirectUri(e){return new Promise((t,n)=>{let r=0;const i=setInterval(()=>{if(50<r)return clearInterval(i),void n(Ji.createLoopbackServerTimeoutError());try{const n=e.getRedirectUri();return clearInterval(i),void t(n)}catch(e){return e instanceof fe&&e.errorCode===Li?void r++:(clearInterval(i),void n(e))}},100)})}}class xo extends ci{constructor(e,t){super(e),this.appTokenProvider=t}async acquireToken(e){if(e.skipCache||e.claims)return this.executeTokenRequest(e,this.authority);const[t,n]=await this.getCachedAuthenticationResult(e,this.config,this.cryptoUtils,this.authority,this.cacheManager,this.serverTelemetryManager);if(t){if(n===W){this.logger.info("ClientCredentialClient:getCachedAuthenticationResult - Cached access token's refreshOn property has been exceeded'. It's not expired, but must be refreshed.");const t=!0;await this.executeTokenRequest(e,this.authority,t)}return t}return this.executeTokenRequest(e,this.authority)}async getCachedAuthenticationResult(e,t,n,r,i,o){const s=t,a=t;let c,l=G;s.serializableCache&&s.persistencePlugin&&(c=new wi(s.serializableCache,!1),await s.persistencePlugin.beforeCacheAccess(c));const u=this.readAccessTokenFromCache(r,a.managedIdentityId?.id||s.authOptions.clientId,new or(e.scopes||[]),i,e.correlationId);return s.serializableCache&&s.persistencePlugin&&c&&await s.persistencePlugin.afterCacheAccess(c),u?jn(u.expiresOn,s.systemOptions?.tokenRenewalOffsetSeconds||300)?(o?.setCacheOutcome(Y),[null,Y]):(u.refreshOn&&jn(u.refreshOn.toString(),0)&&(l=W,o?.setCacheOutcome(W)),[await ki.generateAuthenticationResult(n,r,{account:null,idToken:null,accessToken:u,refreshToken:null,appMetadata:null},!0,e),l]):(o?.setCacheOutcome(V),[null,V])}readAccessTokenFromCache(e,t,n,r,i){const o={homeAccountId:k.EMPTY_STRING,environment:e.canonicalAuthorityUrlComponents.HostNameAndPort,credentialType:x.ACCESS_TOKEN,clientId:t,realm:e.tenant,target:or.createSearchScopes(n.asArray())},s=r.getAccessTokensByFilter(o,i);if(s.length<1)return null;if(s.length>1)throw Qt(yt);return s[0]}async executeTokenRequest(e,t,n){let r,i;if(this.appTokenProvider){this.logger.info("Using appTokenProvider extensibility.");const t={correlationId:e.correlationId,tenantId:this.config.authOptions.authority.tenant,scopes:e.scopes,claims:e.claims};i=Fn();const n=await this.appTokenProvider(t);r={access_token:n.accessToken,expires_in:n.expiresInSeconds,refresh_in:n.refreshInSeconds,token_type:K.BEARER}}else{const n=this.createTokenQueryParameters(e),o=Xt.appendQueryString(t.tokenEndpoint,n),s=await this.createTokenRequestBody(e),a=this.createTokenRequestHeaders(),c={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid};this.logger.info("Sending token request to endpoint: "+t.tokenEndpoint),i=Fn();const l=await this.executePostToTokenEndpoint(o,s,a,c,e.correlationId);r=l.body,r.status=l.status}const o=new ki(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return o.validateTokenResponse(r,n),await o.handleServerTokenResponse(r,this.authority,i,e)}async createTokenRequestBody(e){const t=new Map;xr(t,this.config.authOptions.clientId),qr(t,e.scopes,!1),Wr(t,"client_credentials"),jr(t,this.config.libraryInfo),Kr(t,this.config.telemetry.application),ni(t),this.serverTelemetryManager&&ti(t,this.serverTelemetryManager),$r(t,e.correlationId||this.config.cryptoInterface.createNewGuid()),this.config.clientCredentials.clientSecret&&Gr(t,this.config.clientCredentials.clientSecret);const n=e.clientAssertion||this.config.clientCredentials.clientAssertion;return n&&(Vr(t,await Ii(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),Yr(t,n.assertionType)),(!nt.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&Fr(t,e.claims,this.config.authOptions.clientCapabilities),Zt(t)}}class Uo extends ci{constructor(e){super(e)}async acquireToken(e){if(this.scopeSet=new or(e.scopes||[]),this.userAssertionHash=await this.cryptoUtils.hashString(e.oboAssertion),e.skipCache||e.claims)return this.executeTokenRequest(e,this.authority,this.userAssertionHash);try{return await this.getCachedAuthenticationResult(e)}catch(t){return await this.executeTokenRequest(e,this.authority,this.userAssertionHash)}}async getCachedAuthenticationResult(e){const t=this.readAccessTokenFromCacheForOBO(this.config.authOptions.clientId,e);if(!t)throw this.serverTelemetryManager?.setCacheOutcome(V),this.logger.info("SilentFlowClient:acquireCachedToken - No access token found in cache for the given properties."),Qt(xt);if(jn(t.expiresOn,this.config.systemOptions.tokenRenewalOffsetSeconds))throw this.serverTelemetryManager?.setCacheOutcome(Y),this.logger.info(`OnbehalfofFlow:getCachedAuthenticationResult - Cached access token is expired or will expire within ${this.config.systemOptions.tokenRenewalOffsetSeconds} seconds.`),Qt(xt);const n=this.readIdTokenFromCacheForOBO(t.homeAccountId,e.correlationId);let r,i=null;if(n){r=Ln(n.secret,go.base64Decode);const t=r.oid||r.sub,o={homeAccountId:n.homeAccountId,environment:n.environment,tenantId:n.realm,username:k.EMPTY_STRING,localAccountId:t||k.EMPTY_STRING};i=this.cacheManager.getAccount(this.cacheManager.generateAccountKey(o),e.correlationId)}return this.config.serverTelemetryManager&&this.config.serverTelemetryManager.incrementCacheHits(),ki.generateAuthenticationResult(this.cryptoUtils,this.authority,{account:i,accessToken:t,idToken:n,refreshToken:null,appMetadata:null},!0,e,r)}readIdTokenFromCacheForOBO(e,t){const n={homeAccountId:e,environment:this.authority.canonicalAuthorityUrlComponents.HostNameAndPort,credentialType:x.ID_TOKEN,clientId:this.config.authOptions.clientId,realm:this.authority.tenant},r=this.cacheManager.getIdTokensByFilter(n,t);return Object.values(r).length<1?null:Object.values(r)[0]}readAccessTokenFromCacheForOBO(e,t){const n=t.authenticationScheme||K.BEARER,r={credentialType:n&&n.toLowerCase()!==K.BEARER.toLowerCase()?x.ACCESS_TOKEN_WITH_AUTH_SCHEME:x.ACCESS_TOKEN,clientId:e,target:or.createSearchScopes(this.scopeSet.asArray()),tokenType:n,keyId:t.sshKid,requestedClaimsHash:t.requestedClaimsHash,userAssertionHash:this.userAssertionHash},i=this.cacheManager.getAccessTokensByFilter(r,t.correlationId),o=i.length;if(o<1)return null;if(o>1)throw Qt(yt);return i[0]}async executeTokenRequest(e,t,n){const r=this.createTokenQueryParameters(e),i=Xt.appendQueryString(t.tokenEndpoint,r),o=await this.createTokenRequestBody(e),s=this.createTokenRequestHeaders(),a={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid},c=Fn(),l=await this.executePostToTokenEndpoint(i,o,s,a,e.correlationId),u=new ki(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return u.validateTokenResponse(l.body),await u.handleServerTokenResponse(l.body,this.authority,c,e,void 0,n)}async createTokenRequestBody(e){const t=new Map;xr(t,this.config.authOptions.clientId),qr(t,e.scopes),Wr(t,"urn:ietf:params:oauth:grant-type:jwt-bearer"),Qr(t),jr(t,this.config.libraryInfo),Kr(t,this.config.telemetry.application),ni(t),this.serverTelemetryManager&&ti(t,this.serverTelemetryManager),$r(t,e.correlationId||this.config.cryptoInterface.createNewGuid()),function(e){e.set("requested_token_use","on_behalf_of")}(t),function(e,t){e.set("assertion",t)}(t,e.oboAssertion),this.config.clientCredentials.clientSecret&&Gr(t,this.config.clientCredentials.clientSecret);const n=this.config.clientCredentials.clientAssertion;return n&&(Vr(t,await Ii(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),Yr(t,n.assertionType)),(e.claims||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&Fr(t,e.claims,this.config.authOptions.clientCapabilities),Zt(t)}}class Ho extends Po{constructor(e){super(e);const t=!!this.config.auth.clientSecret,n=!!this.config.auth.clientAssertion,r=!(!this.config.auth.clientCertificate?.thumbprint&&!this.config.auth.clientCertificate?.thumbprintSha256||!this.config.auth.clientCertificate?.privateKey);if(!this.appTokenProvider){if(t&&n||n&&r||t&&r)throw Qt(qt);if(this.config.auth.clientSecret)this.clientSecret=this.config.auth.clientSecret;else if(this.config.auth.clientAssertion)this.developerProvidedClientAssertion=this.config.auth.clientAssertion;else{if(!r)throw Qt(qt);this.clientAssertion=this.config.auth.clientCertificate.thumbprintSha256?Eo.fromCertificateWithSha256Thumbprint(this.config.auth.clientCertificate.thumbprintSha256,this.config.auth.clientCertificate.privateKey,this.config.auth.clientCertificate.x5c):Eo.fromCertificate(this.config.auth.clientCertificate.thumbprint,this.config.auth.clientCertificate.privateKey,this.config.auth.clientCertificate.x5c),this.appTokenProvider=void 0}}}SetAppTokenProvider(e){this.appTokenProvider=e}async acquireTokenByClientCredential(e){let t;this.logger.info("acquireTokenByClientCredential called",e.correlationId),e.clientAssertion&&(t={assertion:await Ii(e.clientAssertion,this.config.auth.clientId),assertionType:ie});const n=await this.initializeBaseRequest(e),r={...n,scopes:n.scopes.filter(e=>!I.includes(e))},i={...e,...r,clientAssertion:t},o=new Xt(i.authority).getUrlComponents().PathSegments[0];if(Object.values(R).includes(o))throw Qt(Kt);const s=process.env.MSAL_FORCE_REGION;let a;"DisableMsalForceRegion"!==i.azureRegion&&(a=!i.azureRegion&&s?s:i.azureRegion);const c={azureRegion:a,environmentRegion:process.env.REGION_NAME},l=this.initializeServerTelemetryManager(771,i.correlationId,i.skipCache);try{const t=await this.createAuthority(i.authority,i.correlationId,c,e.azureCloudOptions),n=await this.buildOauthClientConfiguration(t,i.correlationId,"",l),r=new xo(n,this.appTokenProvider);return this.logger.verbose("Client credential client created",i.correlationId),await r.acquireToken(i)}catch(e){throw e instanceof fe&&e.setCorrelationId(i.correlationId),l.cacheFailedRequest(e),e}}async acquireTokenOnBehalfOf(e){this.logger.info("acquireTokenOnBehalfOf called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e)};try{const n=await this.createAuthority(t.authority,t.correlationId,void 0,e.azureCloudOptions),r=await this.buildOauthClientConfiguration(n,t.correlationId,"",void 0),i=new Uo(r);return this.logger.verbose("On behalf of client created",t.correlationId),await i.acquireToken(t)}catch(e){throw e instanceof fe&&e.setCorrelationId(t.correlationId),e}}}n(79896),n(16928),process.env.ProgramData,process.env.ProgramFiles;var Do=n(67715),Lo=n(42816);const Bo=A("IdentityUtils");function Fo(e,t,n){const r=t=>(Bo.getToken.info(t),new g({scopes:Array.isArray(e)?e:[e],getTokenOptions:n,message:t}));if(!t)throw r("No response");if(!t.expiresOn)throw r('Response had no "expiresOn" property.');if(!t.accessToken)throw r('Response had no "accessToken" property.')}function $o(e){let t=e?.authorityHost;return!t&&Do.qx&&(t=process.env.AZURE_AUTHORITY_HOST),t??s}function jo(e,t){return t||(t=s),new RegExp(`${e}/?$`).test(t)?t:t.endsWith("/")?t+e:`${t}/${e}`}function Ko(e,t,n){return"adfs"===e&&t||n?[t]:[]}const zo=(e,t=(Do.Ll?"Node":"Browser"))=>(n,r,i)=>{if(!i)switch(n){case Ee.Error:return void e.info(`MSAL ${t} V2 error: ${r}`);case Ee.Info:return void e.info(`MSAL ${t} V2 info message: ${r}`);case Ee.Verbose:return void e.info(`MSAL ${t} V2 verbose message: ${r}`);case Ee.Warning:return void e.info(`MSAL ${t} V2 warning: ${r}`)}};function Go(e){switch(e){case"error":return Ee.Error;case"info":default:return Ee.Info;case"verbose":return Ee.Verbose;case"warning":return Ee.Warning}}function Vo(e,t,n){if("AuthError"===t.name||"ClientAuthError"===t.name||"BrowserAuthError"===t.name){const n=t;switch(n.errorCode){case"endpoints_resolution_error":return Bo.info(C(e,t.message)),new u(t.message);case"device_code_polling_cancelled":return new Lo.l("The authentication has been aborted by the caller.");case"consent_required":case"interaction_required":case"login_required":Bo.info(C(e,`Authentication returned errorCode ${n.errorCode}`));break;default:Bo.info(C(e,`Failed to acquire token: ${t.message}`))}}return"ClientConfigurationError"===t.name||"BrowserConfigurationAuthError"===t.name||"AbortError"===t.name||"AuthenticationError"===t.name?t:"NativeAuthError"===t.name?(Bo.info(C(e,`Error from the native broker: ${t.message} with status code: ${t.statusCode}`)),t):new g({scopes:e,getTokenOptions:n,message:t.message})}var Yo=n(99834),Wo=n(44835);function Qo(e){if("number"==typeof e.expires_on)return 1e3*e.expires_on;if("string"==typeof e.expires_on){const t=+e.expires_on;if(!isNaN(t))return 1e3*t;const n=Date.parse(e.expires_on);if(!isNaN(n))return n}if("number"==typeof e.expires_in)return Date.now()+1e3*e.expires_in;throw new Error(`Failed to parse token expiration from body. expires_in="${e.expires_in}", expires_on="${e.expires_on}"`)}function Jo(e){if(e.refresh_on){if("number"==typeof e.refresh_on)return 1e3*e.refresh_on;if("string"==typeof e.refresh_on){const t=+e.refresh_on;if(!isNaN(t))return 1e3*t;const n=Date.parse(e.refresh_on);if(!isNaN(n))return n}throw new Error(`Failed to parse refresh_on from body. refresh_on="${e.refresh_on}"`)}}const Zo="noCorrelationId";class Xo extends Yo.ServiceClient{authorityHost;allowLoggingAccountIdentifiers;abortControllers;allowInsecureConnection=!1;tokenCredentialOptions;constructor(e){const t=`azsdk-js-identity/${r}`,n=e?.userAgentOptions?.userAgentPrefix?`${e.userAgentOptions.userAgentPrefix} ${t}`:`${t}`,i=function(e){let t=e?.authorityHost;return Do.Ll&&(t=t??process.env.AZURE_AUTHORITY_HOST),t??s}(e);if(!i.startsWith("https:"))throw new Error("The authorityHost address must use the 'https' protocol.");super({requestContentType:"application/json; charset=utf-8",retryOptions:{maxRetries:3},...e,userAgentOptions:{userAgentPrefix:n},baseUri:i}),this.authorityHost=i,this.abortControllers=new Map,this.allowLoggingAccountIdentifiers=e?.loggingOptions?.allowLoggingAccountIdentifiers,this.tokenCredentialOptions={...e},e?.allowInsecureConnection&&(this.allowInsecureConnection=e.allowInsecureConnection)}async sendTokenRequest(e){m.info(`IdentityClient: sending token request to [${e.url}]`);const t=await this.sendRequest(e);if(!t.bodyAsText||200!==t.status&&201!==t.status){const e=new d(t.status,t.bodyAsText);throw m.warning(`IdentityClient: authentication error. HTTP status: ${t.status}, ${e.errorResponse.errorDescription}`),e}{const n=JSON.parse(t.bodyAsText);if(!n.access_token)return null;this.logIdentifiers(t);const r={accessToken:{token:n.access_token,expiresOnTimestamp:Qo(n),refreshAfterTimestamp:Jo(n),tokenType:"Bearer"},refreshToken:n.refresh_token};return m.info(`IdentityClient: [${e.url}] token acquired, expires on ${r.accessToken.expiresOnTimestamp}`),r}}async refreshAccessToken(e,t,n,r,i,o={}){if(void 0===r)return null;m.info(`IdentityClient: refreshing access token with client ID: ${t}, scopes: ${n} started`);const s={grant_type:"refresh_token",client_id:t,refresh_token:r,scope:n};void 0!==i&&(s.client_secret=i);const a=new URLSearchParams(s);return w.withSpan("IdentityClient.refreshAccessToken",o,async n=>{try{const r=function(e){return"adfs"===e?"oauth2/token":"oauth2/v2.0/token"}(e),i=(0,Wo.createPipelineRequest)({url:`${this.authorityHost}/${e}/${r}`,method:"POST",body:a.toString(),abortSignal:o.abortSignal,headers:(0,Wo.createHttpHeaders)({Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"}),tracingOptions:n.tracingOptions}),s=await this.sendTokenRequest(i);return m.info(`IdentityClient: refreshed token for client ID: ${t}`),s}catch(e){if(e.name===h&&"interaction_required"===e.errorResponse.error)return m.info(`IdentityClient: interaction required for client ID: ${t}`),null;throw m.warning(`IdentityClient: failed refreshing token for client ID: ${t}: ${e}`),e}})}generateAbortSignal(e){const t=new AbortController,n=this.abortControllers.get(e)||[];n.push(t),this.abortControllers.set(e,n);const r=t.signal.onabort;return t.signal.onabort=(...n)=>{this.abortControllers.set(e,void 0),r&&r.apply(t.signal,n)},t.signal}abortRequests(e){const t=e||Zo,n=[...this.abortControllers.get(t)||[],...this.abortControllers.get(Zo)||[]];if(n.length){for(const e of n)e.abort();this.abortControllers.set(t,void 0)}}getCorrelationId(e){const t=e?.body?.split("&").map(e=>e.split("=")).find(([e])=>"client-request-id"===e);return t&&t.length&&t[1]||Zo}async sendGetRequestAsync(e,t){const n=(0,Wo.createPipelineRequest)({url:e,method:"GET",body:t?.body,allowInsecureConnection:this.allowInsecureConnection,headers:(0,Wo.createHttpHeaders)(t?.headers),abortSignal:this.generateAbortSignal(Zo)}),r=await this.sendRequest(n);return this.logIdentifiers(r),{body:r.bodyAsText?JSON.parse(r.bodyAsText):void 0,headers:r.headers.toJSON(),status:r.status}}async sendPostRequestAsync(e,t){const n=(0,Wo.createPipelineRequest)({url:e,method:"POST",body:t?.body,headers:(0,Wo.createHttpHeaders)(t?.headers),allowInsecureConnection:this.allowInsecureConnection,abortSignal:this.generateAbortSignal(this.getCorrelationId(t))}),r=await this.sendRequest(n);return this.logIdentifiers(r),{body:r.bodyAsText?JSON.parse(r.bodyAsText):void 0,headers:r.headers.toJSON(),status:r.status}}getTokenCredentialOptions(){return this.tokenCredentialOptions}logIdentifiers(e){if(this.allowLoggingAccountIdentifiers&&e.bodyAsText)try{const t=(e.parsedBody||JSON.parse(e.bodyAsText)).access_token;if(!t)return;const n=t.split(".")[1],{appid:r,upn:i,tid:o,oid:s}=JSON.parse(Buffer.from(n,"base64").toString("utf8"));m.info(`[Authenticated account] Client ID: ${r}. Tenant ID: ${o}. User Principal Name: ${i||"No User Principal Name available"}. Object ID (user): ${s}`)}catch(e){m.warning("allowLoggingAccountIdentifiers was set, but we couldn't log the account information. Error:",e.message)}}}var es;function ts(e){let t=e;return void 0===t&&void 0!==globalThis.process?.env?.AZURE_REGIONAL_AUTHORITY_NAME&&(t=process.env.AZURE_REGIONAL_AUTHORITY_NAME),t===es.AutoDiscoverRegion?"AUTO_DISCOVER":t}function ns(e,t,n){return t?(function(e,t){if(!t.match(/^[0-9a-zA-Z-.]+$/)){const t=new Error("Invalid tenant id provided. You can locate your tenant id by following the instructions listed here: https://learn.microsoft.com/partner-center/find-ids-and-domain-names.");throw e.info(C("",t)),t}}(e,t),t):(n||(n=i),n!==i?"common":"organizations")}!function(e){e.AutoDiscoverRegion="AutoDiscoverRegion",e.USWest="westus",e.USWest2="westus2",e.USCentral="centralus",e.USEast="eastus",e.USEast2="eastus2",e.USNorthCentral="northcentralus",e.USSouthCentral="southcentralus",e.USWestCentral="westcentralus",e.CanadaCentral="canadacentral",e.CanadaEast="canadaeast",e.BrazilSouth="brazilsouth",e.EuropeNorth="northeurope",e.EuropeWest="westeurope",e.UKSouth="uksouth",e.UKWest="ukwest",e.FranceCentral="francecentral",e.FranceSouth="francesouth",e.SwitzerlandNorth="switzerlandnorth",e.SwitzerlandWest="switzerlandwest",e.GermanyNorth="germanynorth",e.GermanyWestCentral="germanywestcentral",e.NorwayWest="norwaywest",e.NorwayEast="norwayeast",e.AsiaEast="eastasia",e.AsiaSouthEast="southeastasia",e.JapanEast="japaneast",e.JapanWest="japanwest",e.AustraliaEast="australiaeast",e.AustraliaSouthEast="australiasoutheast",e.AustraliaCentral="australiacentral",e.AustraliaCentral2="australiacentral2",e.IndiaCentral="centralindia",e.IndiaSouth="southindia",e.IndiaWest="westindia",e.KoreaSouth="koreasouth",e.KoreaCentral="koreacentral",e.UAECentral="uaecentral",e.UAENorth="uaenorth",e.SouthAfricaNorth="southafricanorth",e.SouthAfricaWest="southafricawest",e.ChinaNorth="chinanorth",e.ChinaEast="chinaeast",e.ChinaNorth2="chinanorth2",e.ChinaEast2="chinaeast2",e.GermanyCentral="germanycentral",e.GermanyNorthEast="germanynortheast",e.GovernmentUSVirginia="usgovvirginia",e.GovernmentUSIowa="usgoviowa",e.GovernmentUSArizona="usgovarizona",e.GovernmentUSTexas="usgovtexas",e.GovernmentUSDodEast="usdodeast",e.GovernmentUSDodCentral="usdodcentral"}(es||(es={}));const rs=A("MsalClient");function is(e,t,n={}){const r=ns(n.logger??rs,t,e),i=jo(r,$o(n)),o=new Xo({...n.tokenCredentialOptions,authorityHost:i,loggingOptions:n.loggingOptions});return{auth:{clientId:e,authority:i,knownAuthorities:Ko(r,i,n.disableInstanceDiscovery)},system:{networkClient:o,loggerOptions:{loggerCallback:zo(n.logger??rs),logLevel:Go((0,f.XM)()),piiLoggingEnabled:n.loggingOptions?.enableUnsafeSupportLogging}}}}n(77598),n(51455);A("ClientCertificateCredential"),A("ClientSecretCredential"),A("UsernamePasswordCredential");A("EnvironmentCredential");A("ManagedIdentityCredential - IMDS");const os=A("ClientAssertionCredential");class ss{msalClient;tenantId;additionallyAllowedTenantIds;getAssertion;options;constructor(e,t,r,i={}){if(!e)throw new u("ClientAssertionCredential: tenantId is a required parameter.");if(!t)throw new u("ClientAssertionCredential: clientId is a required parameter.");if(!r)throw new u("ClientAssertionCredential: clientAssertion is a required parameter.");var o;this.tenantId=e,this.additionallyAllowedTenantIds=(o=i?.additionallyAllowedTenants,o&&0!==o.length?o.includes("*")?a:o:[]),this.options=i,this.getAssertion=r,this.msalClient=function(e,t,r={}){const i={msalConfig:is(e,t,r),cachedAccount:r.authenticationRecord?(o=r.authenticationRecord,{localAccountId:o.homeAccountId,environment:o.authority,username:o.username,homeAccountId:o.homeAccountId,tenantId:o.tenantId}):null,pluginConfiguration:l(r),logger:r.logger??rs};var o;const s=new Map;async function a(e={}){const t=e.enableCae?"CAE":"default";let n=s.get(t);if(n)return i.logger.getToken.info("Existing PublicClientApplication found in cache, returning it."),n;i.logger.getToken.info(`Creating new PublicClientApplication with CAE ${e.enableCae?"enabled":"disabled"}.`);const r=e.enableCae?i.pluginConfiguration.cache.cachePluginCae:i.pluginConfiguration.cache.cachePlugin;return i.msalConfig.auth.clientCapabilities=e.enableCae?["cp1"]:void 0,n=new qo({...i.msalConfig,broker:{nativeBrokerPlugin:i.pluginConfiguration.broker.nativeBrokerPlugin},cache:{cachePlugin:await r}}),s.set(t,n),n}const c=new Map;async function u(e={}){const t=e.enableCae?"CAE":"default";let n=c.get(t);if(n)return i.logger.getToken.info("Existing ConfidentialClientApplication found in cache, returning it."),n;i.logger.getToken.info(`Creating new ConfidentialClientApplication with CAE ${e.enableCae?"enabled":"disabled"}.`);const r=e.enableCae?i.pluginConfiguration.cache.cachePluginCae:i.pluginConfiguration.cache.cachePlugin;return i.msalConfig.auth.clientCapabilities=e.enableCae?["cp1"]:void 0,n=new Ho({...i.msalConfig,broker:{nativeBrokerPlugin:i.pluginConfiguration.broker.nativeBrokerPlugin},cache:{cachePlugin:await r}}),c.set(t,n),n}function h(e){return e?.tenantId?jo(e.tenantId,$o(r)):i.msalConfig.auth.authority}async function d(e,t,n,r){let o=null;try{o=await async function(e,t,n={}){if(null===i.cachedAccount)throw i.logger.getToken.info("No cached account found in local state."),new g({scopes:t});n.claims&&(i.cachedClaims=n.claims);const r={account:i.cachedAccount,scopes:t,claims:i.cachedClaims};i.pluginConfiguration.broker.isEnabled&&(r.tokenQueryParameters||={},i.pluginConfiguration.broker.enableMsaPassthrough&&(r.tokenQueryParameters.msal_request_type="consumer_passthrough")),n.proofOfPossessionOptions&&(r.shrNonce=n.proofOfPossessionOptions.nonce,r.authenticationScheme="pop",r.resourceRequestMethod=n.proofOfPossessionOptions.resourceRequestMethod,r.resourceRequestUri=n.proofOfPossessionOptions.resourceRequestUrl),i.logger.getToken.info("Attempting to acquire token silently");try{return await e.acquireTokenSilent(r)}catch(e){throw Vo(t,e,n)}}(e,t,n)}catch(e){if("AuthenticationRequiredError"!==e.name)throw e;if(n.disableAutomaticAuthentication)throw new g({scopes:t,getTokenOptions:n,message:"Automatic authentication has been disabled. You may call the authentication() method."})}if(null===o)try{o=await r()}catch(e){throw Vo(t,e,n)}return Fo(t,o,n),i.cachedAccount=o?.account??null,i.logger.getToken.info(y(t)),{token:o.accessToken,expiresOnTimestamp:o.expiresOn.getTime(),refreshAfterTimestamp:o.refreshOn?.getTime(),tokenType:o.tokenType}}function p(e,t){return{openBrowser:async e=>{const t=await n.e(779).then(n.bind(n,84779));await t.default(e,{newInstance:!0})},scopes:e,authority:h(t),claims:t?.claims,loginHint:t?.loginHint,errorTemplate:t?.browserCustomizationOptions?.errorMessage,successTemplate:t?.browserCustomizationOptions?.successMessage,prompt:t?.loginHint?"login":"select_account"}}async function f(e,t,n={}){rs.verbose("Authentication will resume through the broker");const r=await a(n),o=p(e,n);i.pluginConfiguration.broker.parentWindowHandle?o.windowHandle=Buffer.from(i.pluginConfiguration.broker.parentWindowHandle):rs.warning("Parent window handle is not specified for the broker. This may cause unexpected behavior. Please provide the parentWindowHandle."),i.pluginConfiguration.broker.enableMsaPassthrough&&((o.tokenQueryParameters??={}).msal_request_type="consumer_passthrough"),t?(o.prompt="none",rs.verbose("Attempting broker authentication using the default broker account")):rs.verbose("Attempting broker authentication without the default broker account"),n.proofOfPossessionOptions&&(o.shrNonce=n.proofOfPossessionOptions.nonce,o.authenticationScheme="pop",o.resourceRequestMethod=n.proofOfPossessionOptions.resourceRequestMethod,o.resourceRequestUri=n.proofOfPossessionOptions.resourceRequestUrl);try{return await r.acquireTokenInteractive(o)}catch(r){if(rs.verbose(`Failed to authenticate through the broker: ${r.message}`),n.disableAutomaticAuthentication)throw new g({scopes:e,getTokenOptions:n,message:"Cannot silently authenticate with default broker account."});if(t)return f(e,!1,n);throw r}}return{getActiveAccount:function(){if(i.cachedAccount)return function(e,t){return{authority:t.environment??"login.microsoftonline.com",homeAccountId:t.homeAccountId,tenantId:t.tenantId||"common",username:t.username,clientId:e,version:"1.0"}}(e,i.cachedAccount)},getBrokeredToken:async function(e,t,n={}){rs.getToken.info(`Attempting to acquire token using brokered authentication with useDefaultBrokerAccount: ${t}`);const r=await f(e,t,n);return Fo(e,r,n),i.cachedAccount=r?.account??null,i.logger.getToken.info(y(e)),{token:r.accessToken,expiresOnTimestamp:r.expiresOn.getTime(),refreshAfterTimestamp:r.refreshOn?.getTime(),tokenType:r.tokenType}},getTokenByClientSecret:async function(e,t,n={}){i.logger.getToken.info("Attempting to acquire token using client secret"),i.msalConfig.auth.clientSecret=t;const r=await u(n);try{const t=await r.acquireTokenByClientCredential({scopes:e,authority:h(n),azureRegion:ts(),claims:n?.claims});return Fo(e,t,n),i.logger.getToken.info(y(e)),{token:t.accessToken,expiresOnTimestamp:t.expiresOn.getTime(),refreshAfterTimestamp:t.refreshOn?.getTime(),tokenType:t.tokenType}}catch(t){throw Vo(e,t,n)}},getTokenByClientAssertion:async function(e,t,n={}){i.logger.getToken.info("Attempting to acquire token using client assertion"),i.msalConfig.auth.clientAssertion=t;const r=await u(n);try{const o=await r.acquireTokenByClientCredential({scopes:e,authority:h(n),azureRegion:ts(),claims:n?.claims,clientAssertion:t});return Fo(e,o,n),i.logger.getToken.info(y(e)),{token:o.accessToken,expiresOnTimestamp:o.expiresOn.getTime(),refreshAfterTimestamp:o.refreshOn?.getTime(),tokenType:o.tokenType}}catch(t){throw Vo(e,t,n)}},getTokenByClientCertificate:async function(e,t,n={}){i.logger.getToken.info("Attempting to acquire token using client certificate"),i.msalConfig.auth.clientCertificate=t;const r=await u(n);try{const t=await r.acquireTokenByClientCredential({scopes:e,authority:h(n),azureRegion:ts(),claims:n?.claims});return Fo(e,t,n),i.logger.getToken.info(y(e)),{token:t.accessToken,expiresOnTimestamp:t.expiresOn.getTime(),refreshAfterTimestamp:t.refreshOn?.getTime(),tokenType:t.tokenType}}catch(t){throw Vo(e,t,n)}},getTokenByDeviceCode:async function(e,t,n={}){i.logger.getToken.info("Attempting to acquire token using device code");const r=await a(n);return d(r,e,n,()=>{const i={scopes:e,cancel:n?.abortSignal?.aborted??!1,deviceCodeCallback:t,authority:h(n),claims:n?.claims},o=r.acquireTokenByDeviceCode(i);return n.abortSignal&&n.abortSignal.addEventListener("abort",()=>{i.cancel=!0}),o})},getTokenByUsernamePassword:async function(e,t,n,r={}){i.logger.getToken.info("Attempting to acquire token using username and password");const o=await a(r);return d(o,e,r,()=>{const i={scopes:e,username:t,password:n,authority:h(r),claims:r?.claims};return o.acquireTokenByUsernamePassword(i)})},getTokenByAuthorizationCode:async function(e,t,n,r,o={}){let s;return i.logger.getToken.info("Attempting to acquire token using authorization code"),r?(i.msalConfig.auth.clientSecret=r,s=await u(o)):s=await a(o),d(s,e,o,()=>s.acquireTokenByCode({scopes:e,redirectUri:t,code:n,authority:h(o),claims:o?.claims}))},getTokenOnBehalfOf:async function(e,t,n,r={}){rs.getToken.info("Attempting to acquire token on behalf of another user"),"string"==typeof n?(rs.getToken.info("Using client secret for on behalf of flow"),i.msalConfig.auth.clientSecret=n):"function"==typeof n?(rs.getToken.info("Using client assertion callback for on behalf of flow"),i.msalConfig.auth.clientAssertion=n):(rs.getToken.info("Using client certificate for on behalf of flow"),i.msalConfig.auth.clientCertificate=n);const o=await u(r);try{const n=await o.acquireTokenOnBehalfOf({scopes:e,authority:h(r),claims:r.claims,oboAssertion:t});return Fo(e,n,r),rs.getToken.info(y(e)),{token:n.accessToken,expiresOnTimestamp:n.expiresOn.getTime(),refreshAfterTimestamp:n.refreshOn?.getTime(),tokenType:n.tokenType}}catch(t){throw Vo(e,t,r)}},getTokenByInteractiveRequest:async function(e,t={}){rs.getToken.info("Attempting to acquire token interactively");const n=await a(t);return d(n,e,t,async()=>{const r=p(e,t);return i.pluginConfiguration.broker.isEnabled?f(e,i.pluginConfiguration.broker.useDefaultBrokerAccount??!1,t):(t.proofOfPossessionOptions&&(r.shrNonce=t.proofOfPossessionOptions.nonce,r.authenticationScheme="pop",r.resourceRequestMethod=t.proofOfPossessionOptions.resourceRequestMethod,r.resourceRequestUri=t.proofOfPossessionOptions.resourceRequestUrl),n.acquireTokenInteractive(r))})}}}(t,e,{...i,logger:os,tokenCredentialOptions:this.options})}async getToken(e,t={}){return w.withSpan(`${this.constructor.name}.getToken`,t,async t=>{t.tenantId=function(e,t,n=[],r){let i;if(i=process.env.AZURE_IDENTITY_DISABLE_MULTITENANTAUTH||"adfs"===e?e:t?.tenantId??e,e&&i!==e&&!n.includes("*")&&!n.some(e=>0===e.localeCompare(i))){const e=function(e){return`The current credential is not configured to acquire tokens for tenant ${e}. To enable acquiring tokens for this tenant add it to the AdditionallyAllowedTenants on the credential options, or add "*" to AdditionallyAllowedTenants to allow acquiring tokens for any tenant.`}(i);throw r?.info(e),new u(e)}return i}(this.tenantId,t,this.additionallyAllowedTenantIds,os);const n=Array.isArray(e)?e:[e];return this.msalClient.getTokenByClientAssertion(n,this.getAssertion,t)})}}A("WorkloadIdentityCredential");A("ManagedIdentityCredential - Token Exchange"),A("ManagedIdentityCredential"),n(35317),A("AzureDeveloperCliCredential"),A("AzureCliCredential"),n(31421),A("AzurePowerShellCredential");const as="win32"===process.platform;function cs(e){return as?`${e}.exe`:e}const ls=[cs("pwsh")];as&&ls.push(cs("powershell")),A("VisualStudioCodeCredential"),A("BrokerCredential"),A("DefaultAzureCredential"),A("InteractiveBrowserCredential"),A("DeviceCodeCredential");A("AzurePipelinesCredential"),A("AuthorizationCodeCredential");A("OnBehalfOfCredential")},67083(e){var t=1/0,n=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,i=/^0b[01]+$/i,o=/^0o[0-7]+$/i,s=parseInt,a=Object.prototype.toString;function c(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}e.exports=function(e){return function(e,l){var u;if("function"!=typeof l)throw new TypeError("Expected a function");return e=function(e){var l=function(e){return e?(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==a.call(e)}(e))return NaN;if(c(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=c(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(n,"");var l=i.test(e);return l||o.test(e)?s(e.slice(2),l?2:8):r.test(e)?NaN:+e}(e))===t||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),u=l%1;return l==l?u?l-u:l:0}(e),function(){return--e>0&&(u=l.apply(this,arguments)),e<=1&&(l=void 0),u}}(2,e)}},73639(e){var t=Object.prototype.toString;e.exports=function(e){return"number"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Number]"==t.call(e)}},74977(e,t,n){var r=n(99589);e.exports=r.satisfies(process.version,"^6.12.0 || >=8.0.0")},79001(e){var t,n,r=Function.prototype,i=Object.prototype,o=r.toString,s=i.hasOwnProperty,a=o.call(Object),c=i.toString,l=(t=Object.getPrototypeOf,n=Object,function(e){return t(n(e))});e.exports=function(e){if(!function(e){return!!e&&"object"==typeof e}(e)||"[object Object]"!=c.call(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e))return!1;var t=l(e);if(null===t)return!0;var n=s.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&o.call(n)==a}},81741(e){var t=function(e,t){Error.call(this,e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="JsonWebTokenError",this.message=e,t&&(this.inner=t)};(t.prototype=Object.create(Error.prototype)).constructor=t,e.exports=t},82851(e,t,n){var r=n(20181).Buffer;e.exports=function(e){return"string"==typeof e?e:"number"==typeof e||r.isBuffer(e)?e.toString():JSON.stringify(e)}},87914(e){var t=Object.prototype.toString;e.exports=function(e){return!0===e||!1===e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Boolean]"==t.call(e)}},91691(e,t,n){const r=n(81741),i=n(13726),o=n(18980),s=n(37260),a=n(40855),c=n(47019),l=n(74977),u=n(25747),{KeyObject:h,createSecretKey:d,createPublicKey:p}=n(76982),g=["RS256","RS384","RS512"],f=["ES256","ES384","ES512"],m=["RS256","RS384","RS512"],y=["HS256","HS384","HS512"];l&&(g.splice(g.length,0,"PS256","PS384","PS512"),m.splice(m.length,0,"PS256","PS384","PS512")),e.exports=function(e,t,n,l){let C;if("function"!=typeof n||l||(l=n,n={}),n||(n={}),n=Object.assign({},n),C=l||function(e,t){if(e)throw e;return t},n.clockTimestamp&&"number"!=typeof n.clockTimestamp)return C(new r("clockTimestamp must be a number"));if(void 0!==n.nonce&&("string"!=typeof n.nonce||""===n.nonce.trim()))return C(new r("nonce must be a non-empty string"));if(void 0!==n.allowInvalidAsymmetricKeyTypes&&"boolean"!=typeof n.allowInvalidAsymmetricKeyTypes)return C(new r("allowInvalidAsymmetricKeyTypes must be a boolean"));const T=n.clockTimestamp||Math.floor(Date.now()/1e3);if(!e)return C(new r("jwt must be provided"));if("string"!=typeof e)return C(new r("jwt must be a string"));const A=e.split(".");if(3!==A.length)return C(new r("jwt malformed"));let w;try{w=s(e,{complete:!0})}catch(e){return C(e)}if(!w)return C(new r("invalid token"));const k=w.header;let I;if("function"==typeof t){if(!l)return C(new r("verify must be called asynchronous if secret or public key is provided as a callback"));I=t}else I=function(e,n){return n(null,t)};return I(k,function(t,s){if(t)return C(new r("error in secret or public key callback: "+t.message));const l=""!==A[2].trim();if(!l&&s)return C(new r("jwt signature is required"));if(l&&!s)return C(new r("secret or public key must be provided"));if(!l&&!n.algorithms)return C(new r('please specify "none" in "algorithms" to verify unsigned tokens'));if(null!=s&&!(s instanceof h))try{s=p(s)}catch(e){try{s=d("string"==typeof s?Buffer.from(s):s)}catch(e){return C(new r("secretOrPublicKey is not valid key material"))}}if(n.algorithms||("secret"===s.type?n.algorithms=y:["rsa","rsa-pss"].includes(s.asymmetricKeyType)?n.algorithms=m:"ec"===s.asymmetricKeyType?n.algorithms=f:n.algorithms=g),-1===n.algorithms.indexOf(w.header.alg))return C(new r("invalid algorithm"));if(k.alg.startsWith("HS")&&"secret"!==s.type)return C(new r(`secretOrPublicKey must be a symmetric key when using ${k.alg}`));if(/^(?:RS|PS|ES)/.test(k.alg)&&"public"!==s.type)return C(new r(`secretOrPublicKey must be an asymmetric key when using ${k.alg}`));if(!n.allowInvalidAsymmetricKeyTypes)try{c(k.alg,s)}catch(e){return C(e)}let I;try{I=u.verify(e,w.header.alg,s)}catch(e){return C(e)}if(!I)return C(new r("invalid signature"));const v=w.payload;if(void 0!==v.nbf&&!n.ignoreNotBefore){if("number"!=typeof v.nbf)return C(new r("invalid nbf value"));if(v.nbf>T+(n.clockTolerance||0))return C(new i("jwt not active",new Date(1e3*v.nbf)))}if(void 0!==v.exp&&!n.ignoreExpiration){if("number"!=typeof v.exp)return C(new r("invalid exp value"));if(T>=v.exp+(n.clockTolerance||0))return C(new o("jwt expired",new Date(1e3*v.exp)))}if(n.audience){const e=Array.isArray(n.audience)?n.audience:[n.audience];if(!(Array.isArray(v.aud)?v.aud:[v.aud]).some(function(t){return e.some(function(e){return e instanceof RegExp?e.test(t):e===t})}))return C(new r("jwt audience invalid. expected: "+e.join(" or ")))}if(n.issuer&&("string"==typeof n.issuer&&v.iss!==n.issuer||Array.isArray(n.issuer)&&-1===n.issuer.indexOf(v.iss)))return C(new r("jwt issuer invalid. expected: "+n.issuer));if(n.subject&&v.sub!==n.subject)return C(new r("jwt subject invalid. expected: "+n.subject));if(n.jwtid&&v.jti!==n.jwtid)return C(new r("jwt jwtid invalid. expected: "+n.jwtid));if(n.nonce&&v.nonce!==n.nonce)return C(new r("jwt nonce invalid. expected: "+n.nonce));if(n.maxAge){if("number"!=typeof v.iat)return C(new r("iat required when maxAge is specified"));const e=a(n.maxAge,v.iat);if(void 0===e)return C(new r('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(T>=e+(n.clockTolerance||0))return C(new o("maxAge exceeded",new Date(1e3*e)))}if(!0===n.complete){const e=w.signature;return C(null,{header:k,payload:v,signature:e})}return C(null,v)})}},92861(e,t,n){var r=n(20181),i=r.Buffer;function o(e,t){for(var n in e)t[n]=e[n]}function s(e,t,n){return i(e,t,n)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=r:(o(r,t),t.Buffer=s),s.prototype=Object.create(i.prototype),o(i,s),s.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,n)},s.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var r=i(e);return void 0!==t?"string"==typeof n?r.fill(t,n):r.fill(t):r.fill(0),r},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r.SlowBuffer(e)}}};
//# sourceMappingURL=823.extension.js.map